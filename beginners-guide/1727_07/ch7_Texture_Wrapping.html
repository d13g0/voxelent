<html>

<head>
<title>WebGL Beginner's Guide - Chapter 7 - Texture Wrapping</title>
<meta http-equiv='content-type' content='text/html; charset=ISO-8859-1'>

<!-- CSS Styles //-->
<link href='css/styles.css'   type='text/css' rel='stylesheet'>
<link href='css/prettify_desert.css'  type='text/css' rel='stylesheet'/>
<link href='css/colorpicker.css'  type='text/css' rel='stylesheet'/>

<link href='css/smoothness/jquery-ui-1.8.13.custom.css' type='text/css' rel='stylesheet' />
<!-- GUI Libraries //-->
<script type='text/javascript' src='js/gui/jquery-1.5.1.min.js'></script>
<script type='text/javascript' src='js/gui/jquery-ui-1.8.13.custom.min.js'></script> 
<script type='text/javascript' src='js/gui/colorpicker.js'></script>
<script type='text/javascript' src='js/gui/prettify.js'></script>
<script type='text/javascript' src='js/gui/codeview.js'></script>
<!-- MATH Libraries //-->
<script type='text/javascript' src='js/math/gl-matrix-min.js'></script>
<!-- WEBGL Libraries //-->
<script type='text/javascript' src='js/webgl/Globals.js'></script>
<script type='text/javascript' src='js/webgl/Utils.js'></script>
<script type='text/javascript' src='js/webgl/Program.js'></script>
<script type='text/javascript' src='js/webgl/Scene.js'></script>
<script type='text/javascript' src='js/webgl/Axis.js'></script>
<script type='text/javascript' src='js/webgl/Floor.js'></script>
<script type='text/javascript' src='js/webgl/Camera.js'></script>
<script type='text/javascript' src='js/webgl/CameraInteractor.js'></script>
<script type='text/javascript' src='js/webgl/SceneTransforms.js'></script>
<script type='text/javascript' src='js/webgl/Texture.js'></script>
<script type='text/javascript' src='js/webgl/WebGLApp.js'></script>



<script id="shader-vs" type="x-shader/x-vertex">
//geometry
attribute vec3 aVertexPosition;
attribute vec2 aVertexTextureCoords;

//matrices
uniform mat4 uMVMatrix;
uniform mat4 uPMatrix;
uniform mat4 uNMatrix;

//varyings
varying vec2 vTextureCoord;

void main(void) {
	//Final vertex position
	gl_Position = uPMatrix * uMVMatrix * vec4(aVertexPosition, 1.0);
	vTextureCoord = (aVertexTextureCoords * 3.0) - vec2(1.0, 1.0); // Multiplied by 3 to force the texture to wrap, subtract 1 to center the texture
}	
</script>

<script id="shader-fs" type="x-shader/x-fragment">
#ifdef GL_ES
precision highp float;
#endif

//sampler
uniform sampler2D uSampler;

//varying
varying vec2 vTextureCoord;

void main(void)
{	
	gl_FragColor = texture2D(uSampler, vTextureCoord);
}
</script>

<script id='code-js' type="text/javascript">

var camera = null;
var interactor = null;
var transforms = null;
var useVertexColors = false;
var texture = null;

function configure(){
    gl.clearColor(0.3,0.3,0.3, 1.0);
    gl.clearDepth(100.0);
    gl.enable(gl.DEPTH_TEST);
	gl.depthFunc(gl.LESS);
    gl.pixelStorei(gl.UNPACK_FLIP_Y_WEBGL, true);

    //Creates and sets up the camera location
    camera = new Camera(CAMERA_ORBITING_TYPE);
    camera.goHome([0,0,3]);
    camera.setFocus([0.0,0.0,0.0]);
	camera.setAzimuth(45);
	camera.setElevation(-30);
    camera.hookRenderer = draw;
    
    //Creates and sets up the mouse and keyboard interactor
    interactor = new CameraInteractor(camera, document.getElementById('canvas-element-id'));
    
    //Scene Transforms
    transforms = new SceneTransforms(camera);
   
    //init transforms
    transforms.init();
	
	//Program
	attributeList = ["aVertexPosition",
					"aVertexNormal",
					"aVertexColor",
					"aVertexTextureCoords"];

	uniformList = [	"uPMatrix", 
					"uMVMatrix", 
					"uNMatrix",
					"uMaterialDiffuse",
					"uMaterialAmbient",
					"uLightAmbient",
					"uLightDiffuse",
					"uLightPosition",
					"uWireframe",
					"uAlpha",
					"uUseVertexColor",
					"uUseLambert",
					"uSampler"
					];
	
	
	Program.load(attributeList, uniformList);
	
	gl.uniform3fv(Program.uLightPosition,   [0,5,20]);
	gl.uniform3fv(Program.uLightAmbient,    [1.0,1.0,1.0,1.0]);
	gl.uniform4fv(Program.uLightDiffuse,    [1.0,1.0,1.0,1.0]);
	gl.uniform1f(Program.uAlpha, 1.0);
	gl.uniform1i(Program.uUseVertexColor, useVertexColors);
	gl.uniform1i(Program.uUseLambert, true);
	
	//Init texture
	texture = new Texture();
	texture.setImage('textures/webgl-marble.png');
}

/**
* Loads the scene
*/
function load(){
	Scene.loadObject('models/geometry/complexCube.json','cube2');
}

/**
* invoked on every rendering cycle
*/
function draw() {
    gl.viewport(0, 0, c_width, c_height);
    gl.clear(gl.COLOR_BUFFER_BIT | gl.DEPTH_BUFFER_BIT);
    transforms.updatePerspective();

    try{
        for (var i = 0; i < Scene.objects.length; i++){
            
            var object = Scene.objects[i];
			
			if (object.hidden == true) continue;
			
			transforms.calculateModelView();           
            transforms.push();
            transforms.setMatrixUniforms();
            transforms.pop();
   
            //Setting uniforms
            gl.uniform4fv(Program.uMaterialDiffuse, object.diffuse);
            gl.uniform4fv(Program.uMaterialAmbient, object.ambient);
            gl.uniform1i(Program.uWireframe,object.wireframe);
			
            
            //Setting attributes
            gl.enableVertexAttribArray(Program.aVertexPosition);
            gl.disableVertexAttribArray(Program.aVertexNormal);
            gl.disableVertexAttribArray(Program.aVertexColor);
            
            gl.bindBuffer(gl.ARRAY_BUFFER, object.vbo);
            gl.vertexAttribPointer(Program.aVertexPosition, 3, gl.FLOAT, false, 0, 0);
            gl.enableVertexAttribArray(Program.aVertexPosition);
			
			gl.uniform1i(Program.uUseVertexColor, useVertexColors);
			
			if (object.scalars != null && useVertexColors){
			    gl.enableVertexAttribArray(Program.aVertexColor);
				gl.bindBuffer(gl.ARRAY_BUFFER, object.cbo);
				gl.vertexAttribPointer(Program.aVertexColor, 4, gl.FLOAT, false, 0, 0);
				
			}
			
			if (object.texture_coords){
				gl.enableVertexAttribArray(Program.aVertexTextureCoords);
				gl.bindBuffer(gl.ARRAY_BUFFER, object.tbo);
				gl.vertexAttribPointer(Program.aVertexTextureCoords, 2, gl.FLOAT, false, 0, 0);
				gl.activeTexture(gl.TEXTURE0);
				gl.bindTexture(gl.TEXTURE_2D, texture.tex);
				gl.uniform1i(Program.uSampler, 0);
			}
			
            
			if(!object.wireframe){
				gl.bindBuffer(gl.ARRAY_BUFFER, object.nbo);
				gl.vertexAttribPointer(Program.aVertexNormal, 3, gl.FLOAT, false, 0, 0);
				gl.enableVertexAttribArray(Program.aVertexNormal);
            }
			gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER, object.ibo);
			
			if (object.wireframe){
                gl.drawElements(gl.LINES, object.indices.length, gl.UNSIGNED_SHORT,0);
            }
            else{
                gl.drawElements(gl.TRIANGLES, object.indices.length, gl.UNSIGNED_SHORT,0);
            }
			
            gl.bindBuffer(gl.ARRAY_BUFFER, null);
            gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER, null);
            
        }
    }
    catch(err){
        alert(err);
        console.error(err.description);
    }
}

/**
* Entry point. This function is invoked when the page is loaded
*/
var app = null;
function runWebGLApp() {
    app = new WebGLApp("canvas-element-id")
    app.configureGLHook = configure;
    app.loadSceneHook   = load;
    app.drawSceneHook   = draw;
    app.run();
}
</script>
</head>

<body onLoad='runWebGLApp()'>
<div id='top'>
<h1>WebGL Beginner's Guide - Chapter 7</h1>
<h2>Texture Wrapping</h2>
<div id='logo-packt'><img src='packt.gif'/></div>
<p></p>
</div>

<div id='contents'>
<div id='canvasContainer'>
<canvas id='canvas-element-id' width='480' height='400'>
Your browser does not support the HTML5 canvas element.
</canvas>
</div>
</div>

<div id='bottom'>
<table style='padding=0px'>
<tr>
    <td> 
    <table cellspacing=4px style='vertical-align:top'>
        <tr>
			<td>Wrap S:</td>
            <td>
            <div id='opt-s-wrap' align='center'>
            	<input type='radio' id='s-clamp-to-edge' name='s-wrap' /><label for='s-clamp-to-edge'>CLAMP_TO_EDGE</label>
				<input type='radio' id='s-repeat' name='s-wrap' checked='checked'/><label for='s-repeat'>REPEAT</label>
				<input type='radio' id='s-mirrored-repeat' name='s-wrap' /><label for='s-mirrored-repeat'>MIRRORED_REPEAT</label>
            </div>
            </td>
        </tr>
    </table>
    </td>
</tr>
<tr>
    <td> 
    <table cellspacing=4px style='vertical-align:top'>
        <tr>
			<td>Wrap T:</td>
            <td>
            <div id='opt-t-wrap' align='center'>
            	<input type='radio' id='t-clamp-to-edge' name='t-wrap' /><label for='t-clamp-to-edge'>CLAMP_TO_EDGE</label>
				<input type='radio' id='t-repeat' name='t-wrap' checked='checked'/><label for='t-repeat'>REPEAT</label>
				<input type='radio' id='t-mirrored-repeat' name='t-wrap' /><label for='t-mirrored-repeat'>MIRRORED_REPEAT</label>
            </div>
            </td>
        </tr>
    </table>
    </td>
</tr>
</table>
</div>
<script> 

$('#opt-s-wrap').buttonset();
$('#opt-t-wrap').buttonset();

$('#s-clamp-to-edge').click(function(){
	gl.bindTexture(gl.TEXTURE_2D, texture.tex);
    gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_S, gl.CLAMP_TO_EDGE);
	gl.bindTexture(gl.TEXTURE_2D, null);
});

$('#s-repeat').click(function(){
	gl.bindTexture(gl.TEXTURE_2D, texture.tex);
    gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_S, gl.REPEAT);
	gl.bindTexture(gl.TEXTURE_2D, null);
});

$('#s-mirrored-repeat').click(function(){
	gl.bindTexture(gl.TEXTURE_2D, texture.tex);
    gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_S, gl.MIRRORED_REPEAT);
	gl.bindTexture(gl.TEXTURE_2D, null);
});



$('#t-clamp-to-edge').click(function(){
	gl.bindTexture(gl.TEXTURE_2D, texture.tex);
    gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_T, gl.CLAMP_TO_EDGE);
	gl.bindTexture(gl.TEXTURE_2D, null);
});

$('#t-repeat').click(function(){
	gl.bindTexture(gl.TEXTURE_2D, texture.tex);
    gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_T, gl.REPEAT);
	gl.bindTexture(gl.TEXTURE_2D, null);
});

$('#t-mirrored-repeat').click(function(){
	gl.bindTexture(gl.TEXTURE_2D, texture.tex);
    gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_T, gl.MIRRORED_REPEAT);
	gl.bindTexture(gl.TEXTURE_2D, null);
});


</script>
<script>cview.run(cview.MODE_VIEW,false,470);</script>
</body>
</html>