try{if(!jQuery){alert("Voxelent: jQuery is not loaded. Please include JQuery in your page")}}catch(e){alert("Voxelent: jQuery is not loaded. Please include JQuery in your page")}var vxl={version:{number:"0.89.1",codename:"c4n314",plugins:[]},def:{piOver2:Math.PI/2,deg2rad:Math.PI/180,rad2deg:180/Math.PI,glsl:{VERTEX_SHADER:"VERTEX_SHADER",FRAGMENT_SHADER:"FRAGMENT_SHADER",MODEL_VIEW_MATRIX:"mModelView",NORMAL_MATRIX:"mNormal",PERSPECTIVE_MATRIX:"mPerspective",MVP_MATRIX:"mModelViewPerspective",VERTEX_ATTRIBUTE:"aVertexPosition",NORMAL_ATTRIBUTE:"aVertexNormal",COLOR_ATTRIBUTE:"aVertexColor",TEXCOORD_ATTRIBUTE:"aVertexTextureCoords",PICKING_COLOR_ATTRIBUTE:"aVertexPickingColor"},lut:{list:["default","aal","autumn","blackbody","bone","brodmann","cardiac","copper","cortex","cte","french","fs","ge_color","gold","gooch","hot","hotiron","hsv","jet","nih","nih_fire","nih_ice","pink","rainramp","spectrum","surface","x_hot","x_rain"],main:"default"},model:{diffuse:[0.8,0.8,0.8,1],loadingMode:{LIVE:"LIVE",LATER:"LATER",DETACHED:"DETACHED"}},view:{background:[135/256,135/256,135/256]},interactor:{task:{NONE:0,PAN:1,ROTATE:2,DOLLY:3,ROLL:4}},actor:{mode:{TEXTURED:"TEXTURED",SOLID:"SOLID",WIREFRAME:"WIREFRAME",POINTS:"POINTS",LINES:"LINES",BOUNDING_BOX:"BOUNDING_BOX",BB_AND_SOLID:"BBANDSOLID",WIRED_AND_SOLID:"WIRED_AND_SOLID",FLAT:"FLAT",},cull:{BACK:"BACK",FRONT:"FRONT",NONE:"NONE"},picking:{DISABLED:"DISABLED",CELL:"CELL",OBJECT:"OBJECT"}},camera:{type:{ORBITING:"ORBITING",TRACKING:"TRACKING"},right:[1,0,0],up:[0,1,0],normal:[0,0,1],fov:30,near:0.1,far:10000,tracking:{DEFAULT:"DEFAULT",ROTATIONAL:"ROTATIONAL",TRANSLATIONAL:"TRANSLATIONAL",CINEMATIC:"CINEMATIC"}},renderer:{mode:{TIMER:"TIMER",ANIMFRAME:"ANIFRAME"},rate:{SLOW:10000,NORMAL:500}},texture:{filter:{NEAREST:"NEAREST",LINEAR:"LINEAR",NEAREST_MIPMAP_NEAREST:"NEAREST_MIPMAP_NEAREST",LINEAR_MIPMAP_NEAREST:"LINEAR_MIPMAP_NEAREST",NEAREST_MIPMAP_LINEAR:"NEAREST_MIPMAP_LINEAR",LINEAR_MIPMAP_LINEAR:"LINEAR_MIPMAP_LINEAR"}}},events:{DEFAULT_LUT_LOADED:"vxl.events.DEFAULT_LUT_LOADED",SCENE_UPDATED:"vxl.events.SCENE_UPDATED",MODELS_LOADING:"vxl.events.MODELS_LOADING",MODEL_NEW:"vxl.events.MODEL_NEW",MODELS_LOADED:"vxl.events.MODELS_LOADED",ACTOR_MOVED:"vxl.events.ACTOR_MOVED",ACTOR_SCALED:"vxl.events.ACTOR_SCALED",ACTOR_ROTATED:"vxl.events.ACTOR_ROTATED",ACTOR_CHANGED_COLOR:"vxl.events.ACTOR_CHANGED_COLOR",ACTOR_CHANGED_SHADING:"vxl.events.ACTOR_CHANGED_SHADING",VIEW_NEW:"vxl.events.VIEW_NEW",SCENE_NEW:"vxl.events.SCENE_NEW",READER_DONE:"vxl.events.READER_DONE"},go:{debug:false,notifier:undefined,modelManager:undefined,lookupTableManager:undefined,views:[],scenes:[],renderman:{_timid:0,_rates:[],_stop:false,render:function(){for(var a=0;
a<vxl.go.views.length;a+=1){vxl.go.views[a].renderer.render()}if(vxl.go.renderman._stop!=true){vxl.go.renderman._timid=window.requestAnimFrame(vxl.go.renderman.render)}else{vxl.go.renderman._stop=false}},cancel:function(){vxl.go.renderman._stop=true},slow:function(){},normal:function(){}},console:function(a,b){if(this.debug==true||b){console.info(a)}}},c:{scene:undefined,view:undefined,camera:undefined,actor:undefined,animation:undefined},util:{int2rgb:function(a){return[((a>>16)&255)/256,((a>>8)&255)/256,(a&255)/256]
},format:function(b,d){var f=Math.pow(10,d);if(typeof(b)=="object"){var a="[";for(var c=0;c<b.length-1;c+=1){a+=Math.round(b[c]*f)/f+", "}a+=Math.round(b[b.length-1]*f)/f+"]"}else{if(typeof(b)=="number"){a="["+Math.round(b*f)/f+"]"}}return a},createVec3:function(a,d,c){var b=vec3.create();if(a instanceof Array){vec3.set(vec3.create(a),b)}else{if(a instanceof determineMatrixArrayType()){vec3.set(a,b)}else{vec3.set(vec3.createFrom(a,d,c),b)}}return b},createArr3:function(a,d,c){var b=[];if(a instanceof Array||a instanceof determineMatrixArrayType()){b[0]=a[0];
b[1]=a[1];b[2]=a[2]}else{b[0]=a;b[1]=d;b[2]=c}return b},generateUID:function(){function a(){return(((1+Math.random())*65536)|0).toString(16).substring(1)}return(a()+"-"+a()+"-"+a()+"-"+a())},extend:function(){var b={};var a=arguments.length;for(var c=0;c<a;c++){for(p in arguments[c]){if(arguments[c].hasOwnProperty(p)){b[p]=arguments[c][p]}}}return b},getPath:function(a){if(a==undefined||a==null){return""}else{if(a.length-1==a.lastIndexOf("/")){return a}else{if(a.lastIndexOf(".")>a.lastIndexOf("/")){return a.substring(0,a.lastIndexOf("/")+1)
}else{return a+"/"}}}},getAngle:function(a){if(a>360||a<-360){return a%360}else{return a}},deg2rad:function(a){return a*Math.PI/180}}};Array.prototype.max=function(){return Math.max.apply(null,this)};Array.prototype.min=function(){return Math.min.apply(null,this)};Array.prototype.hasObject=(!Array.indexOf?function(b){var a=this.length+1;while(a-=1){if(this[a-1]===b){return true}}return false}:function(a){return(this.indexOf(a)!==-1)});window.requestAnimFrame=(function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(b,a){return window.setTimeout(b,1000/60)
}})();window.cancelRequestAnimFrame=(function(){return window.cancelAnimationFrame||window.webkitCancelRequestAnimationFrame||window.mozCancelRequestAnimationFrame||window.oCancelRequestAnimationFrame||window.msCancelRequestAnimationFrame||clearTimeout})();function vxlNotifier(){this.targetList={};this.sourceList={}}vxlNotifier.prototype.subscribe=function(c,b){if(typeof(c)=="string"){this._addTarget(c,b)}else{if(c instanceof Array){for(var a=0;a<c.length;a+=1){this._addTarget(c[a],b)}}else{throw"vxlNotifier.receives: this method receives a string or a list of strings"}}};vxlNotifier.prototype.publish=function(c,b){if(typeof(c)=="string"){this._addSource(c,b)}else{if(c instanceof Array){for(var a=0;a<c.length;a+=1){this._addSource(c[a],b)}}else{throw"vxlNotifier.sends: this method receives a string or a list of strings"
}}};vxlNotifier.prototype._addTarget=function(a,b){vxl.go.console("vxlNotifier: adding target for event "+a);var c=this.targetList;if(c[a]==undefined){c[a]=[]}c[a].push(b)};vxlNotifier.prototype._addSource=function(b,d){vxl.go.console("vxlNotifier: adding source for event "+b);var c=this.targetList;var a=this.sourceList;if(a[b]==undefined){a[b]=[]}if(c[b]==undefined){c[b]=[]}a[b].push(d)};vxlNotifier.prototype.fire=function(c,d){var a=this;function b(){var h=a.targetList;var e=a.sourceList[c].indexOf(d);
if(e==-1){throw"The source "+d+" is not registered to trigger the event "+c+". Did you use vxlNotifier.publish?"}vxl.go.console("vxlNotifier: firing "+c);var f=a.targetList[c];for(var g=0;g<f.length;g++){f[g].handleEvent(c,d)}}setTimeout(function(){b()},0)};vxlNotifier.prototype.getEvents=function(){var b=[];for(var a in this.sourceList){b.push(a)}return b};vxlNotifier.prototype.getTargetsFor=function(c){var a=this.targetList[c];var d=[];for(var b=0;b<a.length;b++){d.push(a[b])}return d};vxl.go.notifier=new vxlNotifier();(function(a,b){if(typeof exports==="object"){module.exports=b(global)}else{if(typeof define==="function"&&define.amd){define([],function(){return b(a)})}else{b(a)}}}(this,function(n){var m={};(function(){if(typeof(Float32Array)!="undefined"){var t=new Float32Array(1);var s=new Int32Array(t.buffer);m.invsqrt=function(x){var w=x*0.5;t[0]=x;var v=1.5;s[0]=1597463007-(s[0]>>1);var u=t[0];return u*(v-(w*u*u))}}else{m.invsqrt=function(u){return 1/Math.sqrt(u)}}})();var b=null;function r(s){b=s;return b
}function l(){b=(typeof Float32Array!=="undefined")?Float32Array:Array;return b}l();var c={};c.create=function(t){var s=new b(3);if(t){s[0]=t[0];s[1]=t[1];s[2]=t[2]}else{s[0]=s[1]=s[2]=0}return s};c.createFrom=function(s,v,u){var t=new b(3);t[0]=s;t[1]=v;t[2]=u;return t};c.set=function(t,s){s[0]=t[0];s[1]=t[1];s[2]=t[2];return s};c.add=function(t,u,s){if(!s||t===s){t[0]+=u[0];t[1]+=u[1];t[2]+=u[2];return t}s[0]=t[0]+u[0];s[1]=t[1]+u[1];s[2]=t[2]+u[2];return s};c.subtract=function(t,u,s){if(!s||t===s){t[0]-=u[0];
t[1]-=u[1];t[2]-=u[2];return t}s[0]=t[0]-u[0];s[1]=t[1]-u[1];s[2]=t[2]-u[2];return s};c.multiply=function(t,u,s){if(!s||t===s){t[0]*=u[0];t[1]*=u[1];t[2]*=u[2];return t}s[0]=t[0]*u[0];s[1]=t[1]*u[1];s[2]=t[2]*u[2];return s};c.negate=function(t,s){if(!s){s=t}s[0]=-t[0];s[1]=-t[1];s[2]=-t[2];return s};c.scale=function(t,u,s){if(!s||t===s){t[0]*=u;t[1]*=u;t[2]*=u;return t}s[0]=t[0]*u;s[1]=t[1]*u;s[2]=t[2]*u;return s};c.normalize=function(v,u){if(!u){u=v}var t=v[0],A=v[1],w=v[2],s=Math.sqrt(t*t+A*A+w*w);
if(!s){u[0]=0;u[1]=0;u[2]=0;return u}else{if(s===1){u[0]=t;u[1]=A;u[2]=w;return u}}s=1/s;u[0]=t*s;u[1]=A*s;u[2]=w*s;return u};c.cross=function(t,v,D){if(!D){D=t}var C=t[0],A=t[1],w=t[2],s=v[0],B=v[1],u=v[2];D[0]=A*u-w*B;D[1]=w*s-C*u;D[2]=C*B-A*s;return D};c.length=function(t){var s=t[0],v=t[1],u=t[2];return Math.sqrt(s*s+v*v+u*u)};c.dot=function(s,t){return s[0]*t[0]+s[1]*t[1]+s[2]*t[2]};c.direction=function(v,w,u){if(!u){u=v}var t=v[0]-w[0],B=v[1]-w[1],A=v[2]-w[2],s=Math.sqrt(t*t+B*B+A*A);if(!s){u[0]=0;
u[1]=0;u[2]=0;return u}s=1/s;u[0]=t*s;u[1]=B*s;u[2]=A*s;return u};c.lerp=function(u,v,t,s){if(!s){s=u}s[0]=u[0]+t*(v[0]-u[0]);s[1]=u[1]+t*(v[1]-u[1]);s[2]=u[2]+t*(v[2]-u[2]);return s};c.dist=function(t,u){var s=u[0]-t[0],w=u[1]-t[1],v=u[2]-t[2];return Math.sqrt(s*s+w*w+v*v)};var o=null;var k=new b(4);c.unproject=function(y,u,z,t,x){if(!x){x=y}if(!o){o=g.create()}var s=o;var w=k;w[0]=(y[0]-t[0])*2/t[2]-1;w[1]=(y[1]-t[1])*2/t[3]-1;w[2]=2*y[2]-1;w[3]=1;g.multiply(z,u,s);if(!g.inverse(s)){return null
}g.multiplyVec4(s,w);if(w[3]===0){return null}x[0]=w[0]/w[3];x[1]=w[1]/w[3];x[2]=w[2]/w[3];return x};var q=c.createFrom(1,0,0);var p=c.createFrom(0,1,0);var f=c.createFrom(0,0,1);c.rotationTo=function(u,t,w){if(!w){w=e.create()}var z=c.dot(u,t);var y=c.create();if(z>=1){e.set(j,w)}else{if(z<(0.000001-1)){c.cross(q,u,y);if(y.length<0.000001){c.cross(p,u,y)}if(y.length<0.000001){c.cross(f,u,y)}c.normalize(y);e.fromAxisAngle(y,Math.PI,w)}else{var x=Math.sqrt((1+z)*2);var v=1/x;c.cross(u,t,y);w[0]=y[0]*v;
w[1]=y[1]*v;w[2]=y[2]*v;w[3]=x*0.5;e.normalize(w)}}if(w[3]>1){w[3]=1}else{if(w[3]<-1){w[3]=-1}}return w};c.str=function(s){return"["+s[0]+", "+s[1]+", "+s[2]+"]"};var h={};h.create=function(t){var s=new b(9);if(t){s[0]=t[0];s[1]=t[1];s[2]=t[2];s[3]=t[3];s[4]=t[4];s[5]=t[5];s[6]=t[6];s[7]=t[7];s[8]=t[8]}else{s[0]=s[1]=s[2]=s[3]=s[4]=s[5]=s[6]=s[7]=s[8]=0}return s};h.createFrom=function(B,A,z,x,w,v,u,t,s){var y=new b(9);y[0]=B;y[1]=A;y[2]=z;y[3]=x;y[4]=w;y[5]=v;y[6]=u;y[7]=t;y[8]=s;return y};h.determinant=function(z){var u=z[0],t=z[1],s=z[2],B=z[3],A=z[4],y=z[5],x=z[6],w=z[7],v=z[8];
return u*(v*A-y*w)+t*(-v*B+y*x)+s*(w*B-A*x)};h.inverse=function(F,D){var w=F[0],v=F[1],u=F[2],H=F[3],G=F[4],E=F[5],A=F[6],z=F[7],y=F[8],x=y*G-E*z,t=-y*H+E*A,C=z*H-G*A,B=w*x+v*t+u*C,s;if(!B){return null}s=1/B;if(!D){D=h.create()}D[0]=x*s;D[1]=(-y*v+u*z)*s;D[2]=(E*v-u*G)*s;D[3]=t*s;D[4]=(y*w-u*A)*s;D[5]=(-E*w+u*H)*s;D[6]=C*s;D[7]=(-z*w+v*A)*s;D[8]=(G*w-v*H)*s;return D};h.multiply=function(H,y,z){if(!z){z=H}var M=H[0],L=H[1],K=H[2],x=H[3],w=H[4],v=H[5],F=H[6],E=H[7],D=H[8],C=y[0],B=y[1],A=y[2],J=y[3],I=y[4],G=y[5],u=y[6],t=y[7],s=y[8];
z[0]=C*M+B*x+A*F;z[1]=C*L+B*w+A*E;z[2]=C*K+B*v+A*D;z[3]=J*M+I*x+G*F;z[4]=J*L+I*w+G*E;z[5]=J*K+I*v+G*D;z[6]=u*M+t*x+s*F;z[7]=u*L+t*w+s*E;z[8]=u*K+t*v+s*D;return z};h.multiplyVec2=function(t,v,u){if(!u){u=v}var s=v[0],w=v[1];u[0]=s*t[0]+w*t[3]+t[6];u[1]=s*t[1]+w*t[4]+t[7];return u};h.multiplyVec3=function(t,v,u){if(!u){u=v}var s=v[0],A=v[1],w=v[2];u[0]=s*t[0]+A*t[3]+w*t[6];u[1]=s*t[1]+A*t[4]+w*t[7];u[2]=s*t[2]+A*t[5]+w*t[8];return u};h.set=function(t,s){s[0]=t[0];s[1]=t[1];s[2]=t[2];s[3]=t[3];s[4]=t[4];
s[5]=t[5];s[6]=t[6];s[7]=t[7];s[8]=t[8];return s};h.identity=function(s){if(!s){s=h.create()}s[0]=1;s[1]=0;s[2]=0;s[3]=0;s[4]=1;s[5]=0;s[6]=0;s[7]=0;s[8]=1;return s};h.transpose=function(u,t){if(!t||u===t){var w=u[1],v=u[2],s=u[5];u[1]=u[3];u[2]=u[6];u[3]=w;u[5]=u[7];u[6]=v;u[7]=s;return u}t[0]=u[0];t[1]=u[3];t[2]=u[6];t[3]=u[1];t[4]=u[4];t[5]=u[7];t[6]=u[2];t[7]=u[5];t[8]=u[8];return t};h.toMat4=function(t,s){if(!s){s=g.create()}s[15]=1;s[14]=0;s[13]=0;s[12]=0;s[11]=0;s[10]=t[8];s[9]=t[7];s[8]=t[6];
s[7]=0;s[6]=t[5];s[5]=t[4];s[4]=t[3];s[3]=0;s[2]=t[2];s[1]=t[1];s[0]=t[0];return s};h.str=function(s){return"["+s[0]+", "+s[1]+", "+s[2]+", "+s[3]+", "+s[4]+", "+s[5]+", "+s[6]+", "+s[7]+", "+s[8]+"]"};var g={};g.create=function(t){var s=new b(16);if(arguments.length===4){s[0]=arguments[0];s[1]=arguments[1];s[2]=arguments[2];s[3]=arguments[3];s[4]=arguments[4];s[5]=arguments[5];s[6]=arguments[6];s[7]=arguments[7];s[8]=arguments[8];s[9]=arguments[9];s[10]=arguments[10];s[11]=arguments[11];s[12]=arguments[12];
s[13]=arguments[13];s[14]=arguments[14];s[15]=arguments[15]}else{if(t){s[0]=t[0];s[1]=t[1];s[2]=t[2];s[3]=t[3];s[4]=t[4];s[5]=t[5];s[6]=t[6];s[7]=t[7];s[8]=t[8];s[9]=t[9];s[10]=t[10];s[11]=t[11];s[12]=t[12];s[13]=t[13];s[14]=t[14];s[15]=t[15]}}return s};g.createFrom=function(I,H,F,C,z,y,x,w,v,u,t,s,G,E,B,A){var D=new b(16);D[0]=I;D[1]=H;D[2]=F;D[3]=C;D[4]=z;D[5]=y;D[6]=x;D[7]=w;D[8]=v;D[9]=u;D[10]=t;D[11]=s;D[12]=G;D[13]=E;D[14]=B;D[15]=A;return D};g.set=function(t,s){s[0]=t[0];s[1]=t[1];s[2]=t[2];
s[3]=t[3];s[4]=t[4];s[5]=t[5];s[6]=t[6];s[7]=t[7];s[8]=t[8];s[9]=t[9];s[10]=t[10];s[11]=t[11];s[12]=t[12];s[13]=t[13];s[14]=t[14];s[15]=t[15];return s};g.identity=function(s){if(!s){s=g.create()}s[0]=1;s[1]=0;s[2]=0;s[3]=0;s[4]=0;s[5]=1;s[6]=0;s[7]=0;s[8]=0;s[9]=0;s[10]=1;s[11]=0;s[12]=0;s[13]=0;s[14]=0;s[15]=1;return s};g.transpose=function(v,u){if(!u||v===u){var z=v[1],x=v[2],w=v[3],s=v[6],y=v[7],t=v[11];v[1]=v[4];v[2]=v[8];v[3]=v[12];v[4]=z;v[6]=v[9];v[7]=v[13];v[8]=x;v[9]=s;v[11]=v[14];v[12]=w;
v[13]=y;v[14]=t;return v}u[0]=v[0];u[1]=v[4];u[2]=v[8];u[3]=v[12];u[4]=v[1];u[5]=v[5];u[6]=v[9];u[7]=v[13];u[8]=v[2];u[9]=v[6];u[10]=v[10];u[11]=v[14];u[12]=v[3];u[13]=v[7];u[14]=v[11];u[15]=v[15];return u};g.determinant=function(G){var z=G[0],y=G[1],w=G[2],u=G[3],I=G[4],H=G[5],F=G[6],E=G[7],D=G[8],C=G[9],B=G[10],A=G[11],x=G[12],v=G[13],t=G[14],s=G[15];return(x*C*F*u-D*v*F*u-x*H*B*u+I*v*B*u+D*H*t*u-I*C*t*u-x*C*w*E+D*v*w*E+x*y*B*E-z*v*B*E-D*y*t*E+z*C*t*E+x*H*w*A-I*v*w*A-x*y*F*A+z*v*F*A+I*y*t*A-z*H*t*A-D*H*w*s+I*C*w*s+D*y*F*s-z*C*F*s-I*y*B*s+z*H*B*s)
};g.inverse=function(N,C){if(!C){C=N}var V=N[0],T=N[1],S=N[2],Q=N[3],v=N[4],u=N[5],t=N[6],s=N[7],K=N[8],J=N[9],I=N[10],H=N[11],X=N[12],W=N[13],U=N[14],R=N[15],G=V*u-T*v,F=V*t-S*v,E=V*s-Q*v,D=T*t-S*u,B=T*s-Q*u,A=S*s-Q*t,z=K*W-J*X,y=K*U-I*X,x=K*R-H*X,w=J*U-I*W,P=J*R-H*W,M=I*R-H*U,O=(G*M-F*P+E*w+D*x-B*y+A*z),L;if(!O){return null}L=1/O;C[0]=(u*M-t*P+s*w)*L;C[1]=(-T*M+S*P-Q*w)*L;C[2]=(W*A-U*B+R*D)*L;C[3]=(-J*A+I*B-H*D)*L;C[4]=(-v*M+t*x-s*y)*L;C[5]=(V*M-S*x+Q*y)*L;C[6]=(-X*A+U*E-R*F)*L;C[7]=(K*A-I*E+H*F)*L;
C[8]=(v*P-u*x+s*z)*L;C[9]=(-V*P+T*x-Q*z)*L;C[10]=(X*B-W*E+R*G)*L;C[11]=(-K*B+J*E-H*G)*L;C[12]=(-v*w+u*y-t*z)*L;C[13]=(V*w-T*y+S*z)*L;C[14]=(-X*D+W*F-U*G)*L;C[15]=(K*D-J*F+I*G)*L;return C};g.toRotationMat=function(t,s){if(!s){s=g.create()}s[0]=t[0];s[1]=t[1];s[2]=t[2];s[3]=t[3];s[4]=t[4];s[5]=t[5];s[6]=t[6];s[7]=t[7];s[8]=t[8];s[9]=t[9];s[10]=t[10];s[11]=t[11];s[12]=0;s[13]=0;s[14]=0;s[15]=1;return s};g.toMat3=function(t,s){if(!s){s=h.create()}s[0]=t[0];s[1]=t[1];s[2]=t[2];s[3]=t[4];s[4]=t[5];s[5]=t[6];
s[6]=t[8];s[7]=t[9];s[8]=t[10];return s};g.toInverseMat3=function(F,D){var w=F[0],v=F[1],u=F[2],H=F[4],G=F[5],E=F[6],A=F[8],z=F[9],y=F[10],x=y*G-E*z,t=-y*H+E*A,C=z*H-G*A,B=w*x+v*t+u*C,s;if(!B){return null}s=1/B;if(!D){D=h.create()}D[0]=x*s;D[1]=(-y*v+u*z)*s;D[2]=(E*v-u*G)*s;D[3]=t*s;D[4]=(y*w-u*A)*s;D[5]=(-E*w+u*H)*s;D[6]=C*s;D[7]=(-z*w+v*A)*s;D[8]=(G*w-v*H)*s;return D};g.multiply=function(R,A,B){if(!B){B=R}var Y=R[0],X=R[1],V=R[2],T=R[3],z=R[4],y=R[5],x=R[6],w=R[7],N=R[8],M=R[9],L=R[10],K=R[11],aa=R[12],Z=R[13],W=R[14],U=R[15],I=A[0],G=A[1],E=A[2],C=A[3],S=A[4],Q=A[5],P=A[6],O=A[7],v=A[8],u=A[9],t=A[10],s=A[11],J=A[12],H=A[13],F=A[14],D=A[15];
B[0]=I*Y+G*z+E*N+C*aa;B[1]=I*X+G*y+E*M+C*Z;B[2]=I*V+G*x+E*L+C*W;B[3]=I*T+G*w+E*K+C*U;B[4]=S*Y+Q*z+P*N+O*aa;B[5]=S*X+Q*y+P*M+O*Z;B[6]=S*V+Q*x+P*L+O*W;B[7]=S*T+Q*w+P*K+O*U;B[8]=v*Y+u*z+t*N+s*aa;B[9]=v*X+u*y+t*M+s*Z;B[10]=v*V+u*x+t*L+s*W;B[11]=v*T+u*w+t*K+s*U;B[12]=J*Y+H*z+F*N+D*aa;B[13]=J*X+H*y+F*M+D*Z;B[14]=J*V+H*x+F*L+D*W;B[15]=J*T+H*w+F*K+D*U;return B};g.multiplyVec3=function(v,u,t){if(!t){t=u}var s=u[0],A=u[1],w=u[2];t[0]=v[0]*s+v[4]*A+v[8]*w+v[12];t[1]=v[1]*s+v[5]*A+v[9]*w+v[13];t[2]=v[2]*s+v[6]*A+v[10]*w+v[14];
return t};g.multiplyVec4=function(A,v,u){if(!u){u=v}var s=v[0],C=v[1],B=v[2],t=v[3];u[0]=A[0]*s+A[4]*C+A[8]*B+A[12]*t;u[1]=A[1]*s+A[5]*C+A[9]*B+A[13]*t;u[2]=A[2]*s+A[6]*C+A[10]*B+A[14]*t;u[3]=A[3]*s+A[7]*C+A[11]*B+A[15]*t;return u};g.translate=function(I,D,B){var C=D[0],A=D[1],w=D[2],M,L,K,J,v,u,t,s,H,G,F,E;if(!B||I===B){I[12]=I[0]*C+I[4]*A+I[8]*w+I[12];I[13]=I[1]*C+I[5]*A+I[9]*w+I[13];I[14]=I[2]*C+I[6]*A+I[10]*w+I[14];I[15]=I[3]*C+I[7]*A+I[11]*w+I[15];return I}M=I[0];L=I[1];K=I[2];J=I[3];v=I[4];
u=I[5];t=I[6];s=I[7];H=I[8];G=I[9];F=I[10];E=I[11];B[0]=M;B[1]=L;B[2]=K;B[3]=J;B[4]=v;B[5]=u;B[6]=t;B[7]=s;B[8]=H;B[9]=G;B[10]=F;B[11]=E;B[12]=M*C+v*A+H*w+I[12];B[13]=L*C+u*A+G*w+I[13];B[14]=K*C+t*A+F*w+I[14];B[15]=J*C+s*A+E*w+I[15];return B};g.scale=function(v,u,t){var s=u[0],A=u[1],w=u[2];if(!t||v===t){v[0]*=s;v[1]*=s;v[2]*=s;v[3]*=s;v[4]*=A;v[5]*=A;v[6]*=A;v[7]*=A;v[8]*=w;v[9]*=w;v[10]*=w;v[11]*=w;return v}t[0]=v[0]*s;t[1]=v[1]*s;t[2]=v[2]*s;t[3]=v[3]*s;t[4]=v[4]*A;t[5]=v[5]*A;t[6]=v[6]*A;t[7]=v[7]*A;
t[8]=v[8]*w;t[9]=v[9]*w;t[10]=v[10]*w;t[11]=v[11]*w;t[12]=v[12];t[13]=v[13];t[14]=v[14];t[15]=v[15];return t};g.rotate=function(W,U,u,H){var I=u[0],G=u[1],F=u[2],S=Math.sqrt(I*I+G*G+F*F),N,Y,M,ac,ab,aa,Z,E,D,C,B,R,Q,P,O,L,K,J,X,V,T,A,w,v;if(!S){return null}if(S!==1){S=1/S;I*=S;G*=S;F*=S}N=Math.sin(U);Y=Math.cos(U);M=1-Y;ac=W[0];ab=W[1];aa=W[2];Z=W[3];E=W[4];D=W[5];C=W[6];B=W[7];R=W[8];Q=W[9];P=W[10];O=W[11];L=I*I*M+Y;K=G*I*M+F*N;J=F*I*M-G*N;X=I*G*M-F*N;V=G*G*M+Y;T=F*G*M+I*N;A=I*F*M+G*N;w=G*F*M-I*N;
v=F*F*M+Y;if(!H){H=W}else{if(W!==H){H[12]=W[12];H[13]=W[13];H[14]=W[14];H[15]=W[15]}}H[0]=ac*L+E*K+R*J;H[1]=ab*L+D*K+Q*J;H[2]=aa*L+C*K+P*J;H[3]=Z*L+B*K+O*J;H[4]=ac*X+E*V+R*T;H[5]=ab*X+D*V+Q*T;H[6]=aa*X+C*V+P*T;H[7]=Z*X+B*V+O*T;H[8]=ac*A+E*w+R*v;H[9]=ab*A+D*w+Q*v;H[10]=aa*A+C*w+P*v;H[11]=Z*A+B*w+O*v;return H};g.rotateX=function(C,t,A){var F=Math.sin(t),y=Math.cos(t),E=C[4],D=C[5],B=C[6],z=C[7],x=C[8],w=C[9],v=C[10],u=C[11];if(!A){A=C}else{if(C!==A){A[0]=C[0];A[1]=C[1];A[2]=C[2];A[3]=C[3];A[12]=C[12];
A[13]=C[13];A[14]=C[14];A[15]=C[15]}}A[4]=E*y+x*F;A[5]=D*y+w*F;A[6]=B*y+v*F;A[7]=z*y+u*F;A[8]=E*-F+x*y;A[9]=D*-F+w*y;A[10]=B*-F+v*y;A[11]=z*-F+u*y;return A};g.rotateY=function(E,w,D){var F=Math.sin(w),C=Math.cos(w),x=E[0],v=E[1],u=E[2],t=E[3],B=E[8],A=E[9],z=E[10],y=E[11];if(!D){D=E}else{if(E!==D){D[4]=E[4];D[5]=E[5];D[6]=E[6];D[7]=E[7];D[12]=E[12];D[13]=E[13];D[14]=E[14];D[15]=E[15]}}D[0]=x*C+B*-F;D[1]=v*C+A*-F;D[2]=u*C+z*-F;D[3]=t*C+y*-F;D[8]=x*F+B*C;D[9]=v*F+A*C;D[10]=u*F+z*C;D[11]=t*F+y*C;return D
};g.rotateZ=function(D,w,A){var F=Math.sin(w),y=Math.cos(w),x=D[0],v=D[1],u=D[2],t=D[3],E=D[4],C=D[5],B=D[6],z=D[7];if(!A){A=D}else{if(D!==A){A[8]=D[8];A[9]=D[9];A[10]=D[10];A[11]=D[11];A[12]=D[12];A[13]=D[13];A[14]=D[14];A[15]=D[15]}}A[0]=x*y+E*F;A[1]=v*y+C*F;A[2]=u*y+B*F;A[3]=t*y+z*F;A[4]=x*-F+E*y;A[5]=v*-F+C*y;A[6]=u*-F+B*y;A[7]=t*-F+z*y;return A};g.frustum=function(t,B,s,z,w,v,A){if(!A){A=g.create()}var x=(B-t),u=(z-s),y=(v-w);A[0]=(w*2)/x;A[1]=0;A[2]=0;A[3]=0;A[4]=0;A[5]=(w*2)/u;A[6]=0;A[7]=0;
A[8]=(B+t)/x;A[9]=(z+s)/u;A[10]=-(v+w)/y;A[11]=-1;A[12]=0;A[13]=0;A[14]=-(v*w*2)/y;A[15]=0;return A};g.perspective=function(u,t,x,s,v){var y=x*Math.tan(u*Math.PI/360),w=y*t;return g.frustum(-w,w,-y,y,x,s,v)};g.ortho=function(t,B,s,z,w,v,A){if(!A){A=g.create()}var x=(B-t),u=(z-s),y=(v-w);A[0]=2/x;A[1]=0;A[2]=0;A[3]=0;A[4]=0;A[5]=2/u;A[6]=0;A[7]=0;A[8]=0;A[9]=0;A[10]=-2/y;A[11]=0;A[12]=-(t+B)/x;A[13]=-(z+s)/u;A[14]=-(v+w)/y;A[15]=1;return A};g.lookAt=function(N,O,z,y){if(!y){y=g.create()}var M,L,J,u,t,s,C,B,A,H,K=N[0],I=N[1],G=N[2],x=z[0],w=z[1],v=z[2],F=O[0],E=O[1],D=O[2];
if(K===F&&I===E&&G===D){return g.identity(y)}C=K-F;B=I-E;A=G-D;H=1/Math.sqrt(C*C+B*B+A*A);C*=H;B*=H;A*=H;M=w*A-v*B;L=v*C-x*A;J=x*B-w*C;H=Math.sqrt(M*M+L*L+J*J);if(!H){M=0;L=0;J=0}else{H=1/H;M*=H;L*=H;J*=H}u=B*J-A*L;t=A*M-C*J;s=C*L-B*M;H=Math.sqrt(u*u+t*t+s*s);if(!H){u=0;t=0;s=0}else{H=1/H;u*=H;t*=H;s*=H}y[0]=M;y[1]=u;y[2]=C;y[3]=0;y[4]=L;y[5]=t;y[6]=B;y[7]=0;y[8]=J;y[9]=s;y[10]=A;y[11]=0;y[12]=-(M*K+L*I+J*G);y[13]=-(u*K+t*I+s*G);y[14]=-(C*K+B*I+A*G);y[15]=1;return y};g.fromRotationTranslation=function(s,H,D){if(!D){D=g.create()
}var E=s[0],C=s[1],B=s[2],F=s[3],K=E+E,t=C+C,G=B+B,A=E*K,v=E*t,u=E*G,J=C*t,I=C*G,N=B*G,O=F*K,M=F*t,L=F*G;D[0]=1-(J+N);D[1]=v+L;D[2]=u-M;D[3]=0;D[4]=v-L;D[5]=1-(A+N);D[6]=I+O;D[7]=0;D[8]=u+M;D[9]=I-O;D[10]=1-(A+J);D[11]=0;D[12]=H[0];D[13]=H[1];D[14]=H[2];D[15]=1;return D};g.str=function(s){return"["+s[0]+", "+s[1]+", "+s[2]+", "+s[3]+", "+s[4]+", "+s[5]+", "+s[6]+", "+s[7]+", "+s[8]+", "+s[9]+", "+s[10]+", "+s[11]+", "+s[12]+", "+s[13]+", "+s[14]+", "+s[15]+"]"};var e={};e.create=function(t){var s=new b(4);
if(t){s[0]=t[0];s[1]=t[1];s[2]=t[2];s[3]=t[3]}else{s[0]=s[1]=s[2]=s[3]=0}return s};e.createFrom=function(s,A,v,t){var u=new b(4);u[0]=s;u[1]=A;u[2]=v;u[3]=t;return u};e.set=function(t,s){s[0]=t[0];s[1]=t[1];s[2]=t[2];s[3]=t[3];return s};e.identity=function(s){if(!s){s=e.create()}s[0]=0;s[1]=0;s[2]=0;s[3]=1;return s};var j=e.identity();e.calculateW=function(u,t){var s=u[0],w=u[1],v=u[2];if(!t||u===t){u[3]=-Math.sqrt(Math.abs(1-s*s-w*w-v*v));return u}t[0]=s;t[1]=w;t[2]=v;t[3]=-Math.sqrt(Math.abs(1-s*s-w*w-v*v));
return t};e.dot=function(s,t){return s[0]*t[0]+s[1]*t[1]+s[2]*t[2]+s[3]*t[3]};e.inverse=function(x,w){var t=x[0],s=x[1],z=x[2],y=x[3],u=t*t+s*s+z*z+y*y,v=u?1/u:0;if(!w||x===w){x[0]*=-v;x[1]*=-v;x[2]*=-v;x[3]*=v;return x}w[0]=-x[0]*v;w[1]=-x[1]*v;w[2]=-x[2]*v;w[3]=x[3]*v;return w};e.conjugate=function(t,s){if(!s||t===s){t[0]*=-1;t[1]*=-1;t[2]*=-1;return t}s[0]=-t[0];s[1]=-t[1];s[2]=-t[2];s[3]=t[3];return s};e.length=function(u){var s=u[0],A=u[1],v=u[2],t=u[3];return Math.sqrt(s*s+A*A+v*v+t*t)};e.normalize=function(A,v){if(!v){v=A
}var t=A[0],C=A[1],B=A[2],u=A[3],s=Math.sqrt(t*t+C*C+B*B+u*u);if(s===0){v[0]=0;v[1]=0;v[2]=0;v[3]=0;return v}s=1/s;v[0]=t*s;v[1]=C*s;v[2]=B*s;v[3]=u*s;return v};e.add=function(t,u,s){if(!s||t===s){t[0]+=u[0];t[1]+=u[1];t[2]+=u[2];t[3]+=u[3];return t}s[0]=t[0]+u[0];s[1]=t[1]+u[1];s[2]=t[2]+u[2];s[3]=t[3]+u[3];return s};e.multiply=function(t,v,C){if(!C){C=t}var A=t[0],z=t[1],y=t[2],B=t[3],w=v[0],u=v[1],s=v[2],x=v[3];C[0]=A*x+B*w+z*s-y*u;C[1]=z*x+B*u+y*w-A*s;C[2]=y*x+B*s+A*u-z*w;C[3]=B*x-A*w-z*u-y*s;
return C};e.multiplyVec3=function(t,v,I){if(!I){I=v}var H=v[0],G=v[1],F=v[2],D=t[0],C=t[1],B=t[2],E=t[3],w=E*H+C*F-B*G,u=E*G+B*H-D*F,s=E*F+D*G-C*H,A=-D*H-C*G-B*F;I[0]=w*E+A*-D+u*-B-s*-C;I[1]=u*E+A*-C+s*-D-w*-B;I[2]=s*E+A*-B+w*-C-u*-D;return I};e.scale=function(t,u,s){if(!s||t===s){t[0]*=u;t[1]*=u;t[2]*=u;t[3]*=u;return t}s[0]=t[0]*u;s[1]=t[1]*u;s[2]=t[2]*u;s[3]=t[3]*u;return s};e.toMat3=function(s,D){if(!D){D=h.create()}var E=s[0],C=s[1],B=s[2],F=s[3],J=E+E,t=C+C,G=B+B,A=E*J,v=E*t,u=E*G,I=C*t,H=C*G,M=B*G,N=F*J,L=F*t,K=F*G;
D[0]=1-(I+M);D[1]=v+K;D[2]=u-L;D[3]=v-K;D[4]=1-(A+M);D[5]=H+N;D[6]=u+L;D[7]=H-N;D[8]=1-(A+I);return D};e.toMat4=function(s,D){if(!D){D=g.create()}var E=s[0],C=s[1],B=s[2],F=s[3],J=E+E,t=C+C,G=B+B,A=E*J,v=E*t,u=E*G,I=C*t,H=C*G,M=B*G,N=F*J,L=F*t,K=F*G;D[0]=1-(I+M);D[1]=v+K;D[2]=u-L;D[3]=0;D[4]=v-K;D[5]=1-(A+M);D[6]=H+N;D[7]=0;D[8]=u+L;D[9]=H-N;D[10]=1-(A+I);D[11]=0;D[12]=0;D[13]=0;D[14]=0;D[15]=1;return D};e.slerp=function(t,u,v,A){if(!A){A=t}var w=t[0]*u[0]+t[1]*u[1]+t[2]*u[2]+t[3]*u[3],x,s,z,y;if(Math.abs(w)>=1){if(A!==t){A[0]=t[0];
A[1]=t[1];A[2]=t[2];A[3]=t[3]}return A}x=Math.acos(w);s=Math.sqrt(1-w*w);if(Math.abs(s)<0.001){A[0]=(t[0]*0.5+u[0]*0.5);A[1]=(t[1]*0.5+u[1]*0.5);A[2]=(t[2]*0.5+u[2]*0.5);A[3]=(t[3]*0.5+u[3]*0.5);return A}z=Math.sin((1-v)*x)/s;y=Math.sin(v*x)/s;A[0]=(t[0]*z+u[0]*y);A[1]=(t[1]*z+u[1]*y);A[2]=(t[2]*z+u[2]*y);A[3]=(t[3]*z+u[3]*y);return A};e.fromRotationMatrix=function(x,v){if(!v){v=e.create()}var s=x[0]+x[4]+x[8];var z;if(s>0){z=Math.sqrt(s+1);v[3]=0.5*z;z=0.5/z;v[0]=(x[7]-x[5])*z;v[1]=(x[2]-x[6])*z;
v[2]=(x[3]-x[1])*z}else{var y=e.fromRotationMatrix.s_iNext=e.fromRotationMatrix.s_iNext||[1,2,0];var w=0;if(x[4]>x[0]){w=1}if(x[8]>x[w*3+w]){w=2}var u=y[w];var t=y[u];z=Math.sqrt(x[w*3+w]-x[u*3+u]-x[t*3+t]+1);v[w]=0.5*z;z=0.5/z;v[3]=(x[t*3+u]-x[u*3+t])*z;v[u]=(x[u*3+w]+x[w*3+u])*z;v[t]=(x[t*3+w]+x[w*3+t])*z}return v};h.toQuat4=e.fromRotationMatrix;(function(){var s=h.create();e.fromAxes=function(u,w,t,v){s[0]=w[0];s[3]=w[1];s[6]=w[2];s[1]=t[0];s[4]=t[1];s[7]=t[2];s[2]=u[0];s[5]=u[1];s[8]=u[2];return e.fromRotationMatrix(s,v)
}})();e.identity=function(s){if(!s){s=e.create()}s[0]=0;s[1]=0;s[2]=0;s[3]=1;return s};e.fromAngleAxis=function(x,v,t){if(!t){t=e.create()}var w=x*0.5;var u=Math.sin(w);t[3]=Math.cos(w);t[0]=u*v[0];t[1]=u*v[1];t[2]=u*v[2];return t};e.toAngleAxis=function(v,t){if(!t){t=v}var s=v[0]*v[0]+v[1]*v[1]+v[2]*v[2];if(s>0){t[3]=2*Math.acos(v[3]);var u=m.invsqrt(s);t[0]=v[0]*u;t[1]=v[1]*u;t[2]=v[2]*u}else{t[3]=0;t[0]=1;t[1]=0;t[2]=0}return t};e.str=function(s){return"["+s[0]+", "+s[1]+", "+s[2]+", "+s[3]+"]"
};var d={};d.create=function(t){var s=new b(2);if(t){s[0]=t[0];s[1]=t[1]}else{s[0]=0;s[1]=0}return s};d.createFrom=function(s,u){var t=new b(2);t[0]=s;t[1]=u;return t};d.add=function(t,s,u){if(!u){u=s}u[0]=t[0]+s[0];u[1]=t[1]+s[1];return u};d.subtract=function(t,s,u){if(!u){u=s}u[0]=t[0]-s[0];u[1]=t[1]-s[1];return u};d.multiply=function(t,s,u){if(!u){u=s}u[0]=t[0]*s[0];u[1]=t[1]*s[1];return u};d.divide=function(t,s,u){if(!u){u=s}u[0]=t[0]/s[0];u[1]=t[1]/s[1];return u};d.scale=function(s,t,u){if(!u){u=s
}u[0]=s[0]*t;u[1]=s[1]*t;return u};d.dist=function(u,t){var s=t[0]-u[0],v=t[1]-u[1];return Math.sqrt(s*s+v*v)};d.set=function(t,s){s[0]=t[0];s[1]=t[1];return s};d.negate=function(t,s){if(!s){s=t}s[0]=-t[0];s[1]=-t[1];return s};d.normalize=function(t,s){if(!s){s=t}var u=t[0]*t[0]+t[1]*t[1];if(u>0){u=Math.sqrt(u);s[0]=t[0]/u;s[1]=t[1]/u}else{s[0]=s[1]=0}return s};d.cross=function(t,s,u){var v=t[0]*s[1]-t[1]*s[0];if(!u){return v}u[0]=u[1]=0;u[2]=v;return u};d.length=function(t){var s=t[0],u=t[1];return Math.sqrt(s*s+u*u)
};d.dot=function(t,s){return t[0]*s[0]+t[1]*s[1]};d.direction=function(v,u,w){if(!w){w=v}var t=v[0]-u[0],z=v[1]-u[1],s=t*t+z*z;if(!s){w[0]=0;w[1]=0;w[2]=0;return w}s=1/Math.sqrt(s);w[0]=t*s;w[1]=z*s;return w};d.lerp=function(t,s,v,u){if(!u){u=t}u[0]=t[0]+v*(s[0]-t[0]);u[1]=t[1]+v*(s[1]-t[1]);return u};d.str=function(s){return"["+s[0]+", "+s[1]+"]"};var i={};i.create=function(t){var s=new b(4);if(t){s[0]=t[0];s[1]=t[1];s[2]=t[2];s[3]=t[3]}else{s[0]=s[1]=s[2]=s[3]=0}return s};i.createFrom=function(u,t,w,v){var s=new b(4);
s[0]=u;s[1]=t;s[2]=w;s[3]=v;return s};i.set=function(t,s){s[0]=t[0];s[1]=t[1];s[2]=t[2];s[3]=t[3];return s};i.identity=function(s){if(!s){s=i.create()}s[0]=1;s[1]=0;s[2]=0;s[3]=1;return s};i.transpose=function(u,t){if(!t||u===t){var s=u[1];u[1]=u[2];u[2]=s;return u}t[0]=u[0];t[1]=u[2];t[2]=u[1];t[3]=u[3];return t};i.determinant=function(s){return s[0]*s[3]-s[2]*s[1]};i.inverse=function(x,v){if(!v){v=x}var u=x[0],t=x[1],s=x[2],y=x[3];var w=u*y-s*t;if(!w){return null}w=1/w;v[0]=y*w;v[1]=-t*w;v[2]=-s*w;
v[3]=u*w;return v};i.multiply=function(v,t,y){if(!y){y=v}var u=v[0],s=v[1],x=v[2],w=v[3];y[0]=u*t[0]+s*t[2];y[1]=u*t[1]+s*t[3];y[2]=x*t[0]+w*t[2];y[3]=x*t[1]+w*t[3];return y};i.rotate=function(z,t,x){if(!x){x=z}var A=z[0],y=z[1],v=z[2],u=z[3],B=Math.sin(t),w=Math.cos(t);x[0]=A*w+y*B;x[1]=A*-B+y*w;x[2]=v*w+u*B;x[3]=v*-B+u*w;return x};i.multiplyVec2=function(t,v,u){if(!u){u=v}var s=v[0],w=v[1];u[0]=s*t[0]+w*t[1];u[1]=s*t[2]+w*t[3];return u};i.scale=function(x,t,y){if(!y){y=x}var A=x[0],z=x[1],v=x[2],u=x[3],s=t[0],w=t[1];
y[0]=A*s;y[1]=z*w;y[2]=v*s;y[3]=u*w;return y};i.str=function(s){return"["+s[0]+", "+s[1]+", "+s[2]+", "+s[3]+"]"};var a={};a.create=function(t){var s=new b(4);if(t){s[0]=t[0];s[1]=t[1];s[2]=t[2];s[3]=t[3]}else{s[0]=0;s[1]=0;s[2]=0;s[3]=0}return s};a.createFrom=function(s,A,v,t){var u=new b(4);u[0]=s;u[1]=A;u[2]=v;u[3]=t;return u};a.add=function(t,s,u){if(!u){u=s}u[0]=t[0]+s[0];u[1]=t[1]+s[1];u[2]=t[2]+s[2];u[3]=t[3]+s[3];return u};a.subtract=function(t,s,u){if(!u){u=s}u[0]=t[0]-s[0];u[1]=t[1]-s[1];
u[2]=t[2]-s[2];u[3]=t[3]-s[3];return u};a.multiply=function(t,s,u){if(!u){u=s}u[0]=t[0]*s[0];u[1]=t[1]*s[1];u[2]=t[2]*s[2];u[3]=t[3]*s[3];return u};a.divide=function(t,s,u){if(!u){u=s}u[0]=t[0]/s[0];u[1]=t[1]/s[1];u[2]=t[2]/s[2];u[3]=t[3]/s[3];return u};a.scale=function(s,t,u){if(!u){u=s}u[0]=s[0]*t;u[1]=s[1]*t;u[2]=s[2]*t;u[3]=s[3]*t;return u};a.set=function(t,s){s[0]=t[0];s[1]=t[1];s[2]=t[2];s[3]=t[3];return s};a.negate=function(t,s){if(!s){s=t}s[0]=-t[0];s[1]=-t[1];s[2]=-t[2];s[3]=-t[3];return s
};a.lerp=function(t,s,v,u){if(!u){u=t}u[0]=t[0]+v*(s[0]-t[0]);u[1]=t[1]+v*(s[1]-t[1]);u[2]=t[2]+v*(s[2]-t[2]);u[3]=t[3]+v*(s[3]-t[3]);return u};a.str=function(s){return"["+s[0]+", "+s[1]+", "+s[2]+", "+s[3]+"]"};if(n){n.glMatrixArrayType=b;n.MatrixArray=b;n.setMatrixArrayType=r;n.determineMatrixArrayType=l;n.glMath=m;n.vec2=d;n.vec3=c;n.vec4=a;n.mat2=i;n.mat3=h;n.mat4=g;n.quat4=e}return{glMatrixArrayType:b,MatrixArray:b,setMatrixArrayType:r,determineMatrixArrayType:l,glMath:m,vec2:d,vec3:c,vec4:a,mat2:i,mat3:h,mat4:g,quat4:e}
}));function vxlCameraState(a,b){if(!(b instanceof vxlCamera)){alert("vxlCameraState needs a vxlCamera as argument");return null}this.name=a;this.c=b;this.FOV=c.FOV;this.Z_NEAR=c.Z_NEAR;this.Z_FAR=c.Z_FAR;this.matrix=mat4.identity();this.right=vec3.createFrom(1,0,0);this.up=vec3.createFrom(0,1,0);this.normal=vec3.createFrom(0,0,1);this.position=vec3.createFrom(0,0,1);this.focalPoint=vec3.createFrom(0,0,0);this.cRot=vec3.createFrom(0,0,0);this.azimuth=c.azimuth;this.elevation=c.elevation;this.type=c.type;
this.distance=c.distance}vxlCameraState.prototype.retrieve=function(){var a=this.c;a.azimuth=this.azimuth;a.elevation=this.elevation;vec3.set(this.focus,a.focus);vec3.set(this.up,a.up);vec3.set(this.right,a.right);a.setPosition(this.position)};function vxlCamera(b,a){this.UID=vxl.util.generateUID();this.view=b;this.FOV=vxl.def.camera.fov;this.Z_NEAR=vxl.def.camera.near;this.Z_FAR=vxl.def.camera.far;this._matrix=mat4.identity();this._right=vec3.createFrom(1,0,0);this._up=vec3.createFrom(0,1,0);this._normal=vec3.createFrom(0,0,1);this._position=vec3.createFrom(0,0,1);this._focalPoint=vec3.createFrom(0,0,0);this._distanceVector=vec3.createFrom(0,0,0);this._azimuth=0;this._elevation=0;this._roll=0;this._relAzimuth=0;this._relElevation=0;this._relRoll=0;
this._dollyingStep=0;this._distance=1;this._following=undefined;this._trackingMode=vxl.def.camera.tracking.DEFAULT;this.states=[];if(a!=undefined&&a!=null){this.type=a}else{this.type=vxl.def.camera.type.ORBITING}}vxlCamera.prototype.setType=function(b,a){if(b!=vxl.def.camera.type.ORBITING&&b!=vxl.def.camera.type.TRACKING){console.error("vxlCamera.setType ERROR type"+b+" unknown. Setting camera to ORBITING type.");this.type=vxl.def.camera.type.ORBITING}else{this.type=b}if(this.type==vxl.def.camera.type.TRACKING&&a!=undefined){this.setTrackingMode(a)
}};vxlCamera.prototype.setTrackingMode=function(a){if(a==undefined){return}this._trackingMode=a};vxlCamera.prototype.follow=function(b,a){this.setType(vxl.def.camera.type.TRACKING,a);if(b==undefined||b==null){alert("vxlCamera.follow: Unable to follow undefined/null actor");console.error("vxlCamera.follow: Unable to follow undefined/null actor")}this._following=b;b.addTrackingCamera(this)};vxlCamera.prototype.unfollow=function(){this._following.removeTrackingCamera(this);this._following=undefined};
vxlCamera.prototype.updateWithActor=function(a){if(this._following!=a){return}switch(this._trackingMode){case vxl.def.camera.tracking.DEFAULT:break;case vxl.def.camera.tracking.ROTATIONAL:case vxl.def.camera.tracking.CINEMATIC:this.setFocalPoint(a._position);break;case vxl.def.camera.tracking.TRANSLATIONAL:this.translate(a._translation);break}};vxlCamera.prototype.setPosition=function(a,c,b){this._setPosition(a,c,b);this.setFocalPoint(this._focalPoint)};vxlCamera.prototype.setFocalPoint=function(i,h,g){var e=vec3.create([0,1,0]);
this._focalPoint=vxl.util.createVec3(i,h,g);if(this._trackingMode==vxl.def.camera.tracking.CINEMATIC){var f=vec3.subtract(this._focalPoint,this._position,vec3.create());var i=f[0],h=f[1],g=f[2],a=vec3.length(f);var b=Math.asin(h/a)*vxl.def.rad2deg;var j=90+Math.atan2(g,i)*vxl.def.rad2deg;var c=mat4.identity();mat4.rotateY(c,j*vxl.def.deg2rad);mat4.rotateX(c,b*vxl.def.deg2rad);e=mat4.multiplyVec3(c,[0,1,0],vec3.create())}mat4.inverse(mat4.lookAt(this._position,this._focalPoint,e),this._matrix);this._getAxes();
this._getDistance();this._getAngles()};vxlCamera.prototype.setDistance=function(b){if(this._distance==b||b<0){return}this._distance=b;if(this._distance<0.0002){this._distance=0.0002;console.warn(" vxlCamera.setDistance WARN: Distance is set to minimum (0.0002)")}this._dollyingStep=this._distance/100;var e=vec3.create();var b=this._distance;var c=this._normal;var a=this._focalPoint;e[0]=b*c[0]+a[0];e[1]=b*c[1]+a[1];e[2]=b*c[2]+a[2];this._setPosition(e)};vxlCamera.prototype.changeAzimuth=function(a){this.setAzimuth(this._azimuth+a)
};vxlCamera.prototype.changeElevation=function(a){this.setElevation(this._elevation+a)};vxlCamera.prototype.changeRoll=function(a){this.roll(this._roll+a)};vxlCamera.prototype.setAzimuth=function(a){this._azimuth=this._getAngle(a);this._computeMatrix();this._getAxes();if(this.type==vxl.def.camera.type.ORBITING){this._getPosition()}else{if(this.type==vxl.def.camera.type.TRACKING){this._getFocalPoint()}}};vxlCamera.prototype.setElevation=function(a){this._elevation=this._getAngle(a);this._computeMatrix();
this._getAxes();if(this.type==vxl.def.camera.type.ORBITING){this._getPosition()}else{if(this.type==vxl.def.camera.type.TRACKING){this._getFocalPoint()}}};vxlCamera.prototype.setRoll=function(a){this._roll=this._getAngle(a);this._computeMatrix();this._getAxes();if(this.type==vxl.def.camera.type.ORBITING){this._getPosition()}else{if(this.type==vxl.def.camera.type.TRACKING){this._getFocalPoint()}}};vxlCamera.prototype.rotate=function(c,b,a){if(Math.abs(this._elevation+b)>90){return}this._relElevation=this._getAngle(b);
this._relAzimuth=this._getAngle(c);this._relRoll=this._getAngle(a);this._elevation+=this._relElevation;this._azimuth+=this._relAzimuth;this._roll+=this._relRoll;this._computeMatrix();this._getAxes();if(this.type==vxl.def.camera.type.ORBITING){this._getPosition()}else{if(this.type==vxl.def.camera.type.TRACKING){this._getFocalPoint()}}this._update()};vxlCamera.prototype.dolly=function(b){var d=this._normal;var c=vec3.create(this._position);var a=b*this._dollyingStep;c[0]+=a*d[0];c[1]+=a*d[1];c[2]+=a*d[2];
this._setPosition(c);if(this.type==vxl.def.camera.type.ORBITING){this._getDistance()}else{if(this.type==vxl.def.camera.type.TRACKING){vec3.add(c,this._distanceVector,this._focalPoint)}}};vxlCamera.prototype.pan=function(b,a){this.translate(b,a,0)};vxlCamera.prototype.translate=function(a,e,c){var d=vec3.create(this._position);vec3.add(d,vec3.scale(this._right,a,vec3.create()));vec3.add(d,vec3.scale(this._up,e,vec3.create()));vec3.add(d,vec3.scale(this._normal,c,vec3.create()));var b=vec3.create(this._focalPoint);
vec3.add(b,vec3.scale(this._right,a,vec3.create()));vec3.add(b,vec3.scale(this._up,e,vec3.create()));vec3.add(b,vec3.scale(this._normal,c,vec3.create()));this._setPosition(d);this.setFocalPoint(b)};vxlCamera.prototype.refresh=function(){this.view.refresh()};vxlCamera.prototype.lookAt=function(a){if(a instanceof vxlActor){this.setFocalPoint(a._position)}else{if(typeof(x)=="string"){var a=this.view.scene.getActorByName(actorName);if(a==undefined){throw"vxlCamera.lookAt ERROR: The actor "+actorName+" does not exist"
}else{this.setFocalPoint(a._position)}}}};vxlCamera.prototype.closeUp=function(a){if(a instanceof vxlActor){this._shot(a._bb)}else{if(typeof(x)=="string"){var a=this.view.scene.getActorByName(actorName);if(a==undefined){throw"vxlCamera.lookAt ERROR: The actor "+actorName+" does not exist"}else{this._shot(a._bb)}}}};vxlCamera.prototype.longShot=function(){this.view.scene.computeBoundingBox();this._shot(this.view.scene.bb)};vxlCamera.prototype._shot=function(c){this.setElevation(0);this.setAzimuth(0);
var b=Math.max(c[3]-c[0],c[4]-c[1]);cc=[0,0,0];cc[0]=(c[3]+c[0])/2;cc[1]=(c[4]+c[1])/2;cc[2]=(c[5]+c[2])/2;cc[0]=Math.round(cc[0]*1000)/1000;cc[1]=Math.round(cc[1]*1000)/1000;cc[2]=Math.round(cc[2]*1000)/1000;if(b!=0){var a=1.5*b/(Math.tan(this.FOV*Math.PI/180));this.setPosition([cc[0],cc[1],cc[2]+a])}this.setFocalPoint(cc)};vxlCamera.prototype.save=function(a){var b=new vxlCameraState(a,this);this.states.push(b)};vxlCamera.prototype.retrieve=function(a){for(var b=0;b<this.states.length;b+=1){if(this.states[b].name==a){this.states[b].retrieve();
return}}throw"vxlCamera.retrieve: state "+a+" not found"};vxlCamera.prototype.status=function(){console.info("------------- Camera Status -------------");console.info("       type: "+this.type);console.info("      right: "+vxl.util.format(this._right,2));console.info("         up: "+vxl.util.format(this._up,2));console.info("     normal: "+vxl.util.format(this._normal,2));console.info("   position: "+vxl.util.format(this._position,2));console.info("focal point: "+vxl.util.format(this._focalPoint,2));
console.info("   d vector: "+vxl.util.format(this._distanceVector,2));console.info("    azimuth: "+vxl.util.format(this._azimuth,3));console.info("  elevation: "+vxl.util.format(this._elevation,3));console.info("   distance: "+vxl.util.format(this._distance,2))};vxlCamera.prototype.getViewTransform=function(){return mat4.inverse(this._matrix,mat4.create())};vxlCamera.prototype.setMatrix=function(a){this._matrix=a;this._update()};vxlCamera.prototype._computeMatrix=function(){mat4.identity(this._matrix);
var e=quat4.fromAngleAxis(this._elevation*vxl.def.deg2rad,[1,0,0]);var d=quat4.fromAngleAxis(this._azimuth*vxl.def.deg2rad,[0,1,0]);var c=quat4.fromAngleAxis(this._roll*vxl.def.deg2rad,[0,0,1]);var b=quat4.multiply(d,e,quat4.create());b=quat4.multiply(b,c,quat4.create());var a=quat4.toMat4(b);if(this.type==vxl.def.camera.type.ORBITING){mat4.translate(this._matrix,this._focalPoint);mat4.multiply(this._matrix,a);mat4.translate(this._matrix,[0,0,this._distance])}else{if(this.type==vxl.def.camera.type.TRACKING){mat4.translate(this._matrix,this._position);
mat4.multiply(this._matrix,a)}}};vxlCamera.prototype._setPosition=function(b,d,c){this._position=vxl.util.createVec3(b,d,c);var a=this._matrix;a[12]=this._position[0];a[13]=this._position[1];a[14]=this._position[2];a[15]=1};vxlCamera.prototype._getAxes=function(){var a=this._matrix;vec3.set(mat4.multiplyVec4(a,[1,0,0,0]),this._right);vec3.set(mat4.multiplyVec4(a,[0,1,0,0]),this._up);vec3.set(mat4.multiplyVec4(a,[0,0,1,0]),this._normal);vec3.normalize(this._right);vec3.normalize(this._up);vec3.normalize(this._normal)
};vxlCamera.prototype._getPosition=function(){var a=this._matrix;vec3.set(mat4.multiplyVec4(a,[0,0,0,1]),this._position);this._getDistance()};vxlCamera.prototype._getFocalPoint=function(){mat4.multiplyVec3(mat4.toRotationMat(this._matrix),[0,0,-this._distance],this._distanceVector);vec3.add(this._position,this._distanceVector,this._focalPoint);this._getDistance()};vxlCamera.prototype._getDistance=function(){this._distanceVector=vec3.subtract(this._focalPoint,this._position,vec3.create());this._distance=vec3.length(this._distanceVector);
this._dollyingStep=this._distance/100};vxlCamera.prototype._getAngles=function(){var a=this._distanceVector[0],d=this._distanceVector[1],c=this._distanceVector[2];var b=vec3.length(this._distanceVector);this._elevation=Math.asin(d/b)*vxl.def.rad2deg;this._azimuth=Math.atan2(-a,-c)*vxl.def.rad2deg};vxlCamera.prototype._update=function(){this._getAxes();this._getPosition();this._getDistance();this._getAngles()};vxlCamera.prototype._calculateAngles=function(){var f=mat4.toMat3(this._matrix);var d=mat3.toQuat4(f);
var h=d[0],g=d[1],e=d[2],i=d[3];var b=Math.atan2(2*(i*h+g*e),1-2*(h*h+g*g))*vxl.def.rad2deg;var a=Math.asin(2*(i*g-e*g))*vxl.def.rad2deg;var c=Math.atan2(2*(i*e+h*g),1-2*(g*g+e*e))*vxl.def.rad2deg;console.info(" roll :"+vxl.util.format(b,2));console.info("pitch :"+vxl.util.format(a,2));console.info("  yaw :"+vxl.util.format(c,2))};vxlCamera.prototype._getAngle=function(a){if(a==undefined){return 0}else{if(a>360||a<-360){return a%360}else{return a}}};function vxlCameraManager(a){this.view=a;this.cameras=[];this.active=this.create();if(vxl.c.camera==undefined){vxl.c.camera=this.active}}vxlCameraManager.prototype.reset=function(a){this.cameras=[];this.interactors=[];this.active=this.create(a)};vxlCameraManager.prototype.create=function(b){var a=new vxlCamera(this.view,b);this.cameras.push(a);return a};vxlCameraManager.prototype.remove=function(a){if(this.cameras.length==1){throw ("vxlCameraManager.remove ERROR: the camera manager must not eliminate the last camera standing. Operation cancelled")
}else{this.cameras.splice(a,1)}};vxlCameraManager.prototype.get=function(a){this._checkBoundary(a);return this.cameras[a]};vxlCameraManager.prototype.switchTo=function(a){var b=this.view;this._checkBoundary(a);this.active=this.cameras[a];if(b.interactor!=undefined){b.interactor.connectCamera(this.active)}else{throw ("vxlCameraManager.switchTo ERROR: switching to camera ["+a+"] while the view "+b.name+" does not have an interactor set")}vxl.c.camera=this.active;return this.active};vxlCameraManager.prototype._checkBoundary=function(a){if(a<0||a>=this.cameras.length){throw ("The camera "+a+" does not exist")
}};function vxlViewInteractor(){this.view=undefined;this.camera=undefined;this.UID=vxl.util.generateUID()}vxlViewInteractor.prototype.getType=function(){return"vxlViewInteractor"};vxlViewInteractor.prototype.connectView=function(a){if(!(a instanceof vxlView)){throw"ViewInteractor.connectView: the parameter is not a vxlView"}var c=this;var b=a.canvas;this.view=a;this.camera=a.cameraman.active;b.onmousedown=function(d){c.onMouseDown(d)};b.onmouseup=function(d){c.onMouseUp(d)};b.onmousemove=function(d){c.onMouseMove(d)
};b.ondragover=function(d){c.onDragOver(d)};b.ondragleave=function(d){c.onDragLeave(d)};b.ondrop=function(d){c.onDrop(d)};window.onkeydown=function(d){c.onKeyDown(d)};window.onkeyup=function(d){c.onKeyUp(d)};b.ondblclick=function(d){c.onDoubleClick(d)}};vxlViewInteractor.prototype.connectCamera=function(a){if(a instanceof vxlCamera){this.camera=a;this.camera.interactor=this}else{throw ("ViewInteractor.connectCamera: The object "+a+" is not a valid camera")}};vxlViewInteractor.prototype.onMouseUp=function(a){alert("implement onMouseUp")
};vxlViewInteractor.prototype.onMouseDown=function(a){alert("implement onMouseDown")};vxlViewInteractor.prototype.onMouseMove=function(a){alert("implement onMouseMove")};vxlViewInteractor.prototype.onKeyDown=function(a){alert("implement onKeyDown")};vxlViewInteractor.prototype.onKeyUp=function(a){alert("implement onKeyUp")};vxlViewInteractor.prototype.onDragOver=function(a){alert("implement onDragOver")};vxlViewInteractor.prototype.onDragLeave=function(a){alert("implement onDragLeave")};vxlViewInteractor.prototype.onDrop=function(a){alert("implement onDrop")
};vxlViewInteractor.prototype.onDoubleClick=function(a){alert("implement onDrop")};vxlTrackerInteractor.prototype=new vxlViewInteractor();vxlTrackerInteractor.prototype.constructor=vxlViewInteractor;function vxlTrackerInteractor(){vxlViewInteractor.call(this);this.MOTION_FACTOR=10;this.task=vxl.def.interactor.task.NONE;this.x=0;this.y=0;this.lastX=0;this.lastY=0;this.lastClickedX=0;this.lastClickedY=0;this.ctrlPressed=false;this.altPressed=false;this.keyPressed=0;this.button=-1;this.dragging=false;this.dragndrop=false}vxlTrackerInteractor.prototype.getType=function(){return"vxlTrackerInteractor"
};vxlTrackerInteractor.prototype.onKeyDown=function(d){this.keyPressed=d.keyCode;this.altPressed=d.altKey;this.shiftPressed=d.shiftKey;var c=this.camera;if(!this.altPressed&&!this.shiftPressed){switch(this.keyPressed){case 38:c.changeElevation(10);break;case 40:c.changeElevation(-10);break;case 37:c.changeAzimuth(-10);break;case 39:c.changeAzimuth(10);break;case 70:this.view.fullscreen(true);break;case 88:this.view.fullscreen(false);break;default:break}}else{if(this.shiftPressed&&this.keyPressed!=17){var b=0;
var a=0;switch(this.keyPressed){case 38:a=10;break;case 40:a=-10;break;case 37:b=-10;break;case 39:b=10;break;default:break}if(b!=0||a!=0){this.pan(b,a)}}}this.camera.refresh()};vxlTrackerInteractor.prototype.onKeyUp=function(a){if(a.keyCode==17){this.ctrlPressed=false}};vxlTrackerInteractor.prototype.onMouseUp=function(a){task=vxl.def.interactor.task.NONE;this.dragging=false};vxlTrackerInteractor.prototype.onMouseDown=function(a){this.x=a.clientX;this.y=a.clientY;this.lastClikedX=this.x;this.lastClickedY=this.y;
this.button=a.button;this.dragging=true};vxlTrackerInteractor.prototype.onMouseMove=function(a){this.lastX=this.x;this.lastY=this.y;this.x=a.clientX;this.y=a.clientY;if(!this.dragging){return}if(this.button!=0){return}this.ctrlPressed=a.ctrlKey;this.altPressed=a.altKey;this.shiftPressed=a.shiftKey;var c=this.x-this.lastX;var b=this.y-this.lastY;if(this.ctrlPressed&&!this.shiftPressed){this.dolly(b)}else{if(this.shiftPressed&&!this.ctrlPressed){this.pan(c,b)}else{if(this.ctrlPressed&&this.shiftPressed){this.roll(b)
}else{this.rotate(c,b)}}}this.camera.refresh()};vxlTrackerInteractor.prototype.onDragOver=function(a){a.stopPropagation();a.preventDefault();if(this.view.dragndrop){if(!this.dragndrop){this.bgcolor=this.view.backgroundColor.slice(0);this.dragndrop=true}a.dataTransfer.dropEffect="copy";this.view.setBackgroundColor(0,0.514,0.678)}};vxlTrackerInteractor.prototype.onDragLeave=function(a){a.stopPropagation();a.preventDefault();if(this.view.dragndrop){a.dataTransfer.dropEffect="copy";this.view.setBackgroundColor(this.bgcolor);
this.dragndrop=false}};vxlTrackerInteractor.prototype.onDrop=function(c){c.stopPropagation();c.preventDefault();if(!this.view.dragndrop){return}this.dragndrop=false;this.view.setBackgroundColor(this.bgcolor);var b=c.dataTransfer.files;var a=new vxlVTKReader(this.view.scene);if(a.isSupported()){a.read(b[0])}else{throw"vxlTrackerInteractor.drop: File API is not supported on this browser"}};vxlTrackerInteractor.prototype.onDoubleClick=function(a){this.camera.longShot()};vxlTrackerInteractor.prototype.dolly=function(a){this.task=vxl.def.interactor.task.DOLLY;
this.camera.dolly(a)};vxlTrackerInteractor.prototype.roll=function(d){this.task=vxl.def.interactor.task.ROLL;var b=this.camera.view.canvas;var a=-20/b.width;var c=d*a*this.MOTION_FACTOR;this.camera.rotate(0,0,c)};vxlTrackerInteractor.prototype.rotate=function(g,f){this.task=vxl.def.interactor.task.ROTATE;var c=this.camera.view.canvas;var b=-20/c.height;var a=-20/c.width;var e=g*b*this.MOTION_FACTOR;var d=f*a*this.MOTION_FACTOR;this.camera.rotate(e,d)};vxlTrackerInteractor.prototype.pan=function(j,i){this.task=vxl.def.interactor.task.PAN;
var e=this.camera;var a=e.view.canvas;var d=e.view.scene;this.dragndrop=false;var h=Math.max(a.width,a.height);var c=1/h;var b=1/h;var g=j*c*this.MOTION_FACTOR*d.bb.max();var f=-i*b*this.MOTION_FACTOR*d.bb.max();e.pan(g,f)};vxlPickerInteractor.prototype=new vxlViewInteractor();vxlPickerInteractor.prototype.constructor=vxlPickerInteractor;function vxlPickerInteractor(){vxlViewInteractor.call(this)}vxlPickerInteractor.prototype.getType=function(){return"vxlPickerInteractor"};vxlPickerInteractor.prototype.get2DCoords=function(c){var a,g,f=0,e=0,d=this.view.canvas;var b=d.getBoundingClientRect();a=c.clientX-b.left;g=vxl.c.view.canvas.height-(c.clientY-b.top);console.info("x="+a+", y="+g);return{x:a,y:g}};vxlPickerInteractor.prototype.onMouseUp=function(e){var a=this.view.renderer._renderTarget;
var f=this.get2DCoords(e);var b=a.readPixel(f);var c=vxl.go.picker.query(b);if(c==null){return}var d=this.view.scene.getActorByCellUID(c.uid);if(d!=null){console.info("vxlPickerInteractor: actor ["+d.name+"] has been picked");if(d.isPickable()){d._pickingCallback(d,c.uid)}}};vxlPickerInteractor.prototype.onMouseDown=function(a){};vxlViewInteractor.prototype.onMouseMove=function(a){};vxlViewInteractor.prototype.onKeyDown=function(a){};vxlViewInteractor.prototype.onKeyUp=function(a){};function vxlTransforms(a){this._stack=[];this.view=a;this.mvMatrix=mat4.identity();this.pMatrix=mat4.identity();this.nMatrix=mat4.identity();this.cMatrix=mat4.identity();this.mvpMatrix=mat4.identity()}vxlTransforms.prototype.calculateModelView=function(){mat4.set(this.view.cameraman.active.getViewTransform(),this.mvMatrix)};vxlTransforms.prototype.calculateNormal=function(){mat4.identity(this.nMatrix);mat4.set(this.mvMatrix,this.nMatrix);mat4.inverse(this.nMatrix);mat4.transpose(this.nMatrix)};vxlTransforms.prototype.calculatePerspective=function(){var b=this.view.cameraman.active;
var a=this.view;mat4.identity(this.pMatrix);mat4.perspective(b.FOV,a.width/a.height,b.Z_NEAR,b.Z_FAR,this.pMatrix)};vxlTransforms.prototype.calculateModelViewPerspective=function(){mat4.multiply(this.pMatrix,this.mvMatrix,this.mvpMatrix)};vxlTransforms.prototype.update=function(){this.calculateModelView();this.calculatePerspective();this.calculateNormal();this.calculateModelViewPerspective()};vxlTransforms.prototype.push=function(){var a=mat4.create();mat4.set(this.mvMatrix,a);this._stack.push(a)
};vxlTransforms.prototype.pop=function(){if(this._stack.length==0){return}this.mvMatrix=this._stack.pop();this.calculatePerspective();this.calculateNormal();this.calculateModelViewPerspective()};vxl.def.glsl.lambert={ID:"lambert",ATTRIBUTES:["aVertexPosition","aVertexColor","aVertexNormal","aVertexTextureCoords","aVertexPickingColor"],UNIFORMS:["mModelView","mNormal","mPerspective","mModelViewPerspective","uPointSize","uLightDirection","uLightAmbient","uLightDiffuse","uMaterialDiffuse","uUseVertexColors","uUseShading","uUseTextures","uUseLightTranslation","uSampler"],VERTEX_SHADER:["attribute vec3 aVertexPosition;","attribute vec3 aVertexNormal;","attribute vec3 aVertexColor;","attribute vec2 aVertexTextureCoords;","attribute vec3 aVertexPickingColor;","uniform float uPointSize;","uniform mat4 mModelView;","uniform mat4 mPerspective;","uniform mat4 mModelViewPerspective;","uniform mat4 mNormal;","uniform vec3 uLightDirection;","uniform vec4 uLightAmbient;","uniform vec4 uLightDiffuse;","uniform vec4 uMaterialDiffuse;","uniform bool uUseShading;","uniform bool uUseVertexColors;","uniform bool uUseLightTranslation;","uniform bool uUseTextures;","varying vec4 vFinalColor;","varying vec2 vTextureCoords;","void main(void) {","	gl_Position = mModelViewPerspective * vec4(aVertexPosition, 1.0);","	gl_PointSize = uPointSize;","	if (uUseVertexColors) {","		vFinalColor = vec4(aVertexColor,1.0);","	}","   else {","       vFinalColor = uMaterialDiffuse;","   }","	if (uUseShading){","		vec3 N = vec3(mNormal * vec4(aVertexNormal, 1.0));","		vec3 L = normalize(uLightDirection);","		if (uUseLightTranslation){ L = vec3(mNormal * vec4(L,1.0));}","		float lambertTerm = max(dot(N,-L),0.4);","		vec4 Ia = uLightAmbient;","		vec4 Id = vFinalColor * uLightDiffuse * lambertTerm;","		vFinalColor = Ia + Id;","		vFinalColor.a = uMaterialDiffuse.a;","	}","   if (uUseTextures){","       vTextureCoords = aVertexTextureCoords;","   }","}"].join("\n"),FRAGMENT_SHADER:["#ifdef GL_ES","precision highp float;","#endif","varying vec4      vFinalColor;","varying vec2      vTextureCoords;","uniform bool      uUseTextures;","uniform sampler2D uSampler;","void main(void)  {","   if (uUseTextures){","       gl_FragColor = texture2D(uSampler, vTextureCoords);","   }","   else{","		gl_FragColor = vFinalColor;","   }","}"].join("\n"),DEFAULTS:{uLightDirection:[0,0,-1],uLightAmbient:[0,0,0,1],uLightDiffuse:[1,1,1,1],uMaterialDiffuse:[0.9,0.9,0.9,1],uPointSize:1,uUseLightTranslation:false}};vxl.def.glsl.phong={ID:"phong",ATTRIBUTES:["aVertexPosition","aVertexNormal","aVertexColor","aVertexTextureCoords"],UNIFORMS:["mModelView","mNormal","mPerspective","mModelViewPerspective","uShininess","uPointSize","uLightDirection","uLightAmbient","uLightDiffuse","uLightSpecular","uMaterialAmbient","uMaterialDiffuse","uMaterialSpecular","uUseVertexColors","uUseShading","uUseLightTranslation","uUseTextures","uSampler"],VERTEX_SHADER:["attribute vec3 aVertexPosition;","attribute vec3 aVertexNormal;","attribute vec3 aVertexColor;","attribute vec2 aVertexTextureCoords;","uniform float uPointSize;","uniform mat4 mModelView;","uniform mat4 mPerspective;","uniform mat4 mModelViewPerspective;","uniform mat4 mNormal;","uniform bool uUseVertexColors;","varying vec3 vNormal;","varying vec3 vEyeVec;","varying vec4 vFinalColor;","varying vec2 vTextureCoords;","uniform bool uUseTextures;","void main(void) {","  gl_Position = mPerspective * mModelView * vec4(aVertexPosition, 1.0);","  gl_PointSize = uPointSize;","   if(uUseVertexColors) {","       vFinalColor = vec4(aVertexColor,1.0);","       return;","   }","   vec4 vertex = mModelView * vec4(aVertexPosition, 1.0);","   vNormal = vec3(mNormal * vec4(aVertexNormal, 1.0));","   vEyeVec = -vec3(vertex.xyz);","   if (uUseTextures){","       vTextureCoords = aVertexTextureCoords;","   }","}"].join("\n"),FRAGMENT_SHADER:["#ifdef GL_ES","precision highp float;","#endif","uniform bool uUseShading;","uniform bool uUseVertexColors;","uniform float uShininess;      ","uniform vec3 uLightDirection;  ","uniform vec4 uLightAmbient;    ","uniform vec4 uLightDiffuse;    ","uniform vec4 uLightSpecular;   ","uniform vec4 uMaterialAmbient; ","uniform vec4 uMaterialDiffuse; ","uniform vec4 uMaterialSpecular;","varying vec3 vNormal;","varying vec3 vEyeVec;","varying vec4 vFinalColor;","varying vec2      vTextureCoords;","uniform bool      uUseTextures;","uniform sampler2D uSampler;","void main(void)","{","  vec4 finalColor = vec4(0.0);","  vec3 L = normalize(uLightDirection);","  vec3 N = normalize(vNormal);","  float lambertTerm = dot(N,-L);","  vec4 Ia = uLightAmbient * uMaterialAmbient;","  vec4 Id = vec4(0.0,0.0,0.0,1.0);","  vec4 Is = vec4(0.0,0.0,0.0,1.0);","  vec4 varMaterialDiffuse = uMaterialDiffuse;","	if(uUseVertexColors) {","        varMaterialDiffuse = vFinalColor;","   }","  if(uUseShading){  ","      if(lambertTerm > 0.0)","      {","          Id = uLightDiffuse * varMaterialDiffuse * lambertTerm;","          vec3 E = normalize(vEyeVec);","          vec3 R = reflect(L, N);","          float specular = pow( max(dot(R, E), 0.0), uShininess);","          Is = uLightSpecular * uMaterialSpecular * specular;","      }","      finalColor = Ia + Id + Is;","      finalColor.a = uMaterialDiffuse.a;","  } ","  else {","      finalColor = varMaterialDiffuse; ","  }","   if (uUseTextures){","       finalColor =  texture2D(uSampler, vec2(vTextureCoords.s, vTextureCoords.t));","   }","   gl_FragColor = finalColor;","}"].join("\n"),DEFAULTS:{uShininess:230,uLightDirection:[0,-1,-1],uLightAmbient:[0.03,0.03,0.03,1],uLightDiffuse:[1,1,1,1],uLightSpecular:[1,1,1,1],uMaterialAmbient:[1,1,1,1],uMaterialDiffuse:[0.8,0.8,0.8,1],uMaterialSpecular:[1,1,1,1]}};vxl.def.glsl.blender={ID:"blender",ATTRIBUTES:["aVertexPosition","aVertexNormal"],UNIFORMS:["mModelView","mNormal","mPerspective","uLa","uLd","uLs","uLightPosition","uTranslateLight","uKa","uKd","uKs","uNs","d","illum"],VERTEX_SHADER:["attribute vec3 aVertexPosition;","attribute vec3 aVertexNormal;","uniform mat4 mModelView;","uniform mat4 mPerspective;","uniform mat4 mNormal;","uniform vec3 uLightPosition;","uniform bool uTranslateLight;","varying vec3 vNormal;","varying vec3 vLightRay;","varying vec3 vEye;","void main(void) {"," vec4 vertex = mModelView * vec4(aVertexPosition, 1.0);"," vNormal = vec3(mNormal * vec4(aVertexNormal, 1.0));"," vec4 lightPosition = vec4(0.0);","if (uTranslateLight){","      lightPosition =   mModelView * vec4(uLightPosition, 1.0);","      vLightRay = vertex.xyz - lightPosition.xyz;","      vEye = -vec3(vertex.xyz);","}","else {","     lightPosition = vec4(uLightPosition, 1.0);","     vLightRay = vertex.xyz - lightPosition.xyz;","     vEye = -vec3(vertex.xyz);","}","gl_Position = mPerspective * mModelView * vec4(aVertexPosition, 1.0);","}"].join("\n"),FRAGMENT_SHADER:["#ifdef GL_ES","precision highp float;","#endif","uniform vec3 uLa;","uniform vec3 uLd;","uniform vec3 uLs;","uniform vec3 uKa;","uniform vec3 uKd;","uniform vec3 uKs;","uniform float uNs;","uniform float d;","uniform int illum;","varying vec3 vNormal;","varying vec3 vLightRay;","varying vec3 vEye;","void main(void)  {","	if (illum ==0){","		gl_FragColor = vec4(uKd,d);","		return;","	}","	vec3 COLOR = vec3(0.0,0.0,0.0);","   vec3 N =  normalize(vNormal);","   vec3 L =  vec3(0.0,0.0,0.0);","   vec3 E =  vec3(0.0,0.0,0.0);","   vec3 R =  vec3(0.0,0.0,0.0);","    if (illum == 1){","        L = normalize(vLightRay);","        N = normalize(vNormal);","        COLOR += (uLa * uKa) + (uLd * uKd * clamp(dot(N, -L),0.0,1.0));","        gl_FragColor =  vec4(COLOR,d);","        return;","   }","   if (illum == 2){","        E = normalize(vEye);","        L = normalize(vLightRay);","        R = reflect(L, N);","        COLOR += (uLa * uKa);","        COLOR += (uLd * uKd * clamp(dot(N,-L),0.0,1.0));","        COLOR += (uLs * uKs * pow( max(dot(R, E), 0.0), uNs) * 4.0);","        gl_FragColor =  vec4(COLOR,d);","       return;","	}","}"].join("\n"),DEFAULTS:{uLa:[1,1,1],uLd:[1,1,1],uLs:[0.8,0.8,0.8],uKa:[1,1,1],uKd:[1,1,1],uKs:[1,1,1],uNs:1,uTranslateLight:false,uLightPosition:[0,50,50]}};vxl.def.glsl.bake={ID:"bake",ATTRIBUTES:["aVertexPosition","aVertexNormal","aVertexColor","aPosition","aScale","aUseShading"],UNIFORMS:["mModelView","mNormal","mPerspective","mModelViewPerspective","uLightDirection","uLightAmbient","uLightDiffuse","uUseLightTranslation"],VERTEX_SHADER:["attribute vec3 aVertexPosition;","attribute vec3 aVertexNormal;","attribute vec3 aVertexColor;","attribute vec3 aPosition;","attribute vec3 aScale;","attribute float aShading;","uniform mat4 mModelView;","uniform mat4 mPerspective;","uniform mat4 mNormal;","uniform mat4 mModelViewPerspective;","uniform vec3 uLightDirection;","uniform vec4 uLightAmbient;","uniform vec4 uLightDiffuse;","uniform bool uUseLightTranslation;","varying vec4 vFinalColor;","void main(void) {","   vec3 position = (aVertexPosition * aScale) + aPosition;","	gl_Position = mModelViewPerspective * vec4(position, 1.0);","   vFinalColor = vec4(aVertexColor,1.0);","   if (aShading == 1.0){","	   vec3 N = vec3(mNormal * vec4(aVertexNormal, 1.0));","	   vec3 L = normalize(uLightDirection);","	   if (uUseLightTranslation) { L = vec3(mNormal * vec4(L,1.0));}","	   float lambertTerm = max(dot(N,-L),0.4);","	   vec4 Ia = uLightAmbient;","	   vec4 Id = vFinalColor * uLightDiffuse * lambertTerm;","	   vFinalColor = Ia + Id;","	   vFinalColor.a = 1.0;","   }","}"].join("\n"),FRAGMENT_SHADER:["#ifdef GL_ES","precision highp float;","#endif","varying vec4  vFinalColor;","void main(void)  {","		gl_FragColor = vFinalColor;","}"].join("\n"),DEFAULTS:{uLightDirection:[0,0,-1],uLightAmbient:[0,0,0,1],uLightDiffuse:[1,1,1,1],uUseLightTranslation:false}};function vxlProgram(a){this._gl=a;this._codebase={};this._program={};this._attributeList={};this._enabledAttributes=[];this._uniformList={};this._uniformType={};this._uniform_cache={};this._currentWebGLProgram=null;this._currentProgramID="";this._currentUniformLocation={}}vxlProgram.prototype.register=function(a){vxl.go.console("Registering program "+a.ID);this._codebase[a.ID]=a};vxlProgram.prototype.isRegistered=function(a){return(this._codebase[a]!=undefined)};vxlProgram.prototype.loadProgram=function(b){var d=this._codebase[b];
var e=this._gl;var c=e.createProgram();if(d.VERTEX_SHADER){var f=this._createShader(vxl.def.glsl.VERTEX_SHADER,d.VERTEX_SHADER);e.attachShader(c,f)}if(d.FRAGMENT_SHADER){var a=this._createShader(vxl.def.glsl.FRAGMENT_SHADER,d.FRAGMENT_SHADER);e.attachShader(c,a)}e.linkProgram(c);if(!e.getProgramParameter(c,e.LINK_STATUS)){alert("Program: Could not link the shading program")}else{}this._program[b]=c};vxlProgram.prototype.isLoaded=function(a){return(this._program[a]!=undefined)};vxlProgram.prototype.useProgram=function(a){var c=this._gl;
var b=this._program[a];if(b!=undefined&&b!=null){if(b==this._currentWebGLProgram){return}c.useProgram(b);this._currentWebGLProgram=b;this._currentProgramID=a;this._parseUniforms()}else{alert("Program: the program "+a+" has NOT been loaded")}};vxlProgram.prototype.loadDefaults=function(){var b=this._codebase[this._currentProgramID];if("DEFAULTS" in b){var c=b.DEFAULTS;for(var a in c){this.setUniform(a,c[a])}}else{vxl.go.console("Program: WARNING: defaults for program "+this._currentProgramID+" NOT found")
}};vxlProgram.prototype.setUniforms=function(a){for(uni in a){this.setUniform(uni,a[uni])}};vxlProgram.prototype.setUniform=function(e,d,f){var b=this._currentWebGLProgram;var c=this._uniformList[this._currentProgramID];var a=this._currentUniformLocation;var g=this._uniform_cache;if(c.hasObject(e)){a[e]=this._gl.getUniformLocation(b,e)}else{throw ("Program: the uniform "+e+" is not defined for the program "+this._currentProgramID);return}g[e]=d;this._setPolymorphicUniform(e,a[e],d,f)};vxlProgram.prototype.getUniform=function(a){return this._uniform_cache[a]
};vxlProgram.prototype.setAttributePointer=function(d,b,f,e,g,h){var c=this._getAttributeLocation(d);this._gl.vertexAttribPointer(c,b,f,e,g,h)};vxlProgram.prototype.enableAttribute=function(c){if(this._enabledAttributes.indexOf(c)!=-1){return}var b=this._getAttributeLocation(c);this._gl.enableVertexAttribArray(b);this._enabledAttributes.push(c)};vxlProgram.prototype.disableAttribute=function(d){var b=this._enabledAttributes.indexOf(d);if(b!=-1){var c=this._getAttributeLocation(d);this._gl.disableVertexAttribArray(c);
this._enabledAttributes.splice(b,1)}};vxlProgram.prototype._createShader=function(a,c){var d=this._gl;var b=null;if(a==vxl.def.glsl.VERTEX_SHADER){b=d.createShader(d.VERTEX_SHADER)}else{if(a==vxl.def.glsl.FRAGMENT_SHADER){b=d.createShader(d.FRAGMENT_SHADER)}}if(c==undefined||c==null){alert("Error getting the code for shader of type "+a)}d.shaderSource(b,c);d.compileShader(b);if(!d.getShaderParameter(b,d.COMPILE_STATUS)){alert(d.getShaderInfoLog(b))}return b};vxlProgram.prototype._parseUniforms=function(d){vs=this._codebase[this._currentProgramID].VERTEX_SHADER;
fs=this._codebase[this._currentProgramID].FRAGMENT_SHADER;uNames=this._codebase[this._currentProgramID].UNIFORMS;uTypes={};for(var a=0;a<uNames.length;a++){var b=uNames[a];var c=new RegExp("uniform\\s+\\w+\\s"+b,"g");if(vs.search(c)!=-1){uTypes[b]=vs.substring(vs.search(c),vs.length).substring(0,vs.indexOf(";")).split(" ")[1]}else{if(fs.search(c)!=1){uTypes[b]=fs.substring(fs.search(c),fs.length).substring(0,fs.indexOf(";")).split(" ")[1]}else{alert("Program: In the program "+this._currentProgramID+" the uniform "+b+" is listed but not used")
}}}this._uniformList[this._currentProgramID]=uNames;this._uniformType[this._currentProgramID]=uTypes};vxlProgram.prototype._getAttributeLocation=function(a){if(!(a in this._attributeList)){this._attributeList[a]=this._gl.getAttribLocation(this._currentWebGLProgram,a)}return this._attributeList[a]};vxlProgram.prototype._setPolymorphicUniform=function(d,b,c,f){var e=this._gl;var a=this._uniformType[this._currentProgramID][d];if(a=="bool"){e.uniform1i(b,c);return}else{if(a=="float"){e.uniform1f(b,c);
return}else{if(a=="int"||a=="sampler2D"){e.uniform1i(b,c);return}else{if(a=="mat4"){e.uniformMatrix4fv(b,false,c);return}else{if(c instanceof Array){if(f=="int"){switch(c.length){case 1:e.uniform1iv(b,c);break;case 2:e.uniform2iv(b,c);break;case 3:e.uniform3iv(b,c);break;case 4:e.uniform4iv(b,c);break;default:alert("ERROR")}}else{switch(c.length){case 1:e.uniform1fv(b,c);break;case 2:e.uniform2fv(b,c);break;case 3:e.uniform3fv(b,c);break;case 4:e.uniform4fv(b,c);break;default:alert("ERROR")}}}else{alert("Program: ERROR. The uniform  "+d+" could not be mapped")
}}}}}};function vxlRenderer(a){this.view=a;this.renderRate=vxl.def.renderer.rate.NORMAL;this.mode=vxl.def.renderer.mode.TIMER;this.gl=this.getWebGLContext();this.prg=new vxlProgram(this.gl);this.transforms=new vxlTransforms(a);this.fps=0;this.currentProgram=undefined;this.strategy=undefined;this._time=0;this._startDate=0;this._running=false;this._clearColor=undefined;this._renderTarget=undefined;this.setProgram(vxl.def.glsl.lambert,vxlLambertStrategy)}vxlRenderer.prototype.getWebGLContext=function(){var a=null;
var b=this.view.canvas;this.width=b.width;this.height=b.height;var f=["webgl","experimental-webgl","webkit-3d","moz-webgl"];for(var c=0;c<f.length;++c){try{a=b.getContext(f[c])}catch(d){}if(a){break}}if(a==null){alert("Sorry: WebGL is not available on this browser. Have you tried the newest version of Firefox, Chrome or Safari?");return}else{this._initializeGLContext(a)}return a};vxlRenderer.prototype._initializeGLContext=function(a){a.enable(a.DEPTH_TEST);a.enable(a.BLEND);a.blendFunc(a.SRC_ALPHA,a.ONE_MINUS_SRC_ALPHA);
a.depthFunc(a.LESS);a.pixelStorei(a.UNPACK_FLIP_Y_WEBGL,true)};vxlRenderer.prototype.setProgram=function(a,c){if(this.currentProgram!=undefined&&this.currentProgram==a){return}var b=this.prg;if(!b.isRegistered(a.ID)){b.register(a)}if(!b.isLoaded(a.ID)){b.loadProgram(a.ID)}b.useProgram(a.ID);b.loadDefaults();this.currentProgram=a;this.setStrategy(c)};vxlRenderer.prototype.setStrategy=function(a){if(a!=null&&a!=undefined){this.strategy=new a(this)}else{if(this.strategy==undefined){this.strategy=new vxlLambertStrategy(this)
}}};vxlRenderer.prototype.clear=function(){this.gl.clear(this.gl.COLOR_BUFFER_BIT|this.gl.DEPTH_BUFFER_BIT);this.gl.viewport(0,0,this.view.canvas.width,this.view.canvas.height);this.transforms.calculatePerspective()};vxlRenderer.prototype.setMode=function(a){this.stop();this.mode=a;this.start()};vxlRenderer.prototype.start=function(){this._running=true;this._startDate=new Date().getTime();this._time=0;if(this.mode==vxl.def.renderer.mode.TIMER){vxl.go.console("Renderer: starting rendering for view ["+this.view.name+"] at "+this.renderRate+"ms");
this._timeUp()}else{if(this.mode==vxl.def.renderer.mode.ANIMFRAME){vxl.go.console("Renderer: starting rendering at the fastest speed",true);vxl.go.renderman.render()}}};vxlRenderer.prototype._timeUp=function(){if(!this._running){return}this.render();if(this._time==this.renderRate*100){this._time=0;this._startDate=new Date().getTime()}this._time+=this.renderRate;var a=(new Date().getTime()-this._startDate)-this._time;if(a>this.renderRate){a=0}setTimeout((function(b){return function(){b._timeUp()}})(this),this.renderRate-a)
};vxlRenderer.prototype.stop=function(){if(this.mode==vxl.def.renderer.mode.TIMER){this._running=false}else{if(this.mode==vxl.def.renderer.mode.ANIMFRAME){vxl.go.renderman.cancel()}}};vxlRenderer.prototype.setRenderRate=function(a){if(a==undefined||a<=0){throw"vxlRenderer.setRenderRate: the rate cannot be zero or undefined"}if(this.mode==vxl.def.renderer.mode.ANIMFRAME){throw"vxlRenderer.setRenderRate: if the mode is ANIMFRAME render rate is irrelevant"}this.stop();this.renderRate=a;this.start();
vxl.go.console("Renderer: view["+this.view.name+"], render rate = "+a,true)};vxlRenderer.prototype.clearColor=function(a){this._clearColor=a.slice(0);this.gl.clearColor(a[0],a[1],a[2],1)};vxlRenderer.prototype.clearDepth=function(a){this.gl.clearDepth(a)};vxlRenderer.prototype.render=function(){var c=this.strategy,b=this.view.scene,d=undefined,a=undefined;this.clear();c.allocate(b);d=new Date().getTime();c.render(b);a=new Date().getTime()-d;c.deallocate(b);if(a>0){this.fps=Math.round((this.fps*0.8+(1000/a)*0.2)*100)/100
}};vxlRenderer.prototype.reallocate=function(){this.strategy.allocate(this.view.scene)};vxlRenderer.prototype.disableOffscreen=function(){this.strategy.disableOffscreen()};vxlRenderer.prototype.enableOffscreen=function(){this._renderTarget=new vxlRenderTarget(this);this.strategy.enableOffscreen(this._renderTarget)};function vxlRenderTarget(a){this.canvas=a.view.canvas;this.texture=null;this.framebuffer=null;this.renderbuffer=null;this.gl=a.gl;this.configure()}vxlRenderTarget.prototype.configure=function(){var b=this.canvas.width;var a=this.canvas.height;var c=this.gl;this.texture=c.createTexture();c.bindTexture(c.TEXTURE_2D,this.texture);c.texImage2D(c.TEXTURE_2D,0,c.RGBA,b,a,0,c.RGBA,c.UNSIGNED_BYTE,null);this.renderbuffer=c.createRenderbuffer();c.bindRenderbuffer(c.RENDERBUFFER,this.renderbuffer);c.renderbufferStorage(c.RENDERBUFFER,c.DEPTH_COMPONENT16,b,a);
this.framebuffer=c.createFramebuffer();c.bindFramebuffer(c.FRAMEBUFFER,this.framebuffer);c.framebufferTexture2D(c.FRAMEBUFFER,c.COLOR_ATTACHMENT0,c.TEXTURE_2D,this.texture,0);c.framebufferRenderbuffer(c.FRAMEBUFFER,c.DEPTH_ATTACHMENT,c.RENDERBUFFER,this.renderbuffer);c.bindTexture(c.TEXTURE_2D,null);c.bindRenderbuffer(c.RENDERBUFFER,null);c.bindFramebuffer(c.FRAMEBUFFER,null)};vxlRenderTarget.prototype.update=function(){var c=this.gl;var b=this.canvas.width;var a=this.canvas.height;c.bindTexture(c.TEXTURE_2D,this.texture);
c.texImage2D(c.TEXTURE_2D,0,c.RGBA,b,a,0,c.RGBA,c.UNSIGNED_BYTE,null);c.bindRenderbuffer(c.RENDERBUFFER,this.renderbuffer);c.renderbufferStorage(c.RENDERBUFFER,c.DEPTH_COMPONENT16,b,a)};vxlRenderTarget.prototype.readPixel=function(b){var c=this.gl;var a=new Uint8Array(1*1*4);c.bindFramebuffer(c.FRAMEBUFFER,this.framebuffer);c.readPixels(b.x,b.y,1,1,c.RGBA,c.UNSIGNED_BYTE,a);c.bindFramebuffer(c.FRAMEBUFFER,null);return a};function vxlModel(a,b){this.name=a;this.indices=[];this.vertices=[];this.scalars=null;this.diffuse=null;this.normals=null;this.wireframe=null;this.centre=null;this.bb=null;this.mode=null;this.image=null;this.uri=null;this.colors=[];if(b!=undefined){this.load(this.name,b)}}vxlModel.BB_INDICES=[0,1,1,2,2,3,3,0,0,4,4,5,5,6,6,7,7,4,1,5,2,6,3,7];vxlModel.prototype.load=function(a,b){this.name=a.replace(/\.[^/.]+$/,"");if(b.name!=null){this.name=b.name}for(i in b){this[i]=b[i]}if(this.vertices==undefined){alert("The model "+this.name+" does not have vertices. Impossible to render!")
}if(this.normals==undefined&&this.indices!=undefined){this.computeNormals()}if(this.diffuse==undefined){this.diffuse=vxl.def.model.diffuse.slice(0)}if(this.wireframe==undefined){this.computeWireframeIndices()}if(this.mode==undefined){this.mode=vxl.def.actor.mode.SOLID}if(this.texture!=undefined){this.mode=vxl.def.actor.mode.TEXTURED}this.computeBoundingBox()};vxlModel.prototype.computeNormals=function(){var n=this.vertices;var a=this.indices;var k=0;var f=1;var e=2;var g=[];for(var b=0;b<n.length;
b=b+3){g[b+k]=0;g[b+f]=0;g[b+e]=0}for(var b=0;b<a.length;b=b+3){var l=[];var h=[];var d=[];l[k]=n[3*a[b+2]+k]-n[3*a[b+1]+k];l[f]=n[3*a[b+2]+f]-n[3*a[b+1]+f];l[e]=n[3*a[b+2]+e]-n[3*a[b+1]+e];h[k]=n[3*a[b]+k]-n[3*a[b+1]+k];h[f]=n[3*a[b]+f]-n[3*a[b+1]+f];h[e]=n[3*a[b]+e]-n[3*a[b+1]+e];d[k]=l[f]*h[e]-l[e]*h[f];d[f]=l[e]*h[k]-l[k]*h[e];d[e]=l[k]*h[f]-l[f]*h[k];for(j=0;j<3;j++){g[3*a[b+j]+k]=g[3*a[b+j]+k]+d[k];g[3*a[b+j]+f]=g[3*a[b+j]+f]+d[f];g[3*a[b+j]+e]=g[3*a[b+j]+e]+d[e]}}for(var b=0;b<n.length;b=b+3){var m=[];
m[k]=g[b+k];m[f]=g[b+f];m[e]=g[b+e];var c=Math.sqrt((m[k]*m[k])+(m[f]*m[f])+(m[e]*m[e]));if(c==0){c=1}m[k]=m[k]/c;m[f]=m[f]/c;m[e]=m[e]/c;g[b+k]=m[k];g[b+f]=m[f];g[b+e]=m[e]}this.normals=g};vxlModel.prototype.flipNormals=function(){var b=this.normals;if(b==undefined){return}for(var a=0;a<b.length;a+=1){b[a]=-b[a]}};vxlModel.prototype.computeWireframeIndices=function(){var d=this.indices;var c=[];var a=0;for(var b=0;b<d.length;b=b+3){c[a]=d[b];c[a+1]=d[b+1];c[a+2]=d[b+1];c[a+3]=d[b+2];c[a+4]=d[b+2];
c[a+5]=d[b];a=a+6}this.wireframe=c};vxlModel.prototype.computeBoundingBox=function(){if(this.vertices.length==0){this.bb=[0,0,0,0,0,0];this.centre=[0,0,0,0,0,0];return}var e=this.vertices;var a=[e[0],e[1],e[2],e[0],e[1],e[2]];for(var b=0;b<e.length;b=b+3){a[0]=Math.min(a[0],e[b]);a[1]=Math.min(a[1],e[b+1]);a[2]=Math.min(a[2],e[b+2]);a[3]=Math.max(a[3],e[b]);a[4]=Math.max(a[4],e[b+1]);a[5]=Math.max(a[5],e[b+2])}var d=[0,0,0];d[0]=(a[3]+a[0])/2;d[1]=(a[4]+a[1])/2;d[2]=(a[5]+a[2])/2;this.bb=a;this.centre=d
};vxlModel.prototype.getBoundingBoxVertices=function(){var a=this.bb;return[a[0],a[1],a[2],a[0],a[4],a[2],a[3],a[4],a[2],a[3],a[1],a[2],a[0],a[1],a[5],a[0],a[4],a[5],a[3],a[4],a[5],a[3],a[1],a[5]]};function vxlCell(a){this.UID=vxl.util.generateUID();this.color=vxl.go.picker.getColorFor(this);this.vertices=a;this.normal=undefined;this._calculateNormal()}vxlCell.prototype._calculateNormal=function(){var b=vec3.subtract(this.vertices[1],this.vertices[0],vec3.create());var a=vec3.subtract(this.vertices[2],this.vertices[0],vec3.create());this.normal=vec3.normalize(vec3.cross(b,a,vec3.create()))};vxlCell.prototype.getFlattenVertices=function(){var a=[];for(var b=0,c=this.vertices.length;b<c;b+=1){a=a.concat(this.vertices[b])
}return a};function vxlMesh(a){this.cells=[];this.indices=[];this.normals=[];this.renderable=undefined;this._init(a)}vxlMesh.prototype._init=function(d){var a=d.vertices;var e=d.indices;var b=this;function c(){var f=new Date().getTime();for(var g=0,k=e.length;g<k;g+=3){n=e[g];var h=[],m,l,j,n;m=a[n*3];l=a[n*3+1];j=a[n*3+2];h.push([m,l,j]);n=e[g+1];m=a[n*3];l=a[n*3+1];j=a[n*3+2];h.push([m,l,j]);n=e[g+2];m=a[n*3];l=a[n*3+1];j=a[n*3+2];h.push([m,l,j]);b.indices.push([e[g],e[g+1],e[g+2]]);b.cells.push(new vxlCell(h))
}for(var g=0,k=b.cells.length;g<k;g+=1){b.normals.push(b.cells[g]._normal)}b.renderable=b._getRenderable();var o=new Date().getTime()-f;console.info("Mesh ["+d.name+"] generated in "+o+" ms")}setTimeout(function(){c()},0)};vxlMesh.prototype._getRenderable=function(){var a=new vxlModel();for(var c=0,d=this.cells.length;c<d;c+=1){a.indices=a.indices.concat([c*3,c*3+1,c*3+2]);a.vertices=a.vertices.concat(this.cells[c].getFlattenVertices());for(var b=0;b<3;b+=1){a.colors=a.colors.concat(this.cells[c].color)
}}a.computeNormals();return a};vxlMesh.prototype.updateRenderableColors=function(){var d=this.renderable;d.colors=[];for(var b=0,c=this.cells.length;b<c;b+=1){for(var a=0;a<3;a+=1){d.colors=d.colors.concat(this.cells[b].color)}}};vxlMesh.prototype.hasCell=function(a){for(var b=0,c=this.cells.length;b<c;b+=1){if(this.cells[b].UID==a){return true}}return false};vxlMesh.prototype.getCell=function(a){for(var b=0,c=this.cells.length;b<c;b+=1){if(this.cells[b].UID==a){return this.cells[b]}}return null};
vxlMesh.prototype.removeCell=function(b){var a=-1;for(var c=0,d=this.cells.length;c<d;c+=1){if(this.cells[c].UID==b){a=c;break}}if(a!=-1){this.cells.splice(a,1)}};vxlMesh.prototype.intersect=function(c,d){var a=c._normal;selection=[];for(var b=0;b<this.normals.length;b+=1){var e=Math.acos(vec3.dot(a,this.normals[b]))*vxl.def.rad2deg;if(Math.abs(e)<=d){selection=selection.concat(this.indices[b])}}return selection};function vxlActor(a){this._bb=[0,0,0,0,0,0];this._position=vec3.create([0,0,0]);this._translation=vec3.create([0,0,0]);this._centre=vec3.create([0,0,0]);this._scale=vec3.create([1,1,1]);this._rotation=vec3.create([0,0,0]);this._matrix=mat4.identity();this._renderers=[];this._gl_buffers=[];this.visible=true;this.mode=vxl.def.actor.mode.SOLID;this.cull=vxl.def.actor.cull.NONE;this.opacity=1;this.clones=0;this.shading=true;this.texture=undefined;this.scene=undefined;this._trackingCameras=[];this._picking=vxl.def.actor.picking.DISABLED;
this._pickingCallback=undefined;this.mesh=undefined;if(a){this.model=a;this.name=a.name;this.color=a.color!=undefined?a.color:(a.diffuse!=undefined?a.diffuse:undefined);this.colors=a.colors!=undefined?a.colors:undefined;this.mode=a.mode;this._bb=a.bb.slice(0);this._centre=vec3.set(a.centre,vec3.create())}else{this.model=new vxlModel()}if(this.mode==vxl.def.actor.mode.TEXTURED){this.setTexture(this.model.path+this.model.texture)}var b=vxl.events;vxl.go.notifier.publish([b.ACTOR_MOVED,b.ACTOR_SCALED,b.ACTOR_ROTATED,b.ACTOR_CHANGED_COLOR,b.ACTOR_CHANGED_SHADING],this);
this.UID=vxl.util.generateUID()}vxlActor.prototype.setScene=function(a){this.scene=a};vxlActor.prototype.setPosition=function(b,e,d){var c=vxl.util.createVec3(b,e,d);vec3.subtract(c,this._position,this._translation);this._position=c;var a=this._matrix;a[12]=this._position[0];a[13]=this._position[1];a[14]=this._position[2];a[15]=1;this._computeBoundingBox();this._notifyTrackingCameras();vxl.go.notifier.fire(vxl.events.ACTOR_MOVED,this)};vxlActor.prototype.translate=function(b,d,c){this._translation=vxl.util.createVec3(b,d,c);
var a=this._matrix;mat4.translate(a,this._translation);this._position=vec3.createFrom(a[12],a[13],a[14]);this._computeBoundingBox();this._notifyTrackingCameras();vxl.go.notifier.fire(vxl.events.ACTOR_MOVED,this)};vxlActor.prototype.rotateX=function(d){var b=this._matrix;var c=vxl.util.deg2rad(vxl.util.getAngle(d));mat4.rotateX(b,c);this._computeBoundingBox();vxl.go.notifier.fire(vxl.events.ACTOR_ROTATED,this)};vxlActor.prototype.rotateY=function(d){var b=this._matrix;var c=vxl.util.deg2rad(vxl.util.getAngle(d));
mat4.rotateY(b,c);this._computeBoundingBox();vxl.go.notifier.fire(vxl.events.ACTOR_ROTATED,this)};vxlActor.prototype.rotateZ=function(d){var b=this._matrix;var c=vxl.util.deg2rad(vxl.util.getAngle(d));mat4.rotateZ(b,c);this._computeBoundingBox();vxl.go.notifier.fire(vxl.events.ACTOR_ROTATED,this)};vxlActor.prototype.setScale=function(f,e,d){if(f==0&&e==undefined&&d==undefined){return}if(typeof(f)=="number"&&e==undefined&&d==undefined){this._scale=vxl.util.createVec3(f,f,f)}else{this._scale=vxl.util.createVec3(f,e,d)
}var c=this._matrix;mat4.scale(c,this._scale);this._computeBoundingBox();vxl.go.notifier.fire(vxl.events.ACTOR_SCALED,this)};vxlActor.prototype.addTrackingCamera=function(a){if(a instanceof vxlCamera&&a.type!=vxl.def.camera.type.TRACKING){throw"vxlActor._addTrackingCamera ERROR: the selected camera is not set to tracking"}else{if(a instanceof vxlCamera){this._trackingCameras.push(a)}else{throw"vxlActor._addTrackingCamera ERROR: the object passed as a parameter is not a vxlCamera"}}};vxlActor.prototype.removeTrackingCamera=function(b){var a=this._trackingCameras.indexOf(b);
this._trackingCameras.splice(a,1)};vxlActor.prototype._notifyTrackingCameras=function(){for(var a=0,b=this._trackingCameras.length;a<b;a+=1){this._trackingCameras[a].updateWithActor(this)}};vxlActor.prototype._computeBoundingBox=function(){var f=this.model.vertices;var d=[];var c=this._matrix;for(var e=0;e<f.length;e=e+3){var a=vxl.util.createVec3(f[e],f[e+1],f[e+2]);mat4.multiplyVec3(c,a);d.push(a[0],a[1],a[2])}var b=[d[0],d[1],d[2],d[0],d[1],d[2]];for(var e=0;e<d.length;e=e+3){b[0]=Math.min(b[0],d[e]);
b[1]=Math.min(b[1],d[e+1]);b[2]=Math.min(b[2],d[e+2]);b[3]=Math.max(b[3],d[e]);b[4]=Math.max(b[4],d[e+1]);b[5]=Math.max(b[5],d[e+2])}this._bb=b};vxlActor.prototype.getBoundingBoxVertices=function(){var a=this._bb;return[a[0],a[1],a[2],a[0],a[4],a[2],a[3],a[4],a[2],a[3],a[1],a[2],a[0],a[1],a[5],a[0],a[4],a[5],a[3],a[4],a[5],a[3],a[1],a[5]]};vxlActor.prototype.getBoundingBox=function(){return this._bb.slice[0]};vxlActor.prototype.getHeight=function(){var a=this._bb;return a[4]-a[1]};vxlActor.prototype.setColor=function(d,c,a){this.color=vxl.util.createVec3(d,c,a);
vxl.go.notifier.fire(vxl.events.ACTOR_CHANGED_COLOR,this)};vxlActor.prototype.setOpacity=function(a){if(a>=0&&a<=1){this.opacity=a}else{throw"The opacity value is not valid"}};vxlActor.prototype.setTexture=function(a){this.texture=new vxlTexture(a)};vxlActor.prototype.setProperty=function(c,b,a){if(c=="position"){this.setPosition(b);return}if(c=="scale"){this.setScale(b);return}if(c=="color"){this.setColor(b);return}if(c=="shading"){this.setShading(b);return}if(c=="texture"){this.setTexture(b);return
}if(a==vxl.def.actor||a==undefined||a==null){this[c]=b;vxl.go.console("Actor: The actor "+this.name+" has been updated. ["+c+" = "+b+"]")}else{if(a==vxl.def.model){this.model[c]=b}else{throw ("vxlActor.setProperty. Scope:"+a+" is not valid")}}};vxlActor.prototype.setShading=function(a){this.shading=a;vxl.go.notifier.fire(vxl.events.ACTOR_CHANGED_SHADING,this)};vxlActor.prototype.getProperty=function(a){if(this.hasOwnProperty(a)){return this[a]}else{if(this.model.hasOwnProperty(a)){return this.model[a]
}else{return undefined}}};vxlActor.prototype.computePosition=function(){bb=this._bb;var a=this._position;a[0]=(bb[3]+bb[0])/2;a[1]=(bb[4]+bb[1])/2;a[2]=(bb[5]+bb[2])/2;a[0]=Math.round(a[0]*1000)/1000;a[1]=Math.round(a[1]*1000)/1000;a[2]=Math.round(a[2]*1000)/1000;return vec3.create(a)};vxlActor.prototype.setVisualizationMode=function(a){this.mode=a};vxlActor.prototype.cullFace=function(a){this.cull=a};vxlActor.prototype.setLookupTable=function(e,c,a){if(this.model.scalars==undefined){return}var b=this;
function d(f){var g=vxl.go.lookupTableManager.get(e);b.colors=g.getColors(b.model.scalars,c,a)}setTimeout(function(){d()},0)};vxlActor.prototype.flipNormals=function(){this.model.flipNormals()};vxlActor.prototype.setVisible=function(a){this.visible=a};vxlActor.prototype.isVisible=function(){return this.visible};vxlActor.prototype.clone=function(){this.clones++;var a=new vxlActor(this.model);a.setScene(this.scene);a.name+="-"+this.clones;return a};vxlActor.prototype.setPicker=function(a,b){this._picking=a;
if(a!=vxl.def.actor.picking.DISABLED){this._pickingCallback=b}else{this._pickingCallback=undefined}if(this._picking==vxl.def.actor.picking.CELL&&this.mesh==undefined){this.mesh=new vxlMesh(this.model)}};vxlActor.prototype.isPickable=function(){return(this._picking!=vxl.def.actor.picking.DISABLED)};function vxlPicker(){this._map={};this._colors=[]}vxlPicker.prototype._getColor=function(){function a(){var c=Math.floor(Math.random()*256);if(c==0){return a()}else{return c}}return[a(),a(),a()]};vxlPicker.prototype.color2decimal=function(a){r=Math.round((a[0]/256)*100)/100;g=Math.round((a[1]/256)*100)/100;b=Math.round((a[2]/256)*100)/100;return[r,g,b]};vxlPicker.prototype.getColorFor=function(e){var d=e.UID;if(d==null||d==undefined){alert("vxlPicker.getColor: invalid object");return}if(!this._map[d]){var a,c;
do{a=this._getColor();c=a[0]+":"+a[1]+":"+a[2]}while(this._colors.indexOf(c)!=-1);this._map[d]=a;this._colors.push(c)}return this.color2decimal(a)};vxlPicker.prototype.query=function(a){var i=100;var e=undefined;var d={};for(uid in this._map){var h=this._map[uid];var f=(Math.abs(h[0]-a[0])+Math.abs(h[1]-a[1])+Math.abs(h[2]-a[2]));if(f<i){i=f;e=uid}}if(i<=6){d.uid=e;d.distance=i;d.color=this._map[e];return d}else{return null}};vxl.go.picker=new vxlPicker();function vxlRenderStrategy(a){this.renderer=a}vxlRenderStrategy.prototype.allocate=function(a){};vxlRenderStrategy.prototype.deallocate=function(a){};vxlRenderStrategy.prototype.render=function(a){};vxlRenderStrategy.prototype.enableOffscreen=function(a){};vxlRenderStrategy.prototype.disableOffscreen=function(){};vxlBasicStrategy.prototype=new vxlRenderStrategy(undefined);vxlBasicStrategy.prototype.constructor=vxlBasicStrategy;function vxlBasicStrategy(a){vxlRenderStrategy.call(this,a);this._gl_buffers={};this._gl_textures={};if(a){var b=this.renderer.gl;b.enable(b.BLEND);b.blendFunc(b.SRC_ALPHA,b.ONE_MINUS_SRC_ALPHA);b.enable(b.DEPTH_TEST);b.depthFunc(b.LESS);b.clearDepth(1);b.disable(b.CULL_FACE)}}vxlBasicStrategy.prototype.allocate=function(d){var c=d._actors.concat(d.toys.list);var a=c.length;for(var b=0;
b<a;b+=1){this._allocateActor(c[b])}};vxlBasicStrategy.prototype.deallocate=function(a){};vxlBasicStrategy.prototype.render=function(a){alert("vxlBasicStrategy.render: abstract render method invoked")};vxlBasicStrategy.prototype._allocateActor=function(c){if(this._gl_buffers[c.UID]!=undefined){if(c.dirty){this._reallocateActor(c)}return}var d=this.renderer.gl;var b=c.model;var a={};a.vertex=d.createBuffer();if(b.indices!=undefined){a.index=d.createBuffer()}if(b.normals){a.normal=d.createBuffer()}if(b.scalars!=undefined||b.colors!=undefined){a.color=d.createBuffer()
}if(b.wireframe!=undefined){a.wireframe=d.createBuffer()}a.bb=d.createBuffer();if(b.texture){a.texcoords=d.createBuffer()}d.bindBuffer(d.ARRAY_BUFFER,null);d.bindBuffer(d.ELEMENT_ARRAY_BUFFER,null);this._gl_buffers[c.UID]=a;this._reallocateActor(c)};vxlBasicStrategy.prototype._reallocateActor=function(c){vxlRenderStrategy;var d=this.renderer.gl;var b=c.model;var a=this._gl_buffers[c.UID];d.bindBuffer(d.ARRAY_BUFFER,a.vertex);d.bufferData(d.ARRAY_BUFFER,new Float32Array(b.vertices),d.STATIC_DRAW);
if(b.indices!=undefined){d.bindBuffer(d.ARRAY_BUFFER,null);d.bindBuffer(d.ELEMENT_ARRAY_BUFFER,null);d.bindBuffer(d.ELEMENT_ARRAY_BUFFER,a.index);d.bufferData(d.ELEMENT_ARRAY_BUFFER,new Uint16Array(b.indices),d.STATIC_DRAW)}if(b.normals){d.bindBuffer(d.ARRAY_BUFFER,a.normal);d.bufferData(d.ARRAY_BUFFER,new Float32Array(b.normals),d.STATIC_DRAW)}if(b.scalars!=undefined||b.colors!=undefined){a.color=d.createBuffer()}if(b.wireframe!=undefined){d.bindBuffer(d.ELEMENT_ARRAY_BUFFER,a.wireframe);d.bufferData(d.ELEMENT_ARRAY_BUFFER,new Uint16Array(b.wireframe),d.STATIC_DRAW)
}d.bindBuffer(d.ARRAY_BUFFER,null);d.bindBuffer(d.ELEMENT_ARRAY_BUFFER,null);d.bindBuffer(d.ELEMENT_ARRAY_BUFFER,a.bb);d.bufferData(d.ELEMENT_ARRAY_BUFFER,new Uint16Array(vxlModel.BB_INDICES),d.STATIC_DRAW);if(b.texture){d.bindBuffer(d.ARRAY_BUFFER,a.texcoords);d.bufferData(d.ARRAY_BUFFER,new Float32Array(b.texcoords),d.STATIC_DRAW);this._gl_textures[c.UID]=d.createTexture();d.bindTexture(d.TEXTURE_2D,this._gl_textures[c.UID]);d.texImage2D(d.TEXTURE_2D,0,d.RGBA,d.RGBA,d.UNSIGNED_BYTE,c.texture.image);
d.generateMipmap(d.TEXTURE_2D);d.bindTexture(d.TEXTURE_2D,null)}d.bindBuffer(d.ARRAY_BUFFER,null);d.bindBuffer(d.ELEMENT_ARRAY_BUFFER,null)};vxlBasicStrategy.prototype._applyActorTransform=function(a){var d=this.renderer;var c=d.transforms;var b=d.prg;var e=vxl.def.glsl;c.push();mat4.multiply(c.mvMatrix,a._matrix);b.setUniform(e.MODEL_VIEW_MATRIX,d.transforms.mvMatrix);c.calculateModelViewPerspective();b.setUniform(e.MVP_MATRIX,d.transforms.mvpMatrix);c.calculateNormal();b.setUniform(e.NORMAL_MATRIX,d.transforms.nMatrix);
c.pop()};vxlBasicStrategy.prototype._applyGlobalTransform=function(){var c=this.renderer;var b=c.transforms;var a=c.prg;var d=vxl.def.glsl;a.setUniform(d.MODEL_VIEW_MATRIX,c.transforms.mvMatrix);b.calculateModelViewPerspective();a.setUniform(d.MVP_MATRIX,c.transforms.mvpMatrix);b.calculateNormal();a.setUniform(d.NORMAL_MATRIX,c.transforms.nMatrix)};vxlLambertStrategy.prototype=new vxlBasicStrategy(undefined);vxlLambertStrategy.prototype.constructor=vxlLambertStrategy;function vxlLambertStrategy(a){vxlBasicStrategy.call(this,a);this._offscreen=false;this._target=undefined;this._onPickingBuffer=false}vxlLambertStrategy.prototype.render=function(h){var b=this.renderer,e=b.transforms,d=b.prg,j=vxl.def.glsl,g=b.gl;e.calculatePerspective();e.calculateModelView();d.setUniform(j.PERSPECTIVE_MATRIX,e.pMatrix);var a=h._actors.concat(h.toys.list);var c=a.length;
if(h.frameAnimation!=undefined){h.frameAnimation.update()}this._handlePicking(h._actors);for(var f=0;f<c;f+=1){this._renderActor(a[f])}};vxlLambertStrategy.prototype._handlePicking=function(c){if(this._target==undefined){return}if(this._offscreen){var d=this.renderer.gl;this._onPickingBuffer=true;d.bindFramebuffer(d.FRAMEBUFFER,this._target.framebuffer);d.clear(d.COLOR_BUFFER_BIT|d.DEPTH_BUFFER_BIT);d.clearColor(0,0,0,1);for(var b=0,a=c.length;b<a;b+=1){if(c[b].isPickable()){this._renderActor(c[b])
}}this._onPickingBuffer=false;d.bindFramebuffer(d.FRAMEBUFFER,null);var e=this.renderer._clearColor;this.renderer.clearColor(e)}};vxlLambertStrategy.prototype._enableNormals=function(c){var b=c.model;var g=this.renderer.gl;var e=this.renderer.prg;var a=this._gl_buffers[c.UID];var f=vxl.def.glsl;if(b.normals&&c.shading){try{g.bindBuffer(g.ARRAY_BUFFER,a.normal);g.bufferData(g.ARRAY_BUFFER,new Float32Array(b.normals),g.STATIC_DRAW);e.enableAttribute(f.NORMAL_ATTRIBUTE);e.setAttributePointer(f.NORMAL_ATTRIBUTE,3,g.FLOAT,false,0,0)
}catch(d){alert("There was a problem while rendering the actor ["+c.name+"]. The problem happened while handling the normal buffer. Error ="+d.description);throw ("There was a problem while rendering the actor ["+c.name+"]. The problem happened while handling the normal buffer. Error ="+d.description)}}};vxlLambertStrategy.prototype._enableColors=function(c){var b=c.model;var g=this.renderer.gl;var e=this.renderer.prg;var a=this._gl_buffers[c.UID];var f=vxl.def.glsl;if(c.colors&&c.colors.length==c.model.vertices.length){try{e.setUniform("uUseVertexColors",true);
g.bindBuffer(g.ARRAY_BUFFER,a.color);g.bufferData(g.ARRAY_BUFFER,new Float32Array(c.colors),g.STATIC_DRAW);e.enableAttribute(f.COLOR_ATTRIBUTE);e.setAttributePointer(f.COLOR_ATTRIBUTE,3,g.FLOAT,false,0,0)}catch(d){alert("There was a problem while rendering the actor ["+c.name+"]. The problem happened while handling the color buffer. Error ="+d.description);throw ("There was a problem while rendering the actor ["+c.name+"]. The problem happened while handling the color buffer. Error ="+d.description)
}}};vxlLambertStrategy.prototype._renderSolid=function(b){var a=this._gl_buffers[b.UID];var c=this.renderer.gl;this._enableNormals(b);this._enableColors(b);c.bindBuffer(c.ELEMENT_ARRAY_BUFFER,a.index);c.bufferData(c.ELEMENT_ARRAY_BUFFER,new Uint16Array(b.model.indices),c.STATIC_DRAW);c.drawElements(c.TRIANGLES,b.model.indices.length,c.UNSIGNED_SHORT,0)};vxlLambertStrategy.prototype._renderWireframe=function(b){var a=this._gl_buffers[b.UID];var e=this.renderer.gl;var c=this.renderer.prg;var d=vxl.def.glsl;
this._enableNormals(b);if(b.name=="floor"){c.disableAttribute(d.NORMAL_ATTRIBUTE)}e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,a.wireframe);e.bufferData(e.ELEMENT_ARRAY_BUFFER,new Uint16Array(b.model.wireframe),e.STATIC_DRAW);e.drawElements(e.LINES,b.model.wireframe.length,e.UNSIGNED_SHORT,0)};vxlLambertStrategy.prototype._renderPoints=function(b){var a=b.model;var e=this.renderer.gl;var c=this.renderer.prg;var d=vxl.def.glsl;c.setUniform("uUseShading",false);c.setUniform("uPointSize",5);e.drawArrays(e.POINTS,0,a.vertices.length/3)
};vxlLambertStrategy.prototype._renderLines=function(b){var a=this._gl_buffers[b.UID];var e=this.renderer.gl;var c=this.renderer.prg;var d=vxl.def.glsl;c.setUniform("uUseShading",false);e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,a.index);e.drawElements(e.LINES,b.model.indices.length,e.UNSIGNED_SHORT,0)};vxlLambertStrategy.prototype._renderBoundingBox=function(b){var a=this._gl_buffers[b.UID];var e=this.renderer.gl;var c=this.renderer.prg;var d=vxl.def.glsl;c.disableAttribute(d.NORMAL_ATTRIBUTE);c.setUniform("uUseShading",false);
e.bindBuffer(e.ARRAY_BUFFER,a.vertex);e.bufferData(e.ARRAY_BUFFER,new Float32Array(b.getBoundingBoxVertices()),e.STATIC_DRAW);e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,a.bb);e.drawElements(e.LINES,vxlModel.BB_INDICES.length,e.UNSIGNED_SHORT,0)};vxlLambertStrategy.prototype._renderBoundingBoxAndSolid=function(c){var b=c.model;var a=this._gl_buffers[c.UID];var f=this.renderer.gl;var d=this.renderer.prg;var e=vxl.def.glsl;this._renderSolid(c);this._applyGlobalTransform();d.disableAttribute(e.NORMAL_ATTRIBUTE);
d.setUniform("uUseShading",false);f.bindBuffer(f.ARRAY_BUFFER,a.vertex);f.bufferData(f.ARRAY_BUFFER,new Float32Array(c.getBoundingBoxVertices()),f.STATIC_DRAW);f.bindBuffer(f.ELEMENT_ARRAY_BUFFER,a.bb);f.drawElements(f.LINES,vxlModel.BB_INDICES.length,f.UNSIGNED_SHORT,0)};vxlLambertStrategy.prototype._renderWiredAndSolid=function(c){var b=c.model;var a=this._gl_buffers[c.UID];var f=this.renderer.gl;var d=this.renderer.prg;var e=vxl.def.glsl;this._renderSolid(c);d.setUniform("uUseShading",false);d.setUniform("uMaterialDiffuse",[0.9,0.9,0.9,1]);
d.disableAttribute(e.NORMAL_ATTRIBUTE);f.bindBuffer(f.ELEMENT_ARRAY_BUFFER,a.wireframe);f.bufferData(f.ELEMENT_ARRAY_BUFFER,new Uint16Array(b.wireframe),f.STATIC_DRAW);f.drawElements(f.LINES,b.wireframe.length,f.UNSIGNED_SHORT,0)};vxlLambertStrategy.prototype._renderFlat=function(c){var b=c.model;var a=this._gl_buffers[c.UID];var f=this._gl_textures[c.UID];var h=this.renderer.gl;var e=this.renderer.prg;var g=vxl.def.glsl;if(c.mesh==undefined){c.mesh=new vxlMesh(c.model)}r=c.mesh.renderable;if(r==undefined){return
}e.setUniform("uUseShading",true);try{h.bindBuffer(h.ARRAY_BUFFER,a.normal);h.bufferData(h.ARRAY_BUFFER,new Float32Array(r.normals),h.STATIC_DRAW);e.enableAttribute(g.NORMAL_ATTRIBUTE);e.setAttributePointer(g.NORMAL_ATTRIBUTE,3,h.FLOAT,false,0,0)}catch(d){alert("There was a problem while rendering the actor ["+c.name+"]. The problem happened while handling the normal buffer. Error ="+d.description);throw ("There was a problem while rendering the actor ["+c.name+"]. The problem happened while handling the normal buffer. Error ="+d.description)
}try{h.bindBuffer(h.ARRAY_BUFFER,a.vertex);h.bufferData(h.ARRAY_BUFFER,new Float32Array(r.vertices),h.STATIC_DRAW);e.setAttributePointer(g.VERTEX_ATTRIBUTE,3,h.FLOAT,false,0,0)}catch(d){alert("There was a problem while rendering the actor ["+c.name+"]. The problem happened while handling the vertex buffer. Error ="+d.description);throw ("There was a problem while rendering the actor ["+c.name+"]. The problem happened while handling the vertex buffer. Error ="+d.description)}e.setUniform("uUseVertexColors",false);
h.bindBuffer(h.ELEMENT_ARRAY_BUFFER,a.index);h.bufferData(h.ELEMENT_ARRAY_BUFFER,new Uint16Array(r.indices),h.STATIC_DRAW);h.drawElements(h.TRIANGLES,r.indices.length,h.UNSIGNED_SHORT,0)};vxlLambertStrategy.prototype._renderPickingBuffer=function(c){var b=c.model;var a=this._gl_buffers[c.UID];var f=this._gl_textures[c.UID];var h=this.renderer.gl;var e=this.renderer.prg;var g=vxl.def.glsl;if(c.mesh==undefined){c.mesh=new vxlMesh(c.model)}r=c.mesh.renderable;if(r==undefined){return}e.setUniform("uUseShading",false);
try{h.bindBuffer(h.ARRAY_BUFFER,a.vertex);h.bufferData(h.ARRAY_BUFFER,new Float32Array(r.vertices),h.STATIC_DRAW);e.setAttributePointer(g.VERTEX_ATTRIBUTE,3,h.FLOAT,false,0,0)}catch(d){alert("There was a problem while rendering the actor ["+c.name+"]. The problem happened while handling the vertex buffer. Error ="+d.description);throw ("There was a problem while rendering the actor ["+c.name+"]. The problem happened while handling the vertex buffer. Error ="+d.description)}if(b.colors&&r.colors.length==r.vertices.length){try{e.setUniform("uUseVertexColors",true);
h.bindBuffer(h.ARRAY_BUFFER,a.color);h.bufferData(h.ARRAY_BUFFER,new Float32Array(r.colors),h.STATIC_DRAW);e.enableAttribute(g.COLOR_ATTRIBUTE);e.setAttributePointer(g.COLOR_ATTRIBUTE,3,h.FLOAT,false,0,0)}catch(d){alert("There was a problem while rendering the actor ["+c.name+"]. The problem happened while handling the color buffer. Error ="+d.description);throw ("There was a problem while rendering the actor ["+c.name+"]. The problem happened while handling the color buffer. Error ="+d.description)
}}h.bindBuffer(h.ELEMENT_ARRAY_BUFFER,a.index);h.bufferData(h.ELEMENT_ARRAY_BUFFER,new Uint16Array(r.indices),h.STATIC_DRAW);h.drawElements(h.TRIANGLES,r.indices.length,h.UNSIGNED_SHORT,0);h.bindBuffer(h.ARRAY_BUFFER,null);h.bindBuffer(h.ELEMENT_ARRAY_BUFFER,null)};vxlLambertStrategy.prototype._renderTextured=function(c){var b=c.model;var a=this._gl_buffers[c.UID];var f=this._gl_textures[c.UID];var h=this.renderer.gl;var e=this.renderer.prg;var g=vxl.def.glsl;if(b.texcoords){try{e.setUniform("uUseTextures",true);
h.bindBuffer(h.ARRAY_BUFFER,a.texcoords);h.bufferData(h.ARRAY_BUFFER,new Float32Array(b.texcoords),h.STATIC_DRAW);e.setAttributePointer(g.TEXCOORD_ATTRIBUTE,2,h.FLOAT,false,0,0);e.enableAttribute(g.TEXCOORD_ATTRIBUTE)}catch(d){alert("There was a problem while rendering the actor ["+c.name+"]. The problem happened while handling the texture buffer. Error ="+d.description);throw ("There was a problem while rendering the actor ["+c.name+"]. The problem happened while handling the texture buffer. Error ="+d.description)
}}else{throw ("error")}h.activeTexture(h.TEXTURE0);h.bindTexture(h.TEXTURE_2D,f);h.texParameteri(h.TEXTURE_2D,h.TEXTURE_WRAP_S,h.CLAMP_TO_EDGE);h.texParameteri(h.TEXTURE_2D,h.TEXTURE_WRAP_T,h.CLAMP_TO_EDGE);h.texParameteri(h.TEXTURE_2D,h.TEXTURE_MAG_FILTER,c.texture.getMagFilter(h));h.texParameteri(h.TEXTURE_2D,h.TEXTURE_MIN_FILTER,c.texture.getMinFilter(h));e.setUniform("uSampler",0);h.bindBuffer(h.ELEMENT_ARRAY_BUFFER,a.index);h.drawElements(h.TRIANGLES,b.indices.length,h.UNSIGNED_SHORT,0)};vxlLambertStrategy.prototype._handleCulling=function(a){var b=this.renderer.gl;
b.disable(b.CULL_FACE);if(a.cull!=vxl.def.actor.cull.NONE){b.enable(b.CULL_FACE);switch(a.cull){case vxl.def.actor.cull.BACK:b.cullFace(b.BACK);break;case vxl.def.actor.cull.FRONT:b.cullFace(b.FRONT);break}}};vxlLambertStrategy.prototype._renderActor=function(c){if(!c.visible){return}if(this._renderpass==true&&c.name=="floor"){return}var e=c.model;var j=this._gl_buffers[c.UID];var g=this._gl_textures[c.UID];var d=this.renderer.gl;var a=this.renderer.prg;var h=vxl.def.glsl;var i=[c.color[0],c.color[1],c.color[2],c.opacity];
a.disableAttribute(h.TEXCOORD_ATTRIBUTE);a.disableAttribute(h.COLOR_ATTRIBUTE);a.disableAttribute(h.NORMAL_ATTRIBUTE);a.disableAttribute(h.PICKING_COLOR_ATTRIBUTE);a.enableAttribute(h.VERTEX_ATTRIBUTE);a.setUniform("uUseVertexColors",false);a.setUniform("uUseTextures",false);a.setUniform("uUseShading",c.shading);a.setUniform("uMaterialDiffuse",i);this._handleCulling(c);this._applyActorTransform(c);if(this._onPickingBuffer){this._renderPickingBuffer(c);return}if(c.mode!=vxl.def.actor.mode.FLAT){try{d.bindBuffer(d.ARRAY_BUFFER,j.vertex);
d.bufferData(d.ARRAY_BUFFER,new Float32Array(e.vertices.slice(0)),d.STATIC_DRAW);a.setAttributePointer(h.VERTEX_ATTRIBUTE,3,d.FLOAT,false,0,0)}catch(b){alert("There was a problem while rendering the actor ["+c.name+"]. The problem happened while handling the vertex buffer. Error ="+b.description);throw ("There was a problem while rendering the actor ["+c.name+"]. The problem happened while handling the vertex buffer. Error ="+b.description)}}var f=vxl.def.actor.mode;switch(c.mode){case f.SOLID:this._renderSolid(c);
break;case f.WIREFRAME:this._renderWireframe(c);break;case f.POINTS:this._renderPoints(c);break;case f.LINES:this._renderLines(c);break;case f.BOUNDING_BOX:this._renderBoundingBox(c);break;case f.BB_AND_SOLID:this._renderBoundingBoxAndSolid(c);break;case f.WIRED_AND_SOLID:this._renderWiredAndSolid(c);break;case f.FLAT:this._renderFlat(c);break;case f.TEXTURED:this._renderTextured(c);break;default:alert("There was a problem while rendering the actor ["+c.name+"]. The visualization mode: "+c.mode+" is not valid.");
throw ("There was a problem while rendering the actor ["+c.name+"]. The visualization mode: "+c.mode+" is not valid.")}d.bindBuffer(d.ARRAY_BUFFER,null);d.bindBuffer(d.ELEMENT_ARRAY_BUFFER,null)};vxlLambertStrategy.prototype.enableOffscreen=function(a){this._offscreen=true;this._target=a};vxlLambertStrategy.prototype.disableOffscreen=function(){this._offscreen=false;this._target=undefined};vxlPhongStrategy.prototype=new vxlBasicStrategy(undefined);vxlPhongStrategy.prototype.constructor=vxlPhongStrategy;function vxlPhongStrategy(a){vxlBasicStrategy.call(this,a);this._gl_buffers={};if(a){var b=this.renderer.gl;b.enable(b.BLEND);b.blendFunc(b.SRC_ALPHA,b.ONE_MINUS_SRC_ALPHA);b.enable(b.DEPTH_TEST);b.depthFunc(b.LESS);b.clearDepth(1);b.disable(b.CULL_FACE)}}vxlPhongStrategy.prototype.render=function(h){var e=this.renderer;var d=e.transforms;var c=e.prg;var g=vxl.def.glsl;d.calculatePerspective();
d.calculateModelView();c.setUniform(g.PERSPECTIVE_MATRIX,d.pMatrix);var f=h._actors.concat(h.toys.list);var a=f.length;if(h.frameAnimation!=undefined){h.frameAnimation.update()}for(var b=0;b<a;b+=1){this._renderActor(f[b])}};vxlPhongStrategy.prototype._renderActor=function(e){if(!e.visible){return}var g=e.model;var k=this._gl_buffers[e.UID];var h=this._gl_textures[e.UID];var a=this.renderer;var f=a.gl;var b=a.prg;var d=a.transforms;var i=vxl.def.glsl;f.disable(f.CULL_FACE);if(e.cull!=vxl.def.actor.cull.NONE){f.enable(f.CULL_FACE);
switch(e.cull){case vxl.def.actor.cull.BACK:f.cullFace(f.BACK);break;case vxl.def.actor.cull.FRONT:f.cullFace(f.FRONT);break}}if(e.mode!=vxl.def.actor.mode.BOUNDING_BOX&&e.mode!=vxl.def.actor.mode.BB_AND_SOLID){this._applyActorTransform(e)}var j=[e.color[0],e.color[1],e.color[2],1];if(e.opacity<1){j[3]=e.opacity}else{j[3]=1}b.setUniform("uMaterialDiffuse",j);b.setUniform("uUseVertexColors",false);if(e.mode==vxl.def.actor.mode.TEXTURED){b.setUniform("uUseTextures",true);b.enableAttribute(i.TEXCOORD_ATTRIBUTE)
}else{b.setUniform("uUseTextures",false);b.disableAttribute(i.TEXCOORD_ATTRIBUTE)}b.disableAttribute(i.COLOR_ATTRIBUTE);b.disableAttribute(i.NORMAL_ATTRIBUTE);b.enableAttribute(i.VERTEX_ATTRIBUTE);try{f.bindBuffer(f.ARRAY_BUFFER,k.vertex);f.bufferData(f.ARRAY_BUFFER,new Float32Array(g.vertices.slice(0)),f.STATIC_DRAW);b.setAttributePointer(i.VERTEX_ATTRIBUTE,3,f.FLOAT,false,0,0)}catch(c){alert("There was a problem while rendering the actor ["+e.name+"]. The problem happened while handling the vertex buffer. Error ="+c.description);
throw ("There was a problem while rendering the actor ["+e.name+"]. The problem happened while handling the vertex buffer. Error ="+c.description)}if(e.colors){try{b.setUniform("uUseVertexColors",true);f.bindBuffer(f.ARRAY_BUFFER,k.color);f.bufferData(f.ARRAY_BUFFER,new Float32Array(e.colors.slice(0)),f.STATIC_DRAW);b.enableAttribute(i.COLOR_ATTRIBUTE);b.setAttributePointer(i.COLOR_ATTRIBUTE,3,f.FLOAT,false,0,0)}catch(c){alert("There was a problem while rendering the actor ["+e.name+"]. The problem happened while handling the color buffer. Error ="+c.description);
throw ("There was a problem while rendering the actor ["+e.name+"]. The problem happened while handling the color buffer. Error ="+c.description)}}if(g.normals){try{f.bindBuffer(f.ARRAY_BUFFER,k.normal);f.bufferData(f.ARRAY_BUFFER,new Float32Array(g.normals.slice(0)),f.STATIC_DRAW);b.enableAttribute(i.NORMAL_ATTRIBUTE);b.setAttributePointer(i.NORMAL_ATTRIBUTE,3,f.FLOAT,false,0,0)}catch(c){alert("There was a problem while rendering the actor ["+e.name+"]. The problem happened while handling the normal buffer. Error ="+c.description);
throw ("There was a problem while rendering the actor ["+e.name+"]. The problem happened while handling the normal buffer. Error ="+c.description)}}if(g.texcoords&&e.mode==vxl.def.actor.mode.TEXTURED){try{f.bindBuffer(f.ARRAY_BUFFER,k.texcoords);f.bufferData(f.ARRAY_BUFFER,new Float32Array(g.texcoords),f.STATIC_DRAW);b.enableAttribute(i.TEXCOORD_ATTRIBUTE);b.setAttributePointer(i.TEXCOORD_ATTRIBUTE,2,f.FLOAT,false,0,0)}catch(c){alert("There was a problem while rendering the actor ["+e.name+"]. The problem happened while handling the texture buffer. Error ="+c.description);
throw ("There was a problem while rendering the actor ["+e.name+"]. The problem happened while handling the texture buffer. Error ="+c.description)}}b.setUniform("uUseShading",e.shading);try{if(e.mode==vxl.def.actor.mode.SOLID){b.enableAttribute(i.NORMAL_ATTRIBUTE);f.bindBuffer(f.ELEMENT_ARRAY_BUFFER,k.index);f.drawElements(f.TRIANGLES,g.indices.length,f.UNSIGNED_SHORT,0)}else{if(e.mode==vxl.def.actor.mode.TEXTURED){b.enableAttribute(i.TEXCOORD_ATTRIBUTE);f.activeTexture(f.TEXTURE0);f.bindTexture(f.TEXTURE_2D,h);
f.texParameteri(f.TEXTURE_2D,f.TEXTURE_WRAP_S,f.CLAMP_TO_EDGE);f.texParameteri(f.TEXTURE_2D,f.TEXTURE_WRAP_T,f.CLAMP_TO_EDGE);f.texParameteri(f.TEXTURE_2D,f.TEXTURE_MAG_FILTER,e.texture.getMagFilter(f));f.texParameteri(f.TEXTURE_2D,f.TEXTURE_MIN_FILTER,e.texture.getMinFilter(f));b.setUniform("uSampler",0);f.bindBuffer(f.ELEMENT_ARRAY_BUFFER,k.index);f.drawElements(f.TRIANGLES,g.indices.length,f.UNSIGNED_SHORT,0)}else{if(e.mode==vxl.def.actor.mode.WIREFRAME){if(e.name=="floor"){b.disableAttribute(i.NORMAL_ATTRIBUTE)
}f.bindBuffer(f.ELEMENT_ARRAY_BUFFER,k.wireframe);f.bufferData(f.ELEMENT_ARRAY_BUFFER,new Uint16Array(g.wireframe),f.STATIC_DRAW);f.drawElements(f.LINES,g.wireframe.length,f.UNSIGNED_SHORT,0)}else{if(e.mode==vxl.def.actor.mode.BOUNDING_BOX){b.disableAttribute(i.NORMAL_ATTRIBUTE);b.setUniform("uUseShading",false);f.bindBuffer(f.ARRAY_BUFFER,k.vertex);f.bufferData(f.ARRAY_BUFFER,new Float32Array(e.getBoundingBoxVertices()),f.STATIC_DRAW);f.bindBuffer(f.ELEMENT_ARRAY_BUFFER,k.bb);f.drawElements(f.LINES,vxlModel.BB_INDICES.length,f.UNSIGNED_SHORT,0)
}else{if(e.mode==vxl.def.actor.mode.BB_AND_SOLID){this._applyActorTransform(e);b.enableAttribute(i.NORMAL_ATTRIBUTE);b.setUniform("uUseShading",e.shading);f.bindBuffer(f.ELEMENT_ARRAY_BUFFER,k.index);f.drawElements(f.TRIANGLES,g.indices.length,f.UNSIGNED_SHORT,0);this._applyGlobalTransform();b.disableAttribute(i.NORMAL_ATTRIBUTE);b.setUniform("uUseShading",false);f.bindBuffer(f.ARRAY_BUFFER,k.vertex);f.bufferData(f.ARRAY_BUFFER,new Float32Array(e.getBoundingBoxVertices()),f.STATIC_DRAW);f.bindBuffer(f.ELEMENT_ARRAY_BUFFER,k.bb);
f.drawElements(f.LINES,vxlModel.BB_INDICES.length,f.UNSIGNED_SHORT,0)}else{if(e.mode==vxl.def.actor.mode.WIRED_AND_SOLID){b.enableAttribute(i.NORMAL_ATTRIBUTE);b.setUniform("uUseShading",e.shading);f.bindBuffer(f.ELEMENT_ARRAY_BUFFER,k.index);f.drawElements(f.TRIANGLES,g.indices.length,f.UNSIGNED_SHORT,0);b.setUniform("uUseShading",false);b.setUniform("uMaterialDiffuse",[0.9,0.9,0.9,1]);b.disableAttribute(i.NORMAL_ATTRIBUTE);f.bindBuffer(f.ELEMENT_ARRAY_BUFFER,k.wireframe);f.bufferData(f.ELEMENT_ARRAY_BUFFER,new Uint16Array(g.wireframe),f.STATIC_DRAW);
f.drawElements(f.LINES,g.wireframe.length,f.UNSIGNED_SHORT,0)}else{if(e.mode==vxl.def.actor.mode.POINTS){b.setUniform("uUseShading",true);b.enableAttribute(i.NORMAL_ATTRIBUTE);f.drawArrays(f.POINTS,0,this.model.vertices.length/3)}else{if(e.mode==vxl.def.actor.mode.LINES){b.setUniform("uUseShading",false);b.disableAttribute(i.NORMAL_ATTRIBUTE);f.bindBuffer(f.ELEMENT_ARRAY_BUFFER,k.index);f.drawElements(f.LINES,e.model.indices.length,f.UNSIGNED_SHORT,0)}else{alert("There was a problem while rendering the actor ["+e.name+"]. The visualization mode: "+e.mode+" is not valid.");
throw ("There was a problem while rendering the actor ["+e.name+"]. The visualization mode: "+e.mode+" is not valid.")}}}}}}}}f.bindBuffer(f.ARRAY_BUFFER,null);f.bindBuffer(f.ELEMENT_ARRAY_BUFFER,null)}catch(c){alert("Error rendering actor ["+e.name+"]. Error ="+c.description);throw ("Error rendering actor ["+e.name+"]. Error ="+c.description)}};vxlBlenderStrategy.prototype=new vxlBasicStrategy();vxlBlenderStrategy.prototype.constructor=vxlBlenderStrategy;function vxlBlenderStrategy(a){vxlBasicStrategy.call(this,a)}vxlBlenderStrategy.prototype.render=function(h){var e=this.renderer;var d=e.transforms;var c=e.prg;var g=vxl.def.glsl;d.calculatePerspective();d.calculateModelView();c.setUniform(g.PERSPECTIVE_MATRIX,d.pMatrix);var f=h._actors.concat(h.toys.list);var a=f.length;if(h.frameAnimation!=undefined){h.frameAnimation.update()}for(var b=0;
b<a;b+=1){this._renderActor(f[b])}};vxlBlenderStrategy.prototype._applyActorTransform=function(a){var d=this.renderer;var c=d.transforms;var b=d.prg;var e=vxl.def.glsl;c.push();mat4.translate(c.mvMatrix,a._position);mat4.scale(c.mvMatrix,a._scale);b.setUniform(e.MODEL_VIEW_MATRIX,d.transforms.mvMatrix);c.pop();c.calculateNormal();b.setUniform(e.NORMAL_MATRIX,d.transforms.nMatrix)};vxlBlenderStrategy.prototype._renderActor=function(e){if(e.name=="bounding box"||e.name=="axis"||e.name=="floor"){return
}var g=e.model;var i=this._gl_buffers[e.UID];var a=this.renderer;var f=a.gl;var b=a.prg;var d=a.transforms;var h=vxl.def.glsl;f.disable(f.CULL_FACE);if(e.cull!=vxl.def.actor.cull.NONE){f.enable(f.CULL_FACE);switch(e.cull){case vxl.def.actor.cull.BACK:f.cullFace(f.BACK);break;case vxl.def.actor.cull.FRONT:f.cullFace(f.FRONT);break}}this._applyActorTransform(e);b.disableAttribute(h.NORMAL_ATTRIBUTE);b.enableAttribute(h.VERTEX_ATTRIBUTE);b.setUniform("uKa",e.getProperty("Ka"));b.setUniform("uKd",e.getProperty("Kd"));
b.setUniform("uKs",e.getProperty("Ks"));b.setUniform("uNs",e.getProperty("Ns"));b.setUniform("d",e.getProperty("opacity"));b.setUniform("illum",e.getProperty("illum"));try{f.bindBuffer(f.ARRAY_BUFFER,i.vertex);f.bufferData(f.ARRAY_BUFFER,new Float32Array(g.vertices.slice(0)),f.STATIC_DRAW);b.setAttributePointer(h.VERTEX_ATTRIBUTE,3,f.FLOAT,false,0,0)}catch(c){alert("There was a problem while rendering the actor ["+e.name+"]. The problem happened while handling the vertex buffer. Error ="+c.description);
throw ("There was a problem while rendering the actor ["+e.name+"]. The problem happened while handling the vertex buffer. Error ="+c.description)}if(g.normals){try{f.bindBuffer(f.ARRAY_BUFFER,i.normal);f.bufferData(f.ARRAY_BUFFER,new Float32Array(g.normals.slice(0)),f.STATIC_DRAW);b.enableAttribute(h.NORMAL_ATTRIBUTE);b.setAttributePointer(h.NORMAL_ATTRIBUTE,3,f.FLOAT,false,0,0)}catch(c){alert("There was a problem while rendering the actor ["+e.name+"]. The problem happened while handling the normal buffer. Error ="+c.description);
throw ("There was a problem while rendering the actor ["+e.name+"]. The problem happened while handling the normal buffer. Error ="+c.description)}}try{f.bindBuffer(f.ELEMENT_ARRAY_BUFFER,i.index);f.drawElements(f.TRIANGLES,g.indices.length,f.UNSIGNED_SHORT,0);f.bindBuffer(f.ARRAY_BUFFER,null);f.bindBuffer(f.ELEMENT_ARRAY_BUFFER,null)}catch(c){alert("Error rendering actor ["+e.name+"]. Error ="+c.description);throw ("Error rendering actor ["+e.name+"]. Error ="+c.description)}};vxlBakeStrategy.prototype=new vxlBasicStrategy(undefined);vxlBakeStrategy.prototype.constructor=vxlBakeStrategy;function vxlBakeStrategy(a){vxlBasicStrategy.call(this,a);var c=a.gl;this._calls={};this._gl_buffers={index:c.createBuffer(),baked:c.createBuffer(),position:c.createBuffer(),scale:c.createBuffer(),shading:c.createBuffer()};this._data={index:[],baked:[],position:[],scale:[],shading:[]};this._allocated=[];this._offsets={position:{},scale:{},shading:{},baked:{}};this.glsl=vxl.util.extend(vxl.def.glsl,{POSITION:"aPosition",SCALE:"aScale",SHADING:"aShading"});
var b=vxl.events;vxl.go.notifier.subscribe([b.ACTOR_MOVED,b.ACTOR_SCALED,b.ACTOR_CHANGED_SHADING,b.ACTOR_CHANGED_COLOR],this)}vxlBakeStrategy.prototype.handleEvent=function(b,a){switch(b){case vxl.events.ACTOR_MOVED:this._updateActorPosition(a);break;case vxl.events.ACTOR_SCALED:this._updateActorScale(a);break;case vxl.events.ACTOR_CHANGED_SHADING:this._updateActorShading(a);break;case vxl.events.ACTOR_CHANGED_COLOR:this._updateActorColor(a);break}};vxlBakeStrategy.prototype._populate=function(f,e){var b=[];
for(var d=0;d<e;d+=1){if(f instanceof Array||f instanceof Float32Array){for(var c=0;c<f.length;c+=1){b.push(f[c])}}else{b.push(f)}}return b};vxlBakeStrategy.prototype._computeRequiredCalls=function(f){var e=f._actors;var a=e.length;var b=0;var d=1;for(var c=0;c<a;c+=1){b+=e[c].model.indices.length;if(b>65000){b=0;d++}}return d};vxlBakeStrategy.prototype._allocateActor=function(f){if(this._allocated.indexOf(f.UID)!=-1){return}var h=this._data;var d=this._offsets;var j=this.renderer.gl;var k=f.model;
var a=k.vertices.length;var e=[],l=[];if(f.color){e=this._populate(f.color,a/3)}else{e=this._populate([0.7,0.7,0.7],a/3)}if(k.normals){l=k.normals}else{l=this._populate(0,a)}d.baked[f.UID]=h.baked.length;for(var g=0;g<a;g+=3){h.baked.push(k.vertices[g]);h.baked.push(k.vertices[g+1]);h.baked.push(k.vertices[g+2]);h.baked.push(l[g]);h.baked.push(l[g+1]);h.baked.push(l[g+2]);h.baked.push(e[g]);h.baked.push(e[g+1]);h.baked.push(e[g+2])}d.position[f.UID]=h.position.length;d.scale[f.UID]=h.scale.length;
d.shading[f.UID]=h.shading.length;h.position=h.position.concat(this._populate(f._position,a/3));h.scale=h.scale.concat(this._populate(f._scale,a/3));if(f.shading){h.shading=h.shading.concat(this._populate(1,a/3))}else{h.shading=h.shading.concat(this._populate(0,a/3))}var b=k.indices.slice(0);if(h.index.length>0){var m=h.index.max()+1;var c=k.indices.length;for(var g=0;g<c;g+=1){b[g]+=m}h.index=h.index.concat(b)}else{h.index=b}this._allocated.push(f.UID)};vxlBakeStrategy.prototype._updateActorPosition=function(b){var c=this._data;
var e=this._offsets.position[b.UID];if(e==undefined){return}var d=b.model.vertices.length+e;for(var a=e;a<d;a+=3){c.position[a]=b._position[0];c.position[a+1]=b._position[1];c.position[a+2]=b._position[2]}};vxlBakeStrategy.prototype._updateActorScale=function(b){var c=this._data;var e=this._offsets.scale[b.UID];if(e==undefined){return}var d=b.model.vertices.length+e;for(var a=e;a<d;a+=3){c.scale[a]=b._scale[0];c.scale[a+1]=b._scale[1];c.scale[a+2]=b._scale[2]}};vxlBakeStrategy.prototype._updateActorColor=function(b){var c=this._data;
var e=this._offsets.baked[b.UID];if(e==undefined){return}var d=(b.model.vertices.length*3)+e;for(var a=e;a<d;a+=9){c.baked[a+6]=b.color[0];c.baked[a+7]=b.color[1];c.baked[a+8]=b.color[2]}};vxlBakeStrategy.prototype._updateActorShading=function(b){var c=this._data;var f=this._offsets.shading[b.UID];if(f==undefined){return}var d=(b.model.vertices.length/3)+f;var e=0;if(b.shading){e=1}for(var a=f;a<d;a+=1){c.shading[a]=e}};vxlBakeStrategy.prototype.deallocate=function(a){};vxlBakeStrategy.prototype.allocate=function(h){if(this._computeRequiredCalls(h)>1){throw"Not renderable yet. Working on it. The number of indices exceeds the 65K limit"
}var a=h._actors;var c=a.length;var b=this.renderer;var l=this._gl_buffers;var f=this._data;var d=b.prg;var g=b.gl;var k=this.glsl;var j=g.STATIC_DRAW;for(var e=0;e<c;e+=1){this._allocateActor(a[e])}d.enableAttribute(k.VERTEX_ATTRIBUTE);d.enableAttribute(k.NORMAL_ATTRIBUTE);d.enableAttribute(k.COLOR_ATTRIBUTE);d.enableAttribute(k.POSITION);d.enableAttribute(k.SCALE);d.enableAttribute(k.SHADING);g.bindBuffer(g.ARRAY_BUFFER,l.baked);g.bufferData(g.ARRAY_BUFFER,new Float32Array(f.baked),j);d.setAttributePointer(k.VERTEX_ATTRIBUTE,3,g.FLOAT,false,36,0);
d.setAttributePointer(k.NORMAL_ATTRIBUTE,3,g.FLOAT,false,36,12);d.setAttributePointer(k.COLOR_ATTRIBUTE,3,g.FLOAT,false,36,24);g.bindBuffer(g.ARRAY_BUFFER,l.position);g.bufferData(g.ARRAY_BUFFER,new Float32Array(f.position),j);d.setAttributePointer(k.POSITION,3,g.FLOAT,false,12,0);g.bindBuffer(g.ARRAY_BUFFER,l.scale);g.bufferData(g.ARRAY_BUFFER,new Float32Array(f.scale),j);d.setAttributePointer(k.SCALE,3,g.FLOAT,false,12,0);g.bindBuffer(g.ARRAY_BUFFER,l.shading);g.bufferData(g.ARRAY_BUFFER,new Float32Array(f.shading),j);
d.setAttributePointer(k.SHADING,1,g.FLOAT,false,4,0);g.bindBuffer(g.ELEMENT_ARRAY_BUFFER,l.index);g.bufferData(g.ELEMENT_ARRAY_BUFFER,new Uint16Array(f.index),j)};vxlBakeStrategy.prototype.render=function(f){var c=this.renderer;var b=c.transforms;var a=c.prg;var g=c.gl;var e=vxl.def.glsl;var d=this._data;b.update();a.setUniform(e.PERSPECTIVE_MATRIX,b.pMatrix);a.setUniform(e.MODEL_VIEW_MATRIX,b.mvMatrix);a.setUniform(e.NORMAL_MATRIX,b.nMatrix);a.setUniform(e.MVP_MATRIX,b.mvpMatrix);g.drawElements(g.TRIANGLES,d.index.length,g.UNSIGNED_SHORT,0);
g.bindBuffer(g.ARRAY_BUFFER,null);g.bindBuffer(g.ELEMENT_ARRAY_BUFFER,null)};function vxlScene(){this.views=[];this._actors=[];this.toys=new vxlSceneToys(this);this.loadingMode=vxl.def.model.loadingMode.LIVE;this.normalsFlipped=false;this.lutID=null;this.timerID=null;this.dispatchRate=500;this.scalarMIN=Number.MAX_VALUE;this.scalarMAX=Number.MIN_VALUE;this.bb=[0,0,0,0,0,0];this.centre=[0,0,0];this.frameAnimation=null;this.UID=vxl.util.generateUID();if(vxl.c.scene==null){vxl.c.scene=this}vxl.go.scenes.push(this);var b=vxl.go.notifier;var a=vxl.events;b.publish([a.SCENE_NEW,a.SCENE_UPDATED],this);
b.subscribe([a.MODELS_LOADED,a.DEFAULT_LUT_LOADED],this);b.fire(a.SCENE_NEW,this)}vxlScene.prototype.handleEvent=function(a,b){if(a==vxl.events.MODELS_LOADED){this.updateScalarRange();if(this.lutID!=null){this.setLookupTable(this.lutID)}}else{if(a==vxl.events.DEFAULT_LUT_LOADED){this.lutID="default";this.setLookupTable(this.lutID)}}};vxlScene.prototype.setLoadingMode=function(b){var a=vxl.def.model.loadingMode;if(b==undefined||b==null||(b!=a.LIVE&&b!=a.LATER&&b!=a.DETACHED)){throw ("the mode "+b+"is not a valid loading mode")
}this.loadingMode=b};vxlScene.prototype._updateBoundingBoxWith=function(c){var a=c._bb;vxl.go.console("Scene: updating metrics with ("+a[0]+","+a[1]+","+a[2]+") - ("+a[3]+","+a[4]+","+a[5]+")");if(this._actors.length==1){this.bb=this._actors[0]._bb.slice(0);this.toys.update();return}var d=this.bb;var e=this.centre;d[0]=Math.min(d[0],a[0]);d[1]=Math.min(d[1],a[1]);d[2]=Math.min(d[2],a[2]);d[3]=Math.max(d[3],a[3]);d[4]=Math.max(d[4],a[4]);d[5]=Math.max(d[5],a[5]);e[0]=(d[3]+d[0])/2;e[1]=(d[4]+d[1])/2;
e[2]=(d[5]+d[2])/2;e[0]=Math.round(e[0]*1000)/1000;e[1]=Math.round(e[1]*1000)/1000;e[2]=Math.round(e[2]*1000)/1000;this.toys.update()};vxlScene.prototype.computeBoundingBox=function(){if(this._actors.length>0){this.bb=this._actors[0]._bb.slice(0)}else{this.bb=[0,0,0,0,0,0]}this.centre=[0,0,0];var b=this._actors.length;for(var a=0;a<b;a++){this._updateBoundingBoxWith(this._actors[a])}};vxlScene.prototype.createActor=function(a){var b=new vxlActor(a);this.addActor(b);return b};vxlScene.prototype.createActors=function(b){vxl.go.console("Scene: Creating all the actors now");
for(var a=0;a<b.length;a++){this.createActor(b[a])}};vxlScene.prototype.addActor=function(a){a.setScene(this);if(this.normalsFlipped){a.flipNormals(true)}if(this.lutID!=null){a.setLookupTable(this.lutID,this.scalarMIN,this.scalarMAX)}this._actors.push(a);this._updateBoundingBoxWith(a);vxl.go.console("Scene: Actor for model "+a.model.name+" added");if(this._actors.length==1){vxl.c.actor=a}else{vxl.c.actor=undefined}vxl.go.notifier.fire(vxl.events.SCENE_UPDATED,this)};vxlScene.prototype.updateActor=function(b){if(!this.hasActor(b)){return
}b.dirty=true;for(var a=0;a<this.views.length;a+=1){this.views[a].renderer.reallocate()}b.dirty=false};vxlScene.prototype.removeActor=function(b){var a=this._actors.indexOf(b);this._actors.splice(a,1);this.computeBoundingBox()};vxlScene.prototype.hasActor=function(b){if(b instanceof vxlActor){return(this._actors.indexOf(b)!=-1)}else{if(typeof(b)=="string"){var a=this.getActorByName(b);return(a!=undefined)}else{return false}}};vxlScene.prototype.setPropertyForAll=function(c,b){for(var a=0;a<this._actors.length;
a++){this._actors[a].setProperty(c,b)}};vxlScene.prototype.setPropertyFor=function(e,d,c){for(var a=0;a<e.length;a++){if(this.hasActor(e[a])){var b=undefined;if(typeof(e[a])=="string"){b=this.getActorByName(e[a])}else{if(e[a] instanceof vxlActor){e[a].setProperty(d,c)}else{throw"vxlScene.setPropertyFor: ERROR, the list of actors is invalid"}}}}};vxlScene.prototype.updateScalarRange=function(){for(var a=0;a<this._actors.length;a++){var b=this._actors[a];if(b.model.scalars&&b.model.scalars.max()>this.scalarMAX){this.scalarMAX=b.model.scalars.max()
}if(b.model.scalars&&b.model.scalars.min()<this.scalarMIN){this.scalarMIN=b.model.scalars.min()}}};vxlScene.prototype.setLookupTable=function(c){this.lutID=c;for(var a=0,b=this._actors.length;a<b;a+=1){this._actors[a].setLookupTable(c,this.scalarMIN,this.scalarMAX)}};vxlScene.prototype.reset=function(){for(var a=0;a<this._actors.length;a++){this._actors[a]=null}this._actors=[];vxl.c.actor=null;this.computeBoundingBox()};vxlScene.prototype.getActorByName=function(a){a=a.replace(/\.[^/.]+$/,"");var c=this._actors.length;
for(var b=0;b<c;b+=1){if(this._actors[b].name==a){return this._actors[b]}}return undefined};vxlScene.prototype.getActorByUID=function(a){var c=this._actors.length;for(var b=0;b<c;b+=1){if(this._actors[b].UID==a){return this._actors[b]}}return undefined};vxlScene.prototype.getActorsThat=function(e){var a=[];for(var d=0;d<this._actors.length;d+=1){if(e(this._actors[d])){a.push(d)}}var c=[];for(var b=0;b<a.length;b+=1){c.push(this._actors[a[b]])}return c};vxlScene.prototype.setOpacity=function(d,a){if(a==null){for(var b=0;
b<this._actors.length;b++){this._actors[b].setOpacity(d)}}else{var c=this.getActorByName(a);c.setOpacity(d)}};vxlScene.prototype.flipNormals=function(){for(var a=0;a<this._actors.length;a++){this._actors[a].flipNormals()}};vxlScene.prototype.setVisualizationMode=function(b){if(b==null||b==undefined){return}for(var a=0;a<this._actors.length;a++){this._actors[a].setVisualizationMode(b)}};vxlScene.prototype.setAnimation=function(b){if(b instanceof vxlFrameAnimation){this.frameAnimation=b;this.frameAnimation.scene=this;
for(var a=0;a<this.views.length;a+=1){this.views[a].renderer.setMode(vxl.def.renderer.mode.ANIMFRAME)}vxl.go.console("Scene: animation added")}};vxlScene.prototype.clearAnimation=function(){if(this.frameAnimation){this.frameAnimation.scene=null;this.frameAnimation=null}};vxlScene.prototype.getActorNames=function(){var d=[];for(var b=0,c=this._actors.length;b<c;b+=1){d.push(this._actors[b].name)}return d};vxlScene.prototype.getPickableActors=function(){function a(b){return b.isPickable()}return this.getActorsThat(a)
};vxlScene.prototype.getActorByCellUID=function(c){var e=[];for(var b=0,d=this._actors.length;b<d;b+=1){if(actor.mesh!=undefined&&actor.mesh.hasCell(c)){return actor}}return null};function vxlSceneToys(a){this.scene=a;this.list=[];this.axis=new vxlAxis();this.boundingbox=new vxlBoundingBox();this.floor=new vxlFloor();this.list.push(this.axis);this.list.push(this.boundingbox);this.list.push(this.floor)}vxlSceneToys.prototype.update=function(){this.axis.setCentre(this.scene.centre);this.boundingbox.setBoundingBox(this.scene.bb)};function vxlLookupTable(){this.ID=null;this.map=null;this.max=Number.MIN_VALUE;this.min=Number.MAX_VALUE}vxlLookupTable.prototype.load=function(a,c){this.ID=a;this.map=c;for(var b in this.map){var d=Number(b);if(d<this.min){this.min=d}else{if(d>=this.max){this.max=d}}}};vxlLookupTable.prototype._scale=function(c,b,a){return c*this.max/a};vxlLookupTable.prototype.getColor=function(g,e,a){var f=this._scale(g,e,a);var b=this;var d=Math.round(f);if(d>=b.min&&d<=b.max){var h=[b.map[d][0],b.map[d][1],b.map[d][2]];
return h}else{if(d<b.min){return[b.map[b.min][0],b.map[b.min][1],b.map[b.min][2]]}else{if(d>b.max){return[b.map[b.max][0],b.map[b.max][1],b.map[b.max][2]]}else{alert("assertion error in getColor routine");return[b.map[b.min][0],b.map[b.min][1],b.map[b.min][2]]}}}};vxlLookupTable.prototype.getColors=function(e,d,a){var g=[];for(var b=0;b<e.length;b++){var f=this.getColor(e[b],d,a);g.push(f[0]);g.push(f[1]);g.push(f[2])}return g};function vxlLookupTableManager(){this.lutTimerID=0;this._hashmap={};this.location="";vxl.go.notifier.publish(vxl.events.DEFAULT_LUT_LOADED,this)}vxlLookupTableManager.prototype.setLocation=function(a){this.location=a};vxlLookupTableManager.prototype.load=function(b){var a=this;if(this.isLoaded(b)){return}var c=new XMLHttpRequest();c.open("GET",this.location+"/"+b+".lut");c.onreadystatechange=function(){if(c.readyState==4){if(c.status==404){alert(b+" does not exist");vxl.go.console("LookupTableManager: "+b+" does not exist")
}else{a.handle(b,JSON.parse(c.responseText))}}};c.send()};vxlLookupTableManager.prototype.handle=function(a,c){var b=new vxlLookupTable();b.load(a,c);this._hashmap[a]=b;if(b.ID==vxl.def.lut.main){vxl.go.notifier.fire(vxl.events.DEFAULT_LUT_LOADED,this)}};vxlLookupTableManager.prototype.isLoaded=function(a){return this._hashmap[a]!=undefined};vxlLookupTableManager.prototype.get=function(a){return this._hashmap[a]};vxlLookupTableManager.prototype.getAllLoaded=function(){var a=[];for(lut in this._hashmap){a.push(this._hashmap[lut].ID)
}return a};vxlLookupTableManager.prototype.allLoaded=function(){var a=0;for(lut in this._hashmap){a++}return(vxl.def.lut.list.length==a)};vxlLookupTableManager.prototype.loadAll=function(){for(var a=0;a<vxl.def.lut.list.length;a++){this.load(vxl.def.lut.list[a])}};vxl.go.lookupTableManager=new vxlLookupTableManager();vxl.def.model.boundingBox=new vxlModel();vxl.def.model.boundingBox.load("bounding box",{vertices:[],wireframe:[0,1,1,2,2,3,3,0,0,4,4,5,5,6,6,7,7,4,1,5,2,6,3,7],color:[1,1,1,1]});vxlBoundingBox.prototype=new vxlActor();vxlBoundingBox.prototype.constructor=vxlBoundingBox;function vxlBoundingBox(){vxlActor.call(this,vxl.def.model.boundingBox);this.bb=[];this.mode=vxl.def.actor.mode.WIREFRAME;this.visible=false;this.toy=true;this.shading=false}vxlBoundingBox.prototype.setBoundingBox=function(a){this.bb=[a[0],a[1],a[2],a[0],a[4],a[2],a[3],a[4],a[2],a[3],a[1],a[2],a[0],a[1],a[5],a[0],a[4],a[5],a[3],a[4],a[5],a[3],a[1],a[5]];
this.model.vertices=this.bb};vxl.def.model.axis=new vxlModel();vxl.def.model.axis.load("axis",{vertices:[-1,0,0,1,0,0,0,-2,0,0,2,0,0,0,-1,0,0,1],wireframe:[0,1,2,3,4,5],colors:[1,0,0,1,0,0,0,1,0,0,1,0,0,0,1,0,0,1]});vxlAxis.prototype=new vxlActor();vxlAxis.prototype.constructor=vxlAxis;function vxlAxis(){vxlActor.call(this,vxl.def.model.axis);this.centre=[0,0,0];this.mode=vxl.def.actor.mode.WIREFRAME;this.visible=false;this.toy=true;this.shading=false}vxlAxis.prototype.setCentre=function(c){var b=c[0];var e=c[1];var d=c[2];this.centre[0]=b;
this.centre[1]=e;this.centre[2]=d;var a=this.model.vertices;a[0]=b-1;a[1]=e;a[2]=d;a[3]=b+1;a[4]=e;a[5]=d;a[6]=b;a[7]=e-2;a[8]=d;a[9]=b;a[10]=e+2;a[11]=d;a[12]=b;a[13]=e;a[14]=d-1;a[15]=b;a[16]=e;a[17]=d+1};vxl.def.model.floor=new vxlModel();vxl.def.model.floor.load("floor",{vertices:[],indices:[],color:[1,1,1,1]});vxlFloor.prototype=new vxlActor();vxlFloor.prototype.constructor=vxlFloor;function vxlFloor(){vxlActor.call(this,vxl.def.model.floor);this.mode=vxl.def.actor.mode.WIREFRAME;this.visible=false;this.toy=true;this.shading=false}vxlFloor.prototype.setGrid=function(g,h){var f=g;var b=2*f/h;var e=2*f/b;var c=[];var d=[];for(var a=0;a<=b;a++){c[6*a]=-f;c[6*a+1]=0;c[6*a+2]=-f+(a*e);c[6*a+3]=f;c[6*a+4]=0;
c[6*a+5]=-f+(a*e);c[6*(b+1)+6*a]=-f+(a*e);c[6*(b+1)+6*a+1]=0;c[6*(b+1)+6*a+2]=-f;c[6*(b+1)+6*a+3]=-f+(a*e);c[6*(b+1)+6*a+4]=0;c[6*(b+1)+6*a+5]=f;d[2*a]=2*a;d[2*a+1]=2*a+1;d[2*(b+1)+2*a]=2*(b+1)+2*a;d[2*(b+1)+2*a+1]=2*(b+1)+2*a+1}this.model.vertices=c.slice(0);this.model.wireframe=d.slice(0);this.visible=true};function vxlView(d,c,f){this.canvas=document.getElementById(d);if(this.canvas==null){alert("View: the canvas "+d+" does not exist.");throw ("View: the canvas "+d+" does not exist.")}this.name=d;this.width=this.canvas.width;this.height=this.canvas.height;this.clearDepth=1;this.backgroundColor=vxl.def.view.background.slice(0);this.dragndrop=false;this.renderer=new vxlRenderer(this);this.setBackgroundColor(this.backgroundColor);this.setClearDepth(this.clearDepth);this.cameraman=new vxlCameraManager(this);
this.interactor=new vxlTrackerInteractor();this.interactor.connectView(this);if(c!=null&&c instanceof vxlScene){this.scene=c}else{if(vxl.c.scene!=undefined){this.scene=vxl.c.scene}else{this.scene=new vxlScene()}}this.scene.views.push(this);if(vxl.c.view==undefined){vxl.c.view=this}vxl.go.views.push(this);if(f==undefined){f=true}this.setAutoResize(f);this.UID=vxl.util.generateUID();var b=vxl.go.notifier;var a=vxl.events;b.publish(a.VIEW_NEW,this);b.subscribe(a.DEFAULT_LUT_LOADED,this);b.fire(a.VIEW_NEW,this);
vxl.go.console("View: the view "+this.name+" has been created")}vxlView.prototype.handleEvent=function(a,b){vxl.go.console("vxlView ["+this.name+"]: receiving event "+a);if(a==vxl.events.DEFAULT_LUT_LOADED){this.scene.setLookupTable(vxl.def.lut.main)}};vxlView.prototype.clear=function(){this.renderer.clear()};vxlView.prototype._wrapDiv=function(){$(this.canvas).css({position:"absolute",height:"auto",bottom:0,top:0,left:0,right:0,margin:"5px"});$(this.canvas).wrap("<div id="+this.name+"-wrapper />");
$("#"+this.name+"-wrapper").css({width:"100%",height:"100%"});this.canvas.focus()};vxlView.prototype.resize=function(){var a=this.canvas.parentNode;this.width=$(a).width()-5;this.height=$(a).height()-5;if(this.width>window.innerWidth-5){this.width=window.innerWidth-5}if(this.height>window.innerHeight-5){this.height=window.innerHeight-5}$(this.canvas).attr("width",this.width);$(this.canvas).attr("height",this.height)};vxlView.prototype.setAutoResize=function(a){if(a){this._wrapDiv();this.resize();
$(window).resize((function(b){return function(){b.resize()}})(this))}else{$(window).unbind("resize")}};vxlView.prototype._runPrefixMethod=function(d,f){var e=["webkit","moz","ms","o",""];var c=0,a,b;while(c<e.length&&!d[a]){a=f;if(e[c]==""){a=a.substr(0,1).toLowerCase()+a.substr(1)}a=e[c]+a;b=typeof d[a];if(b!="undefined"){e=[e[c]];return(b=="function"?d[a]():d[a])}c++}};vxlView.prototype.fullscreen=function(a){if(a==true){this._runPrefixMethod(this.canvas,"RequestFullScreen")}else{if(this._runPrefixMethod(document,"FullScreen")||this._runPrefixMethod(document,"isFullScreen")){this._runPrefixMethod(document,"CancelFullScreen")
}}};vxlView.prototype.start=function(){this.renderer.start();this.refresh()};vxlView.prototype.stop=function(){this.renderer.stop()};vxlView.prototype.reset=function(){this.stop();this.scene.reset();this.cameraman.reset();this.start()};vxlView.prototype.setBackgroundColor=function(d,c,a){this.backgroundColor=vxl.util.createArr3(d,c,a);this.renderer.clearColor(this.backgroundColor)};vxlView.prototype.setClearDepth=function(a){this.renderer.clearDepth(a)};vxlView.prototype.refresh=function(){this.renderer.render()
};vxlView.prototype.setInteractor=function(a){this.interactor=a;this.interactor.connectView(this)};vxlView.prototype.setDragAndDrop=function(a){this.dragndrop=a};vxlView.prototype.getFPS=function(){return this.renderer.fps};function vxlModelManager(){this.toLoad=[];this.models=[];var a=vxl.events;vxl.go.notifier.publish([a.MODELS_LOADING,a.MODEL_NEW,a.MODELS_LOADED],this);vxl.go.notifier.subscribe(a.READER_DONE,this)}vxlModelManager.prototype.handleEvent=function(c,d){var a=d;var e=a.getParts();for(var b=0;b<e.length;b+=1){this.add(e[b],e[b].name,a.scene)}};vxlModelManager.prototype.load=function(b,g){var e=this;var d=b.replace(/^.*[\\\/]/,"");if(e.isModelLoaded(d)){return}vxl.go.console("ModelManager.load: Requesting "+b+"...");
vxl.go.notifier.fire(vxl.events.MODELS_LOADING,this);var c=function(i,h,j){return function(k,l){k.uri=b;k.path=vxl.util.getPath(b);i.add(k,h,j)}};var a=function(h){return function(k,i,j){if(j.code=1012){alert("The file "+h+" could not be accessed. \n\nPlease make sure that the path is correct and that you have the right pemissions")}else{alert("There was a problem loading the file "+h+". HTTP error code:"+k.status)}}};var f=$.ajax({url:b,type:"GET",dataType:"json",success:c(e,d,g),error:a(b)})};vxlModelManager.prototype.loadList=function(b,c){this.toLoad=b.slice(0);
vxl.go.console("ModelManager.loadList: models to load ->"+this.toLoad.length);for(var a=0;a<this.toLoad.length;a++){this.load(this.toLoad[a],c)}};vxlModelManager.prototype.add=function(c,b,e){var a=this;function d(){var f=new vxlModel(b,c);f.loaded=true;a.models.push(f);a.toLoad.splice(b,1);vxl.go.console("ModelManager: model "+f.name+" created.");if(e!=undefined&&e instanceof vxlScene){vxl.go.console("ModelManager: notifying the scene...");if(e.loadingMode==vxl.def.model.loadingMode.LIVE){e.createActor(f)
}else{if(e.loadingMode==vxl.def.model.loadingMode.LATER){if(a.allLoaded()){e.createActors(a.models)}}else{if(e.loadingMode==vxl.def.model.loadingMode.DETACHED){}}}}if(a.allLoaded()){vxl.go.notifier.fire(vxl.events.MODELS_LOADED,a)}else{vxl.go.notifier.fire(vxl.events.MODEL_NEW,a)}}setTimeout(function(){d()},0)};vxlModelManager.prototype.reset=function(){this.firstLoadedModel=false;for(var a=0;a<this.models.length;a++){this.models[a]=null}this.models=[];this.toLoad=[]};vxlModelManager.prototype.isModelLoaded=function(a){for(var b=0;
b<this.models.length;b++){if(this.models[b].name==a){return true}}return false};vxlModelManager.prototype.allLoaded=function(){return(this.toLoad.length==0)};vxlModelManager.prototype.getModelByName=function(b){for(var c=0,a=this.models.length;c<a;c+=1){if(this.models[c].name==b){return this.models[c]}}return null};vxl.go.modelManager=new vxlModelManager();vxl.api={setup:function(a,b,c){if(b!=null&&!(b instanceof vxlScene)){throw ("api.setup: scene parameter is invalid")}return new vxlView(a,b,c)},setRenderRate:function(a){vxl.c.view.renderer.setRenderRate(a)},setRenderMode:function(b,a){if(a==undefined&&vxl.c.view==undefined){throw ("api.setRnederMode: you need to define a view")}else{if(a!=undefined&&a instanceof vxlView){a.renderer.setMode(b)}else{vxl.c.view.renderer.setMode(b)}}},setCameraDistance:function(a){g_fovy=a;vxl.go.console("fovY = "+a)
},setCurrentView:function(b){if(b instanceof vxlView){vxl.c.view=b}},getCurrentView:function(){return vxl.c.view},setCurrentActor:function(a){if(a instanceof vxlActor){vxl.c.actor=a}else{if(typeof a=="string"){if(vxl.c.scene==undefined){throw ("vxl.api.setCurrentActor: there is no Current scene. Please call vxl.api.setCurrentScene")}var b=vxl.c.scene.getActorByName(a);if(b!=undefined){vxl.c.actor=b}else{throw ("vxl.api.setCurrentActor: the actor "+a+" does not exist in the current scene")}}else{vxl.c.actor=a
}}},getCurrentActor:function(){return vxl.c.actor},setCurrentCamera:function(b){if(b instanceof vxlCamera){vxl.c.camera=b}},getCurrentCamera:function(){return vxl.c.camera},setLookupTable:function(a){if(!vxl.go.lookupTableManager.isLoaded(a)){vxl.go.console("Lookup Table "+a+" has not been loaded");return}vxl.c.view.scene.setLookupTable(a)},loadLUTS:function(a){vxl.go.lookupTableManager.setLocation(a);vxl.go.lookupTableManager.loadAll()},resetScene:function(){if(vxl.c.animation){vxl.c.animation.stop()
}vxl.c.view.reset();vxl.go.modelManager.reset()},load:function(b,e,f,d){var d=d==null?vxl.c.scene:d;var g=[];var c=vxl.util.getPath(e);if(typeof(b)=="string"||b instanceof String){g.push(c+b)}else{if(b instanceof Array){for(var a=0;a<b.length;a++){g.push(c+b[a])}}}if(f!=undefined&&f!=null){d.setLoadingMode(f)}vxl.go.modelManager.loadList(g,d)},axisON:function(){if(vxl.c.scene==undefined){throw ("vxl.api.axisON: There is no current scene")}vxl.c.scene.toys.axis.setVisible(true);vxl.c.camera.refresh()
},axisOFF:function(){if(vxl.c.scene==undefined){throw ("vxl.api.axisOFF: There is no current scene")}vxl.c.scene.toys.axis.setVisible(false);vxl.c.camera.refresh()},boundingBoxON:function(){if(vxl.c.scene==undefined){throw ("vxl.api.boundingBoxON: There is no current scene")}vxl.c.scene.toys.boundingbox.setVisible(true);vxl.c.camera.refresh()},boundingBoxOFF:function(){if(vxl.c.scene==undefined){throw ("vxl.api.boundingBoxOFF: There is no current scene")}vxl.c.scene.toys.boundingbox.setVisible(false);
vxl.c.camera.refresh()},floorON:function(a,b){if(vxl.c.scene==undefined){throw ("vxl.api.floorON: There is no current scene")}if(a==undefined||b==undefined){vxl.c.scene.toys.floor.setVisible(true)}else{vxl.c.scene.toys.floor.setGrid(a,b)}vxl.c.camera.refresh()},floorOFF:function(){if(vxl.c.scene==undefined){throw ("vxl.api.floorOFF: There is no current scene")}vxl.c.scene.toys.floor.setVisible(false);vxl.c.camera.refresh()},setBackgroundColor:function(d,c,a){vxl.c.view.setBackgroundColor(d,c,a)},wireframeON:function(){if(vxl.c.actor){vxl.c.actor.setVisualizationMode(vxl.def.actor.mode.WIREFRAME)
}else{vxl.c.scene.setVisualizationMode(vxl.def.actor.mode.WIREFRAME)}vxl.go.console("API:Wireframe is shown.")},surfaceON:function(){if(vxl.c.actor){vxl.c.actor.setVisualizationMode(vxl.def.actor.mode.SOLID)}else{vxl.c.view.scene.setVisualizationMode(vxl.def.actor.mode.SOLID)}vxl.go.console("API:Wireframe is hidden.")},pointsON:function(){if(vxl.c.actor){vxl.c.actor.setVisualizationMode(vxl.def.actor.mode.POINTS)}else{vxl.c.view.scene.setVisualizationMode(vxl.def.actor.mode.POINTS)}},getActorNames:function(b){var a=b;
if(a==undefined){if(vxl.c.scene==undefined){throw ("vxl.api.getActorNames: There is no current scene")}else{a=vxl.c.scene}}return a.getActorNames()},getActor:function(c,b){var a=this.getActorByName(c,b);if(a==undefined){a=this.getActorByUID(c,b)}return a},getActorByUID:function(b,c){var a=c;if(a==undefined){if(vxl.c.scene==undefined){throw ("vxl.api.getActorByUID: There is no current scene. Please the scene you want to look the actor with uid: "+UID+" into")}else{a=vxl.c.scene}}return a.getActorByUID(b)
},getActorByName:function(c,b){var a=b;if(a==undefined){if(vxl.c.scene==undefined){throw ("vxl.api.getActorByName: There is no current scene. Please the scene you want to look the actor "+c+" into")}else{a=vxl.c.scene}}return a.getActorByName(c)},setActorOpacity:function(b){var a=Math.min(Math.max(0,Math.abs(b)),1);if(vxl.c.actor){vxl.c.actor.setOpacity(b)}else{vxl.c.view.scene.setOpacity(a)}vxl.c.view.refresh();vxl.go.console("API:Opacity changed to "+(b*100)+"%")},setActorProperty:function(b,d,c){if(vxl.c.scene==undefined){throw ("vxl.api.setActorProperty: there is no current scene. Please call vxl.api.setCurrentScene")
}var e=vxl.c.scene;var a=b;if(a instanceof vxlActor){a.setProperty(d,c)}else{a=e.getActorByName(a);if(a==undefined){throw"The actor "+a+" does not belong to the current scene"}a.setProperty(d,c)}},setPropertyForAll:function(c,b,d){var a=undefined;if(vxl.c.scene==undefined&&d==undefined){throw ("vxl.api.setPropertyForAll: there is no current scene. Please call vxl.api.setCurrentScene")}if(d==undefined){a=vxl.c.scene}else{a=d}a.setPropertyForAll(c,b)},setPropertyFor:function(d,c,b,e){var a=undefined;
if(vxl.c.scene==undefined&&e==undefined){throw ("vxl.api.setPropertyForAll: there is no current scene. Please call vxl.api.setCurrentScene")}if(e==undefined){a=vxl.c.scene}else{a=e}a.setPropertyFor(d,c,b)},getActorsThat:function(c,b){var a=undefined;if(vxl.c.scene==undefined&&b==undefined){throw ("vxl.api.setPropertyForAll: there is no current scene. Please call vxl.api.setCurrentScene")}if(b==undefined){a=vxl.c.scene}else{a=b}return a.getActorsThat(c)},flipActorNormals:function(){if(vxl.c.actor){vxl.c.actor.flipNormals()
}else{vxl.c.view.scene.flipNormals()}vxl.c.view.refresh()},stopAnimation:function(){if(vxl.c.animation!=null){vxl.c.animation.stop()}},startAnimation:function(){if(vxl.c.animation!=null){vxl.c.animation.start()}},setFrame:function(c){if(vxl.c.animation==null){return}var b=vxl.c.animation;b.stop();if(c>=1){b.setFrame(c)}else{vxl.go.console("API:frame "+c+" does not exist. Animation goes back to the beginning");b.setFrame(1)}},clearAnimation:function(){if(vxl.c.animation){vxl.c.animation.stop();vxl.c.animation=null
}},resetCamera:function(){vxl.c.camera.reset()},saveCamera:function(){vxl.c.camera.save()},retrieveCamera:function(){vxl.c.camera.retrieve()},setAzimuth:function(b){vxl.c.camera.setAzimuth(b)},setElevation:function(a){vxl.c.camera.setElevation(a)},getLookupTables:function(){return vxl.go.lookupTableManager.getAllLoaded()},setProgram:function(a,b,c){a.renderer.setProgram(b,c)},getProgram:function(a){if(a==undefined){a=vxl.c.view}if(a==undefined){throw ("vxl.api.getProgram: please indicate a view")
}return a.renderer.prg._currentProgramID},setUniform:function(b,a,c){vxl.c.view.renderer.prg.setUniform(b,a,c)},getUniformNames:function(){return vxl.c.view.renderer.prg._uniformList[vxl.c.view.renderer.prg._currentProgramID].slice(0)},subscribe:function(b,a){vxl.go.notifier.subscribe(b,a)}};function vxlFrameAnimation(a){this.scene=null;this.actorByFrameMap=[];this.activeFrame=1;this.mark=1;this._running=false;this.frameCount=0;this.renderRate=500;this._startDate=undefined;this._time=0;this._setup(a);if(vxl.c.animation==null){vxl.c.animation=this}}vxlFrameAnimation.prototype.addActorToFrame=function(b,a){if(typeof(this.actorByFrameMap[b])=="undefined"){this.actorByFrameMap[b]=new Array()}if(this.actorByFrameMap[b].indexOf(a)==-1){this.actorByFrameMap[b].push(a)}if(b>this.frameCount){this.frameCount=b
}};vxlFrameAnimation.prototype._setup=function(e){this.activeFrame=1;for(var d in e){var b=e[d];var g=parseInt(d.substr(5,d.length));for(var c=0,a=b.length;c<a;c+=1){this.addActorToFrame(g,b[c])}}vxl.go.console("FrameAnimation: Setup finished.")};vxlFrameAnimation.prototype.start=function(a){if(this.scene==null){throw"FrameAnimation: the animation is not associated with any scene. Please use scene.setFrameAnimation method"}this._startDate=new Date().getTime();this._time=0;this._running=true;if(a!=undefined&&a>=0){this.renderRate=a
}this._timeUp()};vxlFrameAnimation.prototype._timeUp=function(){if(!this._running){return}this.nextFrame();if(this._time==this.renderRate*100){this._time=0;this._startDate=new Date().getTime()}this._time+=this.renderRate;var a=(new Date().getTime()-this._startDate)-this._time;if(a>this.renderRate){a=0}setTimeout((function(b){return function(){b._timeUp()}})(this),this.renderRate-a)};vxlFrameAnimation.prototype.stop=function(){this._running=false};vxlFrameAnimation.prototype.setFrameRate=function(a){if(a<=0){return
}this.stop();this.renderRate=a;this.start()};vxlFrameAnimation.prototype.update=function(){if(this.scene==null){throw"FrameAnimation: the animation is not associated with any scene. Please use scene.setFrameAnimation method"}this.scene.setPropertyForAll("visible",false);var c=this.actorByFrameMap[this.activeFrame];var a=c.length;for(var b=0;b<a;b++){var d=this.scene.getActorByName(c[b]);if(d!=null){d.setVisible(true)}}};vxlFrameAnimation.prototype.isValidFrame=function(a){return(a>=1&&a<=this.frameCount)
};vxlFrameAnimation.prototype.nextFrame=function(){if(this.activeFrame<this.frameCount){this.activeFrame++}else{this.activeFrame=1}};vxlFrameAnimation.prototype.getNextFrames=function(f){var d=[];var e=this.activeFrame;if(f>this.frameCount){f=this.frameCount}for(var a=1;a<=f;a++){var b=e+a;if(this.isValidFrame(b)){d.push(b)}else{d.push(b-this.frameCount)}}vxl.go.console("Animation: next frames: "+d);return d};vxlFrameAnimation.prototype.getPreviousFrames=function(f){var d=[];var e=this.activeFrame;
if(f>this.frameCount){f=this.frameCount}for(var a=1;a<=f;a++){var b=e-a;if(this.isValidFrame(b)){d.push(b)}else{d.push(this.frameCount+b)}}vxl.go.console("Animation: previous frames: "+d);return d};vxlFrameAnimation.prototype.setFrame=function(a){if(a>=1&&a<=this.frameCount){this.activeFrame=a;this.render()}};function vxlVTKReader(a){this.scene=a;this.ARRAY_SIZE=65536*3;this.vertices=[];this.indices=[];this.normals=[];this.scalars=[];this.colors=[];this.mode="SOLID";this.tags={NOWHERE:0,POINTS:1,LINES:2,POLYGONS:3,POINT_DATA:4,NORMALS:5,CELL_DATA:6,TEXTURE_COORDINATES:7,SCALARS:8,LOOKUP_TABLE:9,COLOR_SCALARS:10};this.parts=[];vxl.go.notifier.publish(vxl.events.READER_DONE,this)}vxlVTKReader.prototype.isSupported=function(){return(window.File&&window.FileReader&&window.FileList&&window.Blob)};vxlVTKReader.prototype.read=function(d){var b=this;
var c=d.name;if(c.length-4!==c.indexOf(".vtk")){throw"vxlVTKReader.read: the file "+d+" is not a VTK file"}var a=new FileReader();a.onload=function(g){document.body.style.cursor="default";var f=g.target.result.trim();var e=f.split(/\r\n|\r|\n/);b._parse(e);b._processIndexBlocks(c);vxl.go.notifier.fire(vxl.events.READER_DONE,b)};document.body.style.cursor="wait";a.readAsText(d)};vxlVTKReader.prototype._parse=function(a){this.outputfile="";this.numBlocks=0;this.location="NOWHERE";var d=0;for(var d=0;
d<a.length;d++){try{if(a[d].indexOf("POINTS")==0){console.log(a[d]);this.location=this.tags.POINTS;continue}else{if(a[d].indexOf("LINES")==0){console.log(a[d]);this.location=this.tags.LINES;this.mode="LINES";continue}else{if(a[d].indexOf("POLYGONS")==0){console.log(a[d]);this.location=this.tags.POLYGONS;continue}else{if(a[d].indexOf("POINT_DATA")==0){this.location=this.tags.POINT_DATA;continue}else{if(a[d].indexOf("NORMALS")==0){console.log(a[d]);this.location=this.tags.NORMALS;continue}else{if(a[d].indexOf("CELL_DATA")==0){console.log(a[d]);
this.location=this.tags.CELL_DATA;continue}else{if(a[d].indexOf("TEXTURE_COORDINATES")==0){console.log(a[d]);this.location=this.tags.TEXTURE_COORDINATES;continue}else{if(a[d].indexOf("SCALARS")==0){console.log(a[d]);this.location=this.tags.SCALARS;continue}else{if(a[d].indexOf("LOOKUP_TABLE")==0){console.log(a[d]);this.location=this.tags.LOOKUP_TABLE;continue}else{if(a[d].indexOf("COLOR_SCALARS")==0){console.log(a[d]);this.location=this.tags.COLOR_SCALARS;continue}else{if(this.location==this.tags.POINTS){var c=a[d].trim().split(" ");
if(c==""){continue}for(var e=0;e<c.length;e++){this.vertices.push(parseFloat(c[e]))}}else{if(this.location==this.tags.LINES){var f=a[d].trim().split(" ");if(f==""){continue}if(f.length>0&&f[0]=="2"){this.indices.push(parseInt(f[1]));this.indices.push(parseInt(f[2]))}}else{if(this.location==this.tags.POLYGONS){var f=a[d].trim().split(" ");if(f==""){continue}if(f.length>0&&f[0]!="3"){throw"Not triangles here"}for(var e=1;e<f.length;e++){this.indices.push(parseInt(f[e]))}}else{if(this.location==this.tags.LOOKUP_TABLE){if(a[d].indexOf("LOOKUP_TABLE")==0){continue
}else{var b=a[d].trim().split(" ");if(b==""){continue}for(var e=0;e<b.length;e++){this.scalars.push(parseFloat(b[e]))}}}else{if(this.location==this.tags.COLOR_SCALARS){var h=a[d].trim().split(" ");if(h==""){continue}for(var e=0;e<h.length;e++){this.colors.push(parseFloat(h[e]))}}else{if(this.location==this.tags.NORMALS){var h=a[d].trim().split(" ");if(h==""){continue}for(var e=0;e<h.length;e++){this.normals.push(parseFloat(h[e]))}}}}}}}}}}}}}}}}}}catch(g){console.log("Error while processing line "+d.toString());
throw g}}};vxlVTKReader.prototype._processIndexBlocks=function(b){this.numBlocks=0;var f=this.vertices.length/3;var c=this.normals.length/3;var e=this.indices.length;var a=e/3;var g=this.colors.length/3;var h=this.scalars.length;console.log("vertices:\t"+f.toString()+"\nnormals:\t"+c.toString()+"\nindices:\t"+e.toString()+"\ntriangles:\t"+a.toString()+"\nscalars:\t"+h.toString()+"\ncolors:\t"+g.toString()+"\n");this.numBlocks=parseInt(e/this.ARRAY_SIZE);if(e%this.ARRAY_SIZE!=0){this.numBlocks=this.numBlocks+1
}console.log("Number of Blocks: "+this.numBlocks.toString());for(var d=0;d<this.numBlocks;d++){this._processBlock(d,b)}};vxlVTKReader.prototype._processBlock=function(a,b){var e=(a+1).toString();var c="";if(this.numBlocks==1){c=b}else{c=b+"_"+e}var d=this._weaveBlock(a);this._writeJSON(c,d);console.log("Block ["+e+"] processed,  output: "+c)};vxlVTKReader.prototype._weaveBlock=function(k){var m=this.ARRAY_SIZE*k;var f=this.ARRAY_SIZE*(k+1);if(f>this.indices.length){f=this.indices.length}var b={};
var e={vertices:[],indices:[],scalars:[],colors:[]};var a=(this.scalars.length>0);var h=(this.colors.length>0);var d=this.indices.slice(m,f);taux=d.length;var c=-1;console.log("Weaving block #"+(k+1)+"  ["+m+","+f+"]");for(var g=0;g<taux;g+=1){var l=d[g];if(b[l]==undefined){c++;e.indices.push(c);b[l]=c;var j=l*3;e.vertices.push(this.vertices[j]);e.vertices.push(this.vertices[j+1]);e.vertices.push(this.vertices[j+2]);if(a){e.scalars.push(this.scalars[l])}if(h){e.colors.push(this.colors[j]);e.colors.push(this.colors[j+1]);
e.colors.push(this.colors[j+2])}}else{e.indices.push(b[l])}}delete d;return e};vxlVTKReader.prototype._writeJSON=function(c,b){var a=new Object();a.name=c;a.vertices=b.vertices.slice(0);a.indices=b.indices.slice(0);if(b.scalars.length>0){a.scalars=b.scalars.slice(0)}if(b.colors.length>0){a.colors=b.colors.slice(0)}a.mode=this.mode;this.parts.push(a)};vxlVTKReader.prototype.getParts=function(){return this.parts};function vxlTexture(b){var a=this;this.image=new Image();this.image.onload=function(){a._handleLoadedImage()};this.uri=b;if(this.uri!=undefined){this.load(this.uri)}this.mag=vxl.def.texture.filter.LINEAR;this.min=vxl.def.texture.filter.LINEAR_MIPMAP_LINEAR}vxlTexture.prototype.load=function(a){this.image.src=a};vxlTexture.prototype._handleLoadedImage=function(){};vxlTexture.prototype.getMagFilter=function(b){var a=vxl.def.texture.filter;switch(this.mag){case a.LINEAR:return b.LINEAR;break;case a.NEAREST:return b.NEAREST;
break;default:return b.NEAREST}};vxlTexture.prototype.getMinFilter=function(b){var a=vxl.def.texture.filter;switch(this.min){case a.LINEAR:return b.LINEAR;break;case a.NEAREST:return b.NEAREST;break;case a.LINEAR_MIPMAP_LINEAR:return b.LINEAR_MIPMAP_LINEAR;break;case a.LINEAR_MIPMAP_NEAREST:return b.LINEAR_MIPMAP_NEAREST;break;case a.NEAREST_MIPMAP_LINEAR:return b.NEAREST_MIPMAP_LINEAR;break;case a.NEAREST_MIPMAP_NEAREST:return b.NEAREST_MIPMAP_NEAREST;break;default:return b.NEAREST}};